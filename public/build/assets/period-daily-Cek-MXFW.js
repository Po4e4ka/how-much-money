import{u as W,r as a,j as e,H as q,L as G,a as R}from"./app-BFaXAPnN.js";import{A as X}from"./app-layout-DZMWa7-H.js";import{d as Y}from"./index-Df2C-eH2.js";import{c as Z,b as z,f as ee,g as te,d as ae}from"./date-ByBVlD4A.js";import{g as se,c as re,f as de,t as ie,a as T}from"./period-calculations-CUCDjb88.js";/* empty css            */import"./index-z7VGeFen.js";import"./index-8mPctj8f.js";import"./app-logo-icon-CuFaCK84.js";const ne={id:0,startDate:"",endDate:"",dailyExpenses:{},isClosed:!1};function ge(){const{periodId:n,viewerId:r,viewerName:A,viewerEmail:F,viewerMode:H}=W().props,v=!!(r??H),[t,k]=a.useState(ne),[l,c]=a.useState({}),[O,h]=a.useState(!0),[D,_]=a.useState(null),[f,j]=a.useState(!1),[N,$]=a.useState(null),[oe,S]=a.useState(!1),b=a.useRef(!1),g=a.useMemo(()=>`period:${r??"self"}:${n}`,[n,r]),x=a.useMemo(()=>r?`viewer_id=${r}`:"",[r]),m=a.useRef(!1),K=()=>typeof window>"u"?null:window.__periodCache?.[g]??null,C=s=>{if(typeof window>"u")return;const i=window;i.__periodCache||(i.__periodCache={}),i.__periodCache[g]={...i.__periodCache[g]??{},...s}},E=a.useMemo(()=>Z(t.startDate,t.endDate),[t.startDate,t.endDate]),y=a.useMemo(()=>!t.startDate||!t.endDate?"Период":`${z(t.startDate)} — ${z(t.endDate)}`,[t.startDate,t.endDate]),V=a.useMemo(()=>!t.startDate||!t.endDate?"":`${E} дней · ${ee(t.startDate,t.endDate)}`,[E,t.startDate,t.endDate]),M=a.useMemo(()=>!t.startDate||!t.endDate?[]:se(t.startDate,t.endDate),[t.startDate,t.endDate]),B=t.isClosed||v,L=r?`/shared/${r}/periods`:"/periods";r?`${r}`:Y().url,`${L}${n}`,`${L}${n}`;const J=async()=>{if(m.current)return;const s=K();if(s&&s.id){m.current=!0,k({...s,isClosed:!!s.isClosed}),c(s.dailyExpenses??{}),h(!1);return}m.current=!0,h(!0),_(null);try{const d=(await R(`/api/periods/${n}${x?`?${x}`:""}`)).data;k({id:d.id,startDate:d.start_date,endDate:d.end_date,dailyExpenses:d.daily_expenses??{},isClosed:!!d.is_closed}),c(d.daily_expenses??{}),C({id:d.id,startDate:d.start_date,endDate:d.end_date,dailyExpenses:d.daily_expenses??{},isClosed:!!d.is_closed})}catch(i){_(i instanceof Error?i.message:"Не удалось загрузить период.")}finally{h(!1)}},I=async()=>{if(!B){if(f){b.current=!0;return}j(!0),$(null),S(!1);try{await R(`/api/periods/${n}${x?`?${x}`:""}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({daily_expenses:l})}),S(!0),C({id:t.id,startDate:t.startDate,endDate:t.endDate,dailyExpenses:l,isClosed:t.isClosed})}catch(s){$(s instanceof Error?s.message:"Не удалось сохранить ежедневные траты.")}finally{j(!1)}}};return a.useEffect(()=>{m.current=!1,J()},[n,r]),a.useEffect(()=>{!f&&b.current&&(b.current=!1,I())},[f]),e.jsxs(X,{children:[e.jsx(q,{title:`Ежедневные траты · ${y}`}),e.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),e.jsxs("section",{className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Ежедневные траты"}),e.jsx("h1",{className:"mt-3 font-display text-3xl",children:y}),e.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:V})]}),e.jsx(G,{href:r?`/shared/${r}/periods/${n}`:`/periods/${n}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),v&&e.jsxs("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",e.jsx("span",{className:"font-semibold",children:A||F||`#${r}`}),". Режим только чтение."]}),e.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:ae(120),children:[O&&e.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),D&&e.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:D}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3 max-sm:snap-y max-sm:snap-mandatory max-sm:overflow-y-auto max-sm:max-h-[calc(100vh-190px)] max-sm:pb-8 max-sm:pr-1",children:M.map((s,i)=>{const d=i===M.length-1,{total:Q,average:U}=re(s,l);return e.jsx("div",{className:`rounded-2xl border border-black/10 bg-white/80 p-4 text-sm shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 max-sm:min-h-[calc(100vh-315px)] max-sm:snap-start max-sm:mb-2 max-sm:p-3 ${d?"max-sm:mb-24":""}`,children:e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"grid gap-3 max-sm:gap-2",children:s.map(P=>{const o=te(P);return e.jsxs("div",{className:"grid gap-2 max-sm:flex max-sm:items-center max-sm:justify-between",children:[e.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:de(P)}),e.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:l[o]??"",disabled:B,onChange:p=>c(u=>{const w={...u};return p.target.value===""?delete w[o]:w[o]=ie(p.target.value)||0,w}),onFocus:()=>{l[o]===0&&c(p=>{const u={...p};return delete u[o],u})},onBlur:I,className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10 max-sm:w-[70%] max-sm:px-2 max-sm:py-2 max-sm:text-xs"})]},o)})})}),e.jsxs("div",{className:"mt-auto flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-dashed border-black/10 bg-white/70 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/5 max-sm:grid max-sm:grid-cols-[1fr_auto] max-sm:items-center max-sm:gap-y-1 max-sm:px-2 max-sm:py-2",children:[e.jsx("span",{children:"Итого за неделю"}),e.jsx("span",{className:"font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:T(Q)}),e.jsx("span",{className:"text-[#6a5d52] dark:text-white/60",children:"Среднее в день"}),e.jsx("span",{className:"font-display text-sm tabular-nums",children:T(U)})]})]})},`${s[0]?.toISOString()??i}`)})})]}),N&&e.jsx("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:N})]})]})}export{ge as default};
