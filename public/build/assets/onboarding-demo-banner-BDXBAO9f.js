import{A as p,c as P,r as I,j as u}from"./app-BjXvd9MZ.js";import{d as T}from"./index-BNdu6nsP.js";const w="onboarding:periods:v1",y=[{id:1,start_date:"2025-12-01",end_date:"2025-12-31",is_pinned:!1,is_closed:!0,actual_remaining:12800,daily_expenses:{},unforeseen_allocated:0,incomes:[],expenses:[],external_expenses:[],unforeseen_expenses:[]},{id:2,start_date:"2025-11-01",end_date:"2025-11-30",is_pinned:!0,is_closed:!0,actual_remaining:6400,daily_expenses:{},unforeseen_allocated:0,incomes:[],expenses:[],external_expenses:[],unforeseen_expenses:[]},{id:3,start_date:"2025-10-01",end_date:"2025-10-31",is_pinned:!1,is_closed:!0,actual_remaining:9800,daily_expenses:{},unforeseen_allocated:0,incomes:[],expenses:[],external_expenses:[],unforeseen_expenses:[]}],m=t=>[...t].sort((e,s)=>{const n=new Date(e.start_date).getTime();return new Date(s.start_date).getTime()-n}),E=t=>{if(!Array.isArray(t))return m(y);if(t.every(n=>n&&typeof n=="object"&&"id"in n&&"start_date"in n&&"end_date"in n&&"daily_expenses"in n))return m(t);const s=t.map((n,d)=>({id:Number(n.id??d+1),start_date:String(n.start_date??""),end_date:String(n.end_date??""),is_pinned:!!n.is_pinned,is_closed:!!n.is_closed,actual_remaining:typeof n.actual_remaining=="number"?n.actual_remaining:null,daily_expenses:{},unforeseen_allocated:0,incomes:[],expenses:[],external_expenses:[],unforeseen_expenses:[]}));return m(s)},_=()=>{if(typeof window>"u")return m(y);const t=window.localStorage.getItem(w);if(!t){const e=m(y);return window.localStorage.setItem(w,JSON.stringify(e)),e}try{const e=JSON.parse(t),s=E(e);return window.localStorage.setItem(w,JSON.stringify(s)),s}catch{const e=m(y);return window.localStorage.setItem(w,JSON.stringify(e)),e}},b=t=>{typeof window>"u"||window.localStorage.setItem(w,JSON.stringify(m(t)))},D=()=>{typeof window>"u"||window.localStorage.removeItem(w)},R=t=>t.length?Math.max(...t.map(e=>e.id))+1:1,A=t=>{let e=0;for(const s of t){for(const n of s.incomes)e=Math.max(e,n.id);for(const n of s.expenses)e=Math.max(e,n.id);for(const n of s.external_expenses)e=Math.max(e,n.id);for(const n of s.unforeseen_expenses)e=Math.max(e,n.id)}return e+1},h=t=>new Date(`${t}T00:00:00`).getTime(),j=(t,e,s,n)=>{const d=h(e),o=h(s);return t.find(c=>{if(n&&c.id===n)return!1;const a=h(c.start_date),i=h(c.end_date);return d<i&&o>a})},C=(t,e)=>{const s=[],n=new Date(`${t}T00:00:00`),d=new Date(`${e}T00:00:00`);for(;n<=d;)s.push(n.toISOString().slice(0,10)),n.setDate(n.getDate()+1);return s},k=t=>C(t.start_date,t.end_date).every(e=>Object.prototype.hasOwnProperty.call(t.daily_expenses??{},e)),v=t=>{const e=Object.values(t.daily_expenses??{}).reduce((a,i)=>a+Number(i||0),0),s=t.incomes.reduce((a,i)=>a+Number(i.amount||0),0),n=t.expenses.reduce((a,i)=>a+Number(i.actual_amount||0),0),d=t.unforeseen_expenses.reduce((a,i)=>a+Number(i.actual_amount||0),0),o=Number(t.unforeseen_allocated||0),c=Math.max(0,d-o);return s-n-o-c-e},K=(t,e)=>{const s=_(),n=j(s,t,e);if(n)throw new p("Период пересекается с существующим.",409,{overlap:{id:n.id,start_date:n.start_date,end_date:n.end_date}});const d={id:R(s),start_date:t,end_date:e,is_pinned:!1,is_closed:!1,actual_remaining:null,daily_expenses:{},unforeseen_allocated:0,incomes:[],expenses:[],external_expenses:[],unforeseen_expenses:[]},o=m([...s,d]);return b(o),d},M=(t,e)=>{const s=_(),n=s.findIndex(l=>l.id===t);if(n<0)throw new p("Период не найден.",404,null);const o={...s[n]},c=Object.prototype.hasOwnProperty.call(e,"start_date"),a=Object.prototype.hasOwnProperty.call(e,"end_date");if(c||a){const l=String(e.start_date??o.start_date),r=String(e.end_date??o.end_date),x=!!e.force,g=j(s,l,r,o.id);if(g&&!x)throw new p("Период пересекается с существующим.",409,{overlap:{id:g.id,start_date:g.start_date,end_date:g.end_date}});o.start_date=l,o.end_date=r}Object.prototype.hasOwnProperty.call(e,"daily_expenses")&&(o.daily_expenses=e.daily_expenses??{}),Object.prototype.hasOwnProperty.call(e,"unforeseen_allocated")&&(o.unforeseen_allocated=Number(e.unforeseen_allocated??0));let i=A(s);const f=l=>{const r=Number(l);if(Number.isFinite(r)&&r>0)return r;const x=i;return i+=1,x};if(Object.prototype.hasOwnProperty.call(e,"incomes")){const l=e.incomes??[];o.incomes=l.map(r=>({id:f(r.id),name:String(r.name??""),amount:Number(r.amount??0)}))}if(Object.prototype.hasOwnProperty.call(e,"expenses")){const l=e.expenses??[];o.expenses=l.map(r=>({id:f(r.id),name:String(r.name??""),planned_amount:Number(r.planned_amount??0),actual_amount:Number(r.actual_amount??0)}))}if(Object.prototype.hasOwnProperty.call(e,"external_expenses")){const l=e.external_expenses??[];o.external_expenses=l.map(r=>({id:f(r.id),name:String(r.name??""),amount:Number(r.amount??0)}))}if(Object.prototype.hasOwnProperty.call(e,"unforeseen_expenses")){const l=e.unforeseen_expenses??[];o.unforeseen_expenses=l.map(r=>({id:f(r.id),name:String(r.name??""),planned_amount:Number(r.planned_amount??0),actual_amount:Number(r.actual_amount??0)}))}return o.actual_remaining=o.is_closed?v(o):null,s[n]=o,b(s),o},B=t=>{const e=_().find(s=>s.id===t);if(!e)throw new p("Период не найден.",404,null);return e},U=t=>{const s=_().filter(n=>n.id!==t);b(s)},Y=t=>{const e=B(t);if(!k(e))throw new p("Заполните ежедневные траты за все дни периода.",422,null);const s=M(t,{});s.is_closed=!0,s.actual_remaining=v(s);const n=_(),d=n.findIndex(o=>o.id===t);return n[d]=s,b(n),{is_closed:!0,actual_remaining:s.actual_remaining}},$=(t,e,s)=>{const n=_(),d=n.find(c=>c.id===t);if(!d)throw new p("Период не найден.",404,null);if(!e)return d.is_pinned=!1,b(n),{is_pinned:!1};const o=n.find(c=>c.is_pinned&&c.id!==t);if(o&&!s)throw new p("Уже есть закрепленный период.",409,{pinned:{id:o.id,start_date:o.start_date,end_date:o.end_date}});for(const c of n)c.is_pinned=c.id===t;return b(n),{is_pinned:!0}},L=(t,e)=>{const s=_();if(!s.find(a=>a.id===t))return{previous:[],all:[]};const d=a=>e==="income"?a.incomes.map(i=>i.name):e==="mandatory"?a.expenses.map(i=>i.name):e==="external"?a.external_expenses.map(i=>i.name):a.unforeseen_expenses.map(i=>i.name),o=[...s].sort((a,i)=>a.id-i.id),c=o.filter(a=>a.id<t).at(-1);return{previous:c?[...new Set(d(c))].sort():[],all:[...new Set(o.flatMap(a=>d(a)))].sort()}},O="onboarding:tour:completed",S="onboarding:tour:started",N="onboarding:period-guide:completed",H=()=>typeof window>"u"?!1:window.sessionStorage.getItem(O)==="1",q=()=>{typeof window>"u"||window.sessionStorage.setItem(O,"1")},Q=()=>typeof window>"u"?!1:window.sessionStorage.getItem(S)==="1",V=()=>{typeof window>"u"||window.sessionStorage.setItem(S,"1")},G=()=>{typeof window>"u"||(window.sessionStorage.removeItem(S),window.sessionStorage.removeItem(O),window.sessionStorage.removeItem(N))},W=()=>typeof window>"u"?!1:window.sessionStorage.getItem(N)==="1",X=()=>{typeof window>"u"||window.sessionStorage.setItem(N,"1")};function Z(t){const e=P.c(9),{restartHref:s}=t,n=s===void 0?"/onboarding":s,[d,o]=I.useState(!1);let c;e[0]!==n?(c=()=>{if(D(),G(),typeof window<"u"){const x=window;x.__periodCache&&delete x.__periodCache,window.location.href=n}},e[0]=n,e[1]=c):c=e[1];const a=c;let i;e[2]===Symbol.for("react.memo_cache_sentinel")?(i=u.jsx("p",{className:"line-clamp-2",children:"Демо-инструкция: в этом режиме вы проходите онбординг без API и работаете только с локальными данными браузера."}),e[2]=i):i=e[2];let f;e[3]===Symbol.for("react.memo_cache_sentinel")?(f=u.jsx("section",{className:"fixed inset-x-0 top-0 z-[120] border-b border-[#b9a6ff]/35 bg-[#1b1227]/92 shadow-[0_12px_28px_-18px_rgba(0,0,0,0.7)] backdrop-blur",children:u.jsxs("div",{className:"mx-auto flex min-h-14 w-full max-w-7xl items-center justify-between gap-3 px-4 py-2 text-sm text-white",children:[i,u.jsxs("div",{className:"flex items-center gap-2",children:[u.jsx("button",{type:"button",className:"rounded-lg border border-[#b9a6ff]/55 bg-[#2b1c3f]/75 px-3 py-1.5 text-xs font-semibold text-[#e4dcff] transition hover:bg-[#3a2856]",onClick:()=>o(!0),children:"Начать заново"}),u.jsx("button",{type:"button",className:"rounded-lg border border-[#b9a6ff]/45 bg-[#2b1c3f]/55 px-3 py-1.5 text-xs font-semibold text-[#e4dcff] transition hover:bg-[#3a2856]",onClick:F,children:"Завершить"})]})]})}),e[3]=f):f=e[3];let l;e[4]!==a||e[5]!==d?(l=d&&u.jsx("div",{className:"fixed inset-0 z-[130] flex items-center justify-center bg-black/58 p-6",children:u.jsxs("div",{className:"w-full max-w-lg rounded-2xl border border-[#b9a6ff]/45 bg-[#1b1227]/96 p-6 text-white shadow-[0_30px_70px_-35px_rgba(0,0,0,0.9)]",children:[u.jsx("h3",{className:"font-display text-2xl",children:"Начать онбординг заново?"}),u.jsx("p",{className:"mt-3 text-sm text-white/80",children:"Все данные текущего демо будут удалены: созданные периоды, прогресс шагов и локальные изменения."}),u.jsxs("div",{className:"mt-6 flex items-center justify-end gap-3",children:[u.jsx("button",{type:"button",className:"rounded-lg border border-white/25 px-4 py-2 text-sm text-white/90 transition hover:bg-white/10",onClick:()=>o(!1),children:"Отмена"}),u.jsx("button",{type:"button",className:"rounded-lg bg-[#7b67c5] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[#8e79d8]",onClick:a,children:"Да, начать заново"})]})]})}),e[4]=a,e[5]=d,e[6]=l):l=e[6];let r;return e[7]!==l?(r=u.jsxs(u.Fragment,{children:[f,l]}),e[7]=l,e[8]=r):r=e[8],r}function F(){typeof window<"u"&&(window.location.href=T().url)}export{Z as O,H as a,q as b,K as c,W as d,X as e,Y as f,B as g,U as h,Q as i,_ as l,V as m,L as o,$ as p,M as u};
