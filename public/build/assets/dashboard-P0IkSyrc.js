import{c as I,j as t,L as Y,u as Z,r as h,H as ee}from"./app-Co2WJCTd.js";import{A as te}from"./app-layout-BWJR1pMz.js";import{d as se}from"./index-D48w0u2P.js";import{O as ae}from"./overlap-period-modal-CaPMVF-x.js";import{P as W}from"./pill-button-BF9KXfli.js";import{S as re}from"./session-expired-modal-C2-bvFmK.js";import{d as U}from"./animation-DULAtfne.js";import{a as z,i as k,c as V,f as q,b as C,d as E}from"./date-C0FYGyP5.js";/* empty css            */import"./app-logo-icon-BIJslR1r.js";import"./index-ap9OcSvD.js";import"./index-DPEoTood.js";const ie=i=>{const e=Math.round(i);return e===0?"0 ₽":`${e>0?"+":"−"}${Math.abs(e).toLocaleString("ru-RU")} ₽`},ne=i=>{const e=I.c(21),{href:a,title:n,subtitle:d,isClosed:l,actualRemaining:s}=i,c=l===void 0?!1:l,m=`rounded-[28px] border bg-white/70 p-5 text-left shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:bg-white/10 ${c?"border-[#1e7b4f]/40 dark:border-[#7ce0b3]/40":"border-black/10 dark:border-white/10"}`;let w;e[0]!==n?(w=t.jsx("h3",{className:"font-display text-xl",children:n}),e[0]=n,e[1]=w):w=e[1];let f;e[2]!==d?(f=t.jsx("p",{className:"mt-1 text-xs text-[#6a5d52] dark:text-white/70",children:d}),e[2]=d,e[3]=f):f=e[3];let g;e[4]!==s||e[5]!==c?(g=c&&typeof s=="number"&&t.jsxs("p",{className:"mt-2 text-xs text-[#1e7b4f] dark:text-[#7ce0b3]",children:["Факт. остаток: ",ie(s)]}),e[4]=s,e[5]=c,e[6]=g):g=e[6];let _;e[7]!==w||e[8]!==f||e[9]!==g?(_=t.jsxs("div",{className:"min-w-[180px]",children:[w,f,g]}),e[7]=w,e[8]=f,e[9]=g,e[10]=_):_=e[10];let b;e[11]!==c?(b=c&&t.jsx("div",{className:"flex-1 text-center text-xs uppercase tracking-[0.2em] text-[#1e7b4f] dark:text-[#7ce0b3]",children:"Период закрыт"}),e[11]=c,e[12]=b):b=e[12];let x;e[13]===Symbol.for("react.memo_cache_sentinel")?(x=t.jsx(W,{as:"span",className:"bg-white/80 text-[#1c1a17] dark:bg-white/10 dark:text-white",children:"Открыть период"}),e[13]=x):x=e[13];let u;e[14]!==_||e[15]!==b?(u=t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[_,b,x]}),e[14]=_,e[15]=b,e[16]=u):u=e[16];let j;return e[17]!==a||e[18]!==m||e[19]!==u?(j=t.jsx(Y,{href:a,prefetch:!0,className:m,children:u}),e[17]=a,e[18]=m,e[19]=u,e[20]=j):j=e[20],j},H=i=>{const e=I.c(7),{items:a,baseHref:n}=i;let d;if(e[0]!==n||e[1]!==a){let s;e[3]!==n?(s=c=>t.jsx(ne,{href:`${n??"/periods"}/${c.id}`,title:c.title,subtitle:c.subtitle,isClosed:c.isClosed,actualRemaining:c.actualRemaining},c.id),e[3]=n,e[4]=s):s=e[4],d=a.map(s),e[0]=n,e[1]=a,e[2]=d}else d=e[2];let l;return e[5]!==d?(l=t.jsx("div",{className:"grid gap-4",children:d}),e[5]=d,e[6]=l):l=e[6],l},le=`
## Приложение обновилось!
___
## Что нового?

- дабавлена фича закрытия периода
- максимальный диапозон не больше 3-х меяцев
- бновлены иконки

___
version: 0.1.3
`,de="Круто!",y=i=>i.split("**").map((a,n)=>n%2===1?t.jsx("strong",{children:a},n):a),oe=i=>{const e=i.trim().split(`
`),a=[];let n=[];const d=()=>{n.length&&(a.push(t.jsx("ul",{className:"list-disc pl-5",children:n.map((l,s)=>t.jsx("li",{children:y(l)},s))},`list-${a.length}`)),n=[])};return e.forEach(l=>{const s=l.trim();if(!s){d();return}if(s.startsWith("- ")){n.push(s.slice(2));return}if(d(),s.startsWith("### ")){a.push(t.jsx("h4",{className:"text-lg font-semibold",children:y(s.slice(4))},`h4-${a.length}`));return}if(s.startsWith("## ")){a.push(t.jsx("h3",{className:"text-xl font-semibold",children:y(s.slice(3))},`h3-${a.length}`));return}if(s.startsWith("# ")){a.push(t.jsx("h2",{className:"text-2xl font-semibold",children:y(s.slice(2))},`h2-${a.length}`));return}a.push(t.jsx("p",{className:"text-sm text-[#6a5d52] dark:text-white/70",children:y(s)},`p-${a.length}`))}),d(),a},ce=i=>{const e=I.c(4),{onConfirm:a,confirmDisabled:n}=i,d=n===void 0?!1:n;let l;e[0]===Symbol.for("react.memo_cache_sentinel")?(l=t.jsx("div",{className:"space-y-4",children:oe(le)}),e[0]=l):l=e[0];let s;return e[1]!==d||e[2]!==a?(s=t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6",children:t.jsxs("div",{className:"w-full max-w-xl rounded-3xl border border-black/10 bg-white/95 p-6 text-[#1c1a17] shadow-[0_24px_60px_-28px_rgba(0,0,0,0.7)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white",children:[l,t.jsx("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:t.jsx(W,{type:"button",onClick:a,className:"border-transparent bg-[#d87a4a] px-4 py-2 text-xs font-semibold text-white shadow-[0_14px_28px_-18px_rgba(216,122,74,0.8)] disabled:cursor-not-allowed disabled:opacity-70",disabled:d,children:de})})]})}),e[1]=d,e[2]=a,e[3]=s):s=e[3],s},xe=[{title:"Dashboard",href:se().url}],K=i=>{const e=k(i.start_date)&&k(i.end_date),a=e?V(i.start_date,i.end_date):0;return{title:e?`${C(i.start_date)} — ${C(i.end_date)}`:"Период",subtitle:e?`${a} дней · ${q(i.start_date,i.end_date)}`:"Даты не заданы"}};function Ne(){const{auth:i,viewerId:e,viewerName:a,viewerEmail:n,viewerMode:d}=Z().props,l=!!(e??d),[s,c]=h.useState(""),[m,w]=h.useState(""),[f,g]=h.useState(!1),[_,b]=h.useState(null),[x,u]=h.useState(null),[j,S]=h.useState(!1),[v,X]=h.useState([]),[D,M]=h.useState(!0),[$,R]=h.useState(null),[J,L]=h.useState(i.user?.is_info_shown===!1),[G,P]=h.useState(!1);h.useEffect(()=>{L(i.user?.is_info_shown===!1)},[i.user]);const Q=()=>{L(!1);const r=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"";fetch("/api/user/info-shown",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":r}}).then(o=>{o.status===419&&P(!0)}).catch(o=>{console.error(o)})},O=async()=>{M(!0),R(null);try{const r=e?`?viewer_id=${e}`:"",o=await fetch(`/api/periods${r}`);if(!o.ok)throw new Error("Не удалось загрузить периоды.");const p=await o.json();X(p.data??[])}catch(r){R(r instanceof Error?r.message:"Не удалось загрузить периоды.")}finally{M(!1)}};h.useEffect(()=>{O()},[]);const F=async(r=!1)=>{if(!l){if(!s||!m){b("Укажите даты начала и конца периода.");return}if(!r){const o=E(s),p=E(m),N=v.find(T=>{const A=E(T.start_date),B=E(T.end_date);return!Number.isFinite(o)||!Number.isFinite(p)||!Number.isFinite(A)||!Number.isFinite(B)?!1:o<B&&p>A});if(N){u(N),S(!0);return}}g(!0),b(null);try{const o=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",p=await fetch("/api/periods",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({start_date:s,end_date:m,force:!!r})});if(p.status===419){P(!0);return}if(p.status===409){const N=await p.json();if(N.overlap){u(N.overlap),S(!0);return}throw new Error("Период пересекается с существующим.")}if(!p.ok)throw new Error("Не удалось сохранить период.");c(""),w(""),u(null),S(!1),await O()}catch(o){b(o instanceof Error?o.message:"Не удалось сохранить период.")}finally{g(!1)}}};return t.jsxs(te,{breadcrumbs:xe,children:[t.jsx(ee,{title:"Dashboard"}),t.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsx("section",{className:"relative z-10 flex flex-wrap items-end justify-between gap-6",children:t.jsxs("div",{children:[t.jsx("h1",{className:"mt-3 font-display text-3xl",children:"Периоды учета"}),t.jsx("p",{className:"mt-2 max-w-xl text-sm text-[#6a5d52] dark:text-white/70",children:l?"Режим просмотра. Создание и редактирование недоступны.":"Добавьте новый период сверху и управляйте историей ниже. При клике откроется отдельная страница периода."})]})}),l&&t.jsxs("div",{className:"relative z-10 rounded-[24px] border border-black/10 bg-white/70 px-5 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",t.jsx("span",{className:"font-semibold",children:a||n||`#${e}`}),"."]}),!l&&t.jsxs("section",{className:"relative z-10 rounded-[28px] border border-black/10 bg-white/85 p-6 shadow-[0_22px_44px_-28px_rgba(28,26,23,0.6)] backdrop-blur animate-reveal dark:border-white/10 dark:bg-white/10",style:U(120),children:[t.jsx("div",{className:"flex flex-wrap items-center justify-between gap-4",children:t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Новый период"}),t.jsx("h2",{className:"mt-2 font-display text-2xl",children:"Добавить диапазон дат"})]})}),t.jsxs("div",{className:"mt-6 grid gap-4 sm:grid-cols-[1fr_1fr_1fr]",children:[t.jsxs("label",{className:"grid cursor-pointer grid-cols-[32px_minmax(0,1fr)] items-center gap-3 text-xs text-[#6a5d52] dark:text-white/70",children:[t.jsx("span",{children:"С"}),t.jsx("input",{type:"date",value:s,onChange:r=>c(r.target.value),min:m?z(m,-3):void 0,max:m||void 0,className:"date-input ml-auto w-[80%] rounded-lg border border-black/10 bg-white/90 px-4 py-3 text-sm text-[#1c1a17] outline-none transition focus:border-black/30 dark:border-white/10 dark:bg-white/10 dark:text-white sm:ml-0 sm:w-full"})]}),t.jsxs("label",{className:"grid cursor-pointer grid-cols-[32px_minmax(0,1fr)] items-center gap-3 text-xs text-[#6a5d52] dark:text-white/70",children:[t.jsx("span",{children:"По"}),t.jsx("input",{type:"date",value:m,onChange:r=>w(r.target.value),min:s||void 0,max:s?z(s,3):void 0,className:"date-input ml-auto w-[80%] rounded-lg border border-black/10 bg-white/90 px-4 py-3 text-sm text-[#1c1a17] outline-none transition focus:border-black/30 dark:border-white/10 dark:bg-white/10 dark:text-white sm:ml-0 sm:w-full"})]}),t.jsx("div",{className:"flex flex-col justify-end",children:t.jsx("button",{className:"rounded-2xl bg-[#d87a4a] px-4 py-3 text-sm font-semibold text-white shadow-[0_14px_28px_-18px_rgba(216,122,74,0.8)] transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-70",type:"button",onClick:()=>F(!1),disabled:f,children:f?"Сохранение...":"Сохранить"})})]}),_&&t.jsx("p",{className:"mt-3 text-xs text-[#b0352b] dark:text-[#ff8b7c]",children:_})]}),t.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:U(240),children:[v.some(r=>r.is_pinned)&&t.jsxs("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Закреплённый период"}),t.jsx("div",{className:"mt-4",children:(()=>{const r=v.find(p=>p.is_pinned);if(!r)return null;const o=K(r);return t.jsx(H,{items:[{id:r.id,title:o.title,subtitle:o.subtitle,isClosed:!!r.is_closed,actualRemaining:r.actual_remaining??null}],baseHref:e?`/shared/${e}/periods`:void 0})})()})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"font-display text-2xl",children:"История периодов"}),t.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:"Сначала новые"})]}),t.jsxs("div",{className:"grid gap-4",children:[D&&t.jsx("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем периоды..."}),$&&t.jsx("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:$}),!D&&!$&&v.length===0&&t.jsx("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Периодов пока нет. Создайте первый диапазон выше."}),!D&&!$&&t.jsx(H,{items:v.map(r=>{const o=K(r);return{id:r.id,title:o.title,subtitle:o.subtitle,isClosed:!!r.is_closed,actualRemaining:r.actual_remaining??null}}),baseHref:e?`/shared/${e}/periods`:void 0})]})]}),!l&&x&&t.jsx(ae,{href:`/periods/${x.id}`,title:k(x.start_date)&&k(x.end_date)?`${C(x.start_date)} — ${C(x.end_date)}`:"Период",subtitle:k(x.start_date)&&k(x.end_date)?`${V(x.start_date,x.end_date)} дней · ${q(x.start_date,x.end_date)}`:"Даты не заданы",onClose:()=>{u(null),S(!1)},onConfirm:()=>F(!0),confirmDisabled:!j||f}),J&&t.jsx(ce,{onConfirm:Q}),G&&t.jsx(re,{onClose:()=>P(!1),onReload:()=>window.location.reload()})]})]})}export{Ne as default};
