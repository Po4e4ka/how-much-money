import{u as we,r as o,j as t,H as je,L as ce,c as ie}from"./app-C_NetdBz.js";import{A as Ne}from"./app-layout-DkboATc_.js";import{d as xe}from"./index-BDqSilVs.js";/* empty css            */import"./app-logo-icon-DSv30D1z.js";import"./index-K9CSVcOd.js";import"./index-Br8gnOXR.js";const ye=n=>({"--delay":`${n}ms`}),ve={id:0,startDate:"",endDate:"",incomes:[],expenses:[],offIncomeExpenses:[],dailyExpenses:{}},Q=n=>`${Math.max(0,Math.round(n)).toLocaleString("ru-RU")} ₽`,ne=n=>{const e=Math.round(n);return e===0?"0 ₽":`${e>0?"+":"−"}${Math.abs(e).toLocaleString("ru-RU")} ₽`},te=n=>{const[e,m,d]=n.split("-").map(Number);return new Date(e,(m??1)-1,d??1)},me=n=>{const e=te(n),m=String(e.getDate()).padStart(2,"0"),d=String(e.getMonth()+1).padStart(2,"0");return`${m}.${d}`},_e=n=>new Intl.DateTimeFormat("ru-RU",{month:"long",year:"numeric"}).format(te(n)),Ae=(n,e)=>{const m=new Intl.DateTimeFormat("ru-RU",{month:"short"}),d=m.format(te(n)),s=m.format(te(e)),a=te(n).getFullYear(),N=te(e).getFullYear();return a===N?d===s?_e(n):`${d}–${s} ${a}`:`${d} ${a} – ${s} ${N}`},$e=(n,e)=>{const m=te(n),s=te(e).getTime()-m.getTime(),a=Math.floor(s/(1e3*60*60*24));return Math.max(1,a+1)},de=n=>{const e=n.replace(/\D/g,"");return e===""?"":Number(e)},ue=n=>n.filter(e=>e.name.trim()==="").map(e=>e.id),Se=n=>{const e=ie.c(24),{items:m,setItems:d,totalAmount:s,onAdd:a,onBlurField:N,invalidNameIds:i}=n;let M;e[0]===Symbol.for("react.memo_cache_sentinel")?(M=t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:"Приход"}),e[0]=M):M=e[0];let _;e[1]!==a?(_=t.jsxs("div",{className:"flex items-center justify-between",children:[M,t.jsx("button",{type:"button",onClick:a,className:"rounded-full border border-black/10 px-3 py-1 text-xs text-[#6a5d52] dark:border-white/10 dark:text-white/70",children:"+ Строка"})]}),e[1]=a,e[2]=_):_=e[2];let y;e[3]===Symbol.for("react.memo_cache_sentinel")?(y=t.jsxs("div",{className:"mt-3 hidden grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)] items-center gap-3 text-[11px] uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60 sm:grid",children:[t.jsx("span",{children:"Название"}),t.jsx("span",{className:"text-right",children:"Сумма"})]}),e[3]=y):y=e[3];let v;if(e[4]!==i||e[5]!==m||e[6]!==N||e[7]!==d){let j;e[9]!==i||e[10]!==N||e[11]!==d?(j=(h,L)=>t.jsxs("div",{className:"grid items-center gap-3 sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)]",children:[t.jsx("input",{type:"text",placeholder:`Приход ${L+1}`,value:h.name,onChange:$=>d(c=>c.map(S=>S.id===h.id?{...S,name:$.target.value}:S)),onBlur:N,className:`rounded-2xl border bg-white/90 px-4 py-2 text-sm dark:bg-white/10 ${i.includes(h.id)?"border-[#b0352b] dark:border-[#ff8b7c]":"border-black/10 dark:border-white/10"}`}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:h.amount,onChange:$=>{const c=$.target.value;d(S=>S.map(D=>D.id===h.id?{...D,amount:de(c)}:D))},onFocus:()=>{h.amount===0&&d($=>$.map(c=>c.id===h.id?{...c,amount:""}:c))},onBlur:()=>{h.amount===""&&d($=>$.map(c=>c.id===h.id?{...c,amount:0}:c)),N()},className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-4 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10"})]},h.id),e[9]=i,e[10]=N,e[11]=d,e[12]=j):j=e[12],v=m.map(j),e[4]=i,e[5]=m,e[6]=N,e[7]=d,e[8]=v}else v=e[8];let x;e[13]!==v?(x=t.jsx("div",{className:"mt-3 grid gap-2",children:v}),e[13]=v,e[14]=x):x=e[14];let w;e[15]===Symbol.for("react.memo_cache_sentinel")?(w=t.jsx("span",{children:"Итого прихода"}),e[15]=w):w=e[15];let A;e[16]!==s?(A=Q(s),e[16]=s,e[17]=A):A=e[17];let f;e[18]!==A?(f=t.jsxs("div",{className:"mt-3 grid items-center gap-3 rounded-2xl border border-dashed border-black/10 bg-white/70 px-4 py-2 text-xs dark:border-white/10 dark:bg-white/5 sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)]",children:[w,t.jsx("span",{className:"text-right font-display text-sm tabular-nums",children:A})]}),e[18]=A,e[19]=f):f=e[19];let E;return e[20]!==_||e[21]!==x||e[22]!==f?(E=t.jsxs("div",{className:"rounded-2xl border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[_,y,x,f]}),e[20]=_,e[21]=x,e[22]=f,e[23]=E):E=e[23],E},De=n=>{const e=ie.c(65),{title:m,items:d,setItems:s,showDelete:a,onToggleDelete:N,totalLabel:i,totalPlanned:M,totalActual:_,totalDifference:y,idPrefix:v,onBlurField:x,onAfterDelete:w}=n;let A;e[0]!==m?(A=t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:m}),e[0]=m,e[1]=A):A=e[1];let f;e[2]!==v||e[3]!==s?(f=t.jsx("button",{type:"button",onClick:()=>s(q=>[...q,{id:`${v}${Date.now()}`,name:"",plannedAmount:"",actualAmount:"",actualTouched:!1}]),className:"rounded-full border border-black/10 px-3 py-1 text-xs text-[#6a5d52] dark:border-white/10 dark:text-white/70",children:"+ Строка"}),e[2]=v,e[3]=s,e[4]=f):f=e[4];const E=`rounded-full border px-3 py-1 text-xs transition ${a?"border-[#b0352b]/40 text-[#b0352b] dark:border-[#ff8b7c]/40 dark:text-[#ff8b7c]":"border-black/10 text-[#6a5d52] dark:border-white/10 dark:text-white/70"}`;let j;e[5]!==N||e[6]!==E?(j=t.jsx("button",{type:"button",onClick:N,className:E,children:"− Удаление"}),e[5]=N,e[6]=E,e[7]=j):j=e[7];let h;e[8]!==f||e[9]!==j?(h=t.jsxs("div",{className:"flex items-center gap-2",children:[f,j]}),e[8]=f,e[9]=j,e[10]=h):h=e[10];let L;e[11]!==A||e[12]!==h?(L=t.jsxs("div",{className:"flex items-center justify-between",children:[A,h]}),e[11]=A,e[12]=h,e[13]=L):L=e[13];const $=`mt-3 hidden items-center gap-3 text-[11px] uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60 sm:grid ${a?"grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)]"}`;let c,S,D,U;e[14]===Symbol.for("react.memo_cache_sentinel")?(D=t.jsx("span",{children:"Название"}),U=t.jsx("span",{className:"text-right",children:"План"}),c=t.jsx("span",{className:"text-right",children:"Факт"}),S=t.jsx("span",{className:"text-right",children:"Разница"}),e[14]=c,e[15]=S,e[16]=D,e[17]=U):(c=e[14],S=e[15],D=e[16],U=e[17]);let R;e[18]!==a?(R=a&&t.jsx("span",{className:"text-center",children:"—"}),e[18]=a,e[19]=R):R=e[19];let C;e[20]!==R||e[21]!==$?(C=t.jsxs("div",{className:$,children:[D,U,c,S,R]}),e[20]=R,e[21]=$,e[22]=C):C=e[22];let V;if(e[23]!==d||e[24]!==w||e[25]!==x||e[26]!==s||e[27]!==a){let q;e[29]!==w||e[30]!==x||e[31]!==s||e[32]!==a?(q=(b,re)=>t.jsxs("div",{className:`grid items-center gap-3 ${a?"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_auto]":"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)]"}`,children:[t.jsx("input",{type:"text",placeholder:`Трата ${re+1}`,value:b.name,onChange:g=>s(l=>l.map(W=>W.id===b.id?{...W,name:g.target.value}:W)),onBlur:x,className:"rounded-2xl border border-black/10 bg-white/90 px-4 py-2 text-sm dark:border-white/10 dark:bg-white/10"}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:b.plannedAmount,onChange:g=>{const l=g.target.value;s(W=>W.map(H=>H.id===b.id?{...H,plannedAmount:de(l),actualAmount:H.actualTouched?H.actualAmount:de(l)}:H))},onFocus:()=>{b.plannedAmount===0&&s(g=>g.map(l=>l.id===b.id?{...l,plannedAmount:""}:l))},onBlur:()=>{b.plannedAmount===""&&s(g=>g.map(l=>l.id===b.id?{...l,plannedAmount:0}:l)),x()},className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-4 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10"}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:b.actualAmount,onChange:g=>{const l=g.target.value;s(W=>W.map(H=>H.id===b.id?{...H,actualAmount:de(l),actualTouched:!0}:H))},onFocus:()=>{b.actualAmount===0&&s(g=>g.map(l=>l.id===b.id?{...l,actualAmount:""}:l))},onBlur:()=>{b.actualAmount===""&&s(g=>g.map(l=>l.id===b.id?{...l,actualAmount:0}:l)),x()},className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-4 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10"}),t.jsx("div",{className:`flex min-h-[40px] items-center justify-end px-4 py-2 text-sm tabular-nums ${b.plannedAmount-b.actualAmount>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":b.plannedAmount-b.actualAmount<0?"text-[#b0352b] dark:text-[#ff8b7c]":"text-[#6a5d52] dark:text-white/70"}`,children:ne(b.plannedAmount-b.actualAmount)}),a&&t.jsx("button",{type:"button",onClick:()=>{window.confirm("Удалить строку?")&&(s(g=>g.filter(l=>l.id!==b.id)),w())},"aria-label":`Удалить трату ${re+1}`,className:"flex h-8 w-8 items-center justify-center rounded-full text-xs text-[#b0352b] transition hover:bg-[#b0352b]/10 dark:text-[#ff8b7c] dark:hover:bg-[#ff8b7c]/15",children:"—"})]},b.id),e[29]=w,e[30]=x,e[31]=s,e[32]=a,e[33]=q):q=e[33],V=d.map(q),e[23]=d,e[24]=w,e[25]=x,e[26]=s,e[27]=a,e[28]=V}else V=e[28];let F;e[34]!==V?(F=t.jsx("div",{className:"mt-3 grid gap-2",children:V}),e[34]=V,e[35]=F):F=e[35];const K=`mt-3 grid items-center gap-3 rounded-2xl border border-dashed border-black/10 bg-white/70 px-4 py-2 text-xs dark:border-white/10 dark:bg-white/5 ${a?"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_auto]":"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)]"}`;let B;e[36]!==i?(B=t.jsx("span",{children:i}),e[36]=i,e[37]=B):B=e[37];let O;e[38]!==M?(O=Q(M),e[38]=M,e[39]=O):O=e[39];let T;e[40]!==O?(T=t.jsx("span",{className:"text-right font-display text-sm tabular-nums",children:O}),e[40]=O,e[41]=T):T=e[41];let I;e[42]!==_?(I=Q(_),e[42]=_,e[43]=I):I=e[43];let J;e[44]!==I?(J=t.jsx("span",{className:"text-right font-display text-sm tabular-nums",children:I}),e[44]=I,e[45]=J):J=e[45];const P=`text-right font-display text-sm tabular-nums ${y>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":y<0?"text-[#b0352b] dark:text-[#ff8b7c]":"text-[#6a5d52] dark:text-white/70"}`;let u;e[46]!==y?(u=ne(y),e[46]=y,e[47]=u):u=e[47];let Y;e[48]!==P||e[49]!==u?(Y=t.jsx("span",{className:P,children:u}),e[48]=P,e[49]=u,e[50]=Y):Y=e[50];let z;e[51]!==a?(z=a&&t.jsx("span",{}),e[51]=a,e[52]=z):z=e[52];let G;e[53]!==K||e[54]!==B||e[55]!==T||e[56]!==J||e[57]!==Y||e[58]!==z?(G=t.jsxs("div",{className:K,children:[B,T,J,Y,z]}),e[53]=K,e[54]=B,e[55]=T,e[56]=J,e[57]=Y,e[58]=z,e[59]=G):G=e[59];let ae;return e[60]!==C||e[61]!==F||e[62]!==G||e[63]!==L?(ae=t.jsxs("div",{className:"rounded-2xl border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[L,C,F,G]}),e[60]=C,e[61]=F,e[62]=G,e[63]=L,e[64]=ae):ae=e[64],ae},Ie=n=>{const e=ie.c(52),{title:m,items:d,setItems:s,showDelete:a,onToggleDelete:N,totalLabel:i,totalAmount:M,idPrefix:_,onBlurField:y,onAfterDelete:v}=n;let x;e[0]!==m?(x=t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:m}),e[0]=m,e[1]=x):x=e[1];let w;e[2]!==_||e[3]!==s?(w=t.jsx("button",{type:"button",onClick:()=>s(T=>[...T,{id:`${_}${Date.now()}`,name:"",amount:""}]),className:"rounded-full border border-black/10 px-3 py-1 text-xs text-[#6a5d52] dark:border-white/10 dark:text-white/70",children:"+ Строка"}),e[2]=_,e[3]=s,e[4]=w):w=e[4];const A=`rounded-full border px-3 py-1 text-xs transition ${a?"border-[#b0352b]/40 text-[#b0352b] dark:border-[#ff8b7c]/40 dark:text-[#ff8b7c]":"border-black/10 text-[#6a5d52] dark:border-white/10 dark:text-white/70"}`;let f;e[5]!==N||e[6]!==A?(f=t.jsx("button",{type:"button",onClick:N,className:A,children:"− Удаление"}),e[5]=N,e[6]=A,e[7]=f):f=e[7];let E;e[8]!==w||e[9]!==f?(E=t.jsxs("div",{className:"flex items-center gap-2",children:[w,f]}),e[8]=w,e[9]=f,e[10]=E):E=e[10];let j;e[11]!==x||e[12]!==E?(j=t.jsxs("div",{className:"flex items-center justify-between",children:[x,E]}),e[11]=x,e[12]=E,e[13]=j):j=e[13];const h=`mt-3 hidden items-center gap-3 text-[11px] uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60 sm:grid ${a?"grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)]"}`;let L,$;e[14]===Symbol.for("react.memo_cache_sentinel")?(L=t.jsx("span",{children:"Название"}),$=t.jsx("span",{className:"text-right",children:"Сумма"}),e[14]=L,e[15]=$):(L=e[14],$=e[15]);let c;e[16]!==a?(c=a&&t.jsx("span",{className:"text-center",children:"—"}),e[16]=a,e[17]=c):c=e[17];let S;e[18]!==c||e[19]!==h?(S=t.jsxs("div",{className:h,children:[L,$,c]}),e[18]=c,e[19]=h,e[20]=S):S=e[20];let D;if(e[21]!==d||e[22]!==v||e[23]!==y||e[24]!==s||e[25]!==a){let T;e[27]!==v||e[28]!==y||e[29]!==s||e[30]!==a?(T=(I,J)=>t.jsxs("div",{className:`grid items-center gap-3 ${a?"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_auto]":"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)]"}`,children:[t.jsx("input",{type:"text",placeholder:`Трата ${J+1}`,value:I.name,onChange:P=>s(u=>u.map(Y=>Y.id===I.id?{...Y,name:P.target.value}:Y)),onBlur:y,className:"rounded-2xl border border-black/10 bg-white/90 px-4 py-2 text-sm dark:border-white/10 dark:bg-white/10"}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:I.amount,onChange:P=>{const u=P.target.value;s(Y=>Y.map(z=>z.id===I.id?{...z,amount:de(u)}:z))},onFocus:()=>{I.amount===0&&s(P=>P.map(u=>u.id===I.id?{...u,amount:""}:u))},onBlur:()=>{I.amount===""&&s(P=>P.map(u=>u.id===I.id?{...u,amount:0}:u)),y()},className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-4 py-2 text-sm text-right tabular-nums text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]"}),a&&t.jsx("button",{type:"button",onClick:()=>{window.confirm("Удалить строку?")&&(s(P=>P.filter(u=>u.id!==I.id)),v())},"aria-label":`Удалить трату ${J+1}`,className:"flex h-8 w-8 items-center justify-center rounded-full text-xs text-[#b0352b] transition hover:bg-[#b0352b]/10 dark:text-[#ff8b7c] dark:hover:bg-[#ff8b7c]/15",children:"—"})]},I.id),e[27]=v,e[28]=y,e[29]=s,e[30]=a,e[31]=T):T=e[31],D=d.map(T),e[21]=d,e[22]=v,e[23]=y,e[24]=s,e[25]=a,e[26]=D}else D=e[26];let U;e[32]!==D?(U=t.jsx("div",{className:"mt-3 grid gap-2",children:D}),e[32]=D,e[33]=U):U=e[33];const R=`mt-3 grid items-center gap-3 rounded-2xl border border-dashed border-black/10 bg-white/70 px-4 py-2 text-xs dark:border-white/10 dark:bg-white/5 ${a?"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)_auto]":"sm:grid-cols-[minmax(0,1.6fr)_minmax(0,0.7fr)]"}`;let C;e[34]!==i?(C=t.jsx("span",{children:i}),e[34]=i,e[35]=C):C=e[35];let V;e[36]!==M?(V=Q(M),e[36]=M,e[37]=V):V=e[37];let F;e[38]!==V?(F=t.jsx("span",{className:"text-right font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:V}),e[38]=V,e[39]=F):F=e[39];let K;e[40]!==a?(K=a&&t.jsx("span",{}),e[40]=a,e[41]=K):K=e[41];let B;e[42]!==R||e[43]!==C||e[44]!==F||e[45]!==K?(B=t.jsxs("div",{className:R,children:[C,F,K]}),e[42]=R,e[43]=C,e[44]=F,e[45]=K,e[46]=B):B=e[46];let O;return e[47]!==S||e[48]!==U||e[49]!==B||e[50]!==j?(O=t.jsxs("div",{className:"rounded-2xl border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[j,S,U,B]}),e[47]=S,e[48]=U,e[49]=B,e[50]=j,e[51]=O):O=e[51],O};function Le(){const{periodId:n}=we().props,[e,m]=o.useState(ve),[d,s]=o.useState([]),[a,N]=o.useState(""),[i,M]=o.useState(""),[_,y]=o.useState([]),[v,x]=o.useState([]),[w,A]=o.useState({}),[f,E]=o.useState(!1),[j,h]=o.useState(!1),[L,$]=o.useState(!0),[c,S]=o.useState(null),[D,U]=o.useState(!1),[R,C]=o.useState(null),[V,F]=o.useState(!1),[K,B]=o.useState([]),O=o.useRef(!1),[T,I]=o.useState(0),J="Заполните названия прихода.",P=o.useMemo(()=>`period:${n}`,[n]),u=o.useRef(!1),Y=()=>typeof window>"u"?null:window.__periodCache?.[P]??null,z=r=>{if(typeof window>"u")return;const p=window;p.__periodCache||(p.__periodCache={}),p.__periodCache[P]=r},G=(_??[]).reduce((r,p)=>r+(Number(p.plannedAmount)||0),0),ae=(_??[]).reduce((r,p)=>r+(Number(p.actualAmount)||0),0),q=G-ae,b=(v??[]).reduce((r,p)=>r+(Number(p.amount)||0),0),re=(d??[]).reduce((r,p)=>r+(Number(p.amount)||0),0),g=o.useMemo(()=>!a||!i?0:$e(a,i),[a,i]),l=o.useMemo(()=>Object.values(w).reduce((r,p)=>r+(p||0),0),[w]),W=g>0?l/g:0,H=o.useMemo(()=>!a||!i?"Период":`${me(a)} — ${me(i)}`,[a,i]),be=o.useMemo(()=>!a||!i?"":`${g} дней · ${Ae(a,i)}`,[g,a,i]),se=re-G,pe=g>0?se/g:0,fe=[{title:"Dashboard",href:xe().url},{title:H,href:`/periods/${n}`}],he=r=>!!(r&&r.id&&Array.isArray(r.incomes)&&Array.isArray(r.expenses)&&Array.isArray(r.offIncomeExpenses)),ge=async()=>{if(u.current)return;const r=Y();if(he(r)){u.current=!0,m(r),s(r.incomes??[]),N(r.startDate??""),M(r.endDate??""),y(r.expenses??[]),x(r.offIncomeExpenses??[]),A(r.dailyExpenses??{}),$(!1);return}u.current=!0,$(!0),S(null);try{const p=await fetch(`/api/periods/${n}`);if(!p.ok)throw new Error("Не удалось загрузить период.");const k=(await p.json()).data,ee={id:k.id,startDate:k.start_date,endDate:k.end_date,dailyExpenses:k.daily_expenses??{},incomes:k.incomes.map(X=>({id:String(X.id),name:X.name,amount:X.amount})),expenses:k.expenses.map(X=>({id:String(X.id),name:X.name,plannedAmount:X.planned_amount,actualAmount:X.actual_amount,actualTouched:!1})),offIncomeExpenses:k.external_expenses.map(X=>({id:String(X.id),name:X.name,amount:X.amount}))};m(ee),s(ee.incomes),N(ee.startDate),M(ee.endDate),y(ee.expenses),x(ee.offIncomeExpenses),A(ee.dailyExpenses),z(ee)}catch(p){S(p instanceof Error?p.message:"Не удалось загрузить период.")}finally{$(!1)}},Z=async()=>{const r=ue(d);if(r.length>0){B(r),C(J);return}if(D){O.current=!0;return}U(!0),C(null),F(!1);try{const p=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",le=await fetch(`/api/periods/${n}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":p},body:JSON.stringify({start_date:a,end_date:i,daily_expenses:w,incomes:d.map(k=>({id:Number.isFinite(Number(k.id))?Number(k.id):void 0,name:k.name,amount:Number(k.amount)||0})),expenses:_.map(k=>({id:Number.isFinite(Number(k.id))?Number(k.id):void 0,name:k.name,planned_amount:Number(k.plannedAmount)||0,actual_amount:Number(k.actualAmount)||0})),external_expenses:v.map(k=>({id:Number.isFinite(Number(k.id))?Number(k.id):void 0,name:k.name,amount:Number(k.amount)||0}))})});if(le.status===409)throw new Error("Период пересекается с существующим.");if(!le.ok)throw new Error("Не удалось сохранить период.");F(!0),z({id:Number(n),startDate:a,endDate:i,incomes:d,expenses:_,offIncomeExpenses:v,dailyExpenses:w})}catch(p){C(p instanceof Error?p.message:"Не удалось сохранить период.")}finally{U(!1)}},ke=()=>{s(r=>[...r,{id:`i${Date.now()}`,name:"",amount:""}]),Z()},oe=()=>{I(r=>r+1)};return o.useEffect(()=>{ge()},[n]),o.useEffect(()=>{!D&&O.current&&(O.current=!1,Z())},[D]),o.useEffect(()=>{T>0&&Z()},[T]),o.useEffect(()=>{const r=ue(d);B(r),r.length===0&&R===J&&C(null)},[d,R]),t.jsxs(Ne,{breadcrumbs:fe,children:[t.jsx(je,{title:H}),t.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsxs("section",{className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Период"}),t.jsx("h1",{className:"mt-3 font-display text-3xl",children:H}),t.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:be})]}),t.jsx("div",{className:"flex flex-wrap items-center gap-2",children:t.jsx(ce,{href:xe(),prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← Ко всем периодам"})})]}),t.jsxs("section",{className:"relative z-10 grid gap-6 lg:grid-cols-[1.1fr_0.9fr] animate-reveal",style:ye(120),children:[L&&t.jsx("div",{className:"col-span-full rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),c&&t.jsx("div",{className:"col-span-full rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:c}),t.jsxs("div",{className:"order-2 grid gap-4 lg:order-none",children:[t.jsx(Se,{items:d,setItems:s,totalAmount:re,onAdd:ke,onBlurField:Z,invalidNameIds:K}),t.jsx(De,{title:"Обязательные траты",items:_,setItems:y,showDelete:f,onToggleDelete:()=>E(r=>!r),totalLabel:"Итого обязательных",totalPlanned:G,totalActual:ae,totalDifference:q,idPrefix:"e",onBlurField:Z,onAfterDelete:oe}),t.jsx(Ie,{title:"Сторонние траты",items:v,setItems:x,showDelete:f,onToggleDelete:()=>E(r=>!r),totalLabel:"Итого сторонних",totalAmount:b,idPrefix:"o",onBlurField:Z,onAfterDelete:oe})]}),t.jsxs("div",{className:"order-1 grid gap-4 lg:order-none",children:[t.jsxs("div",{className:"rounded-2xl border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:"Дни периода"}),t.jsx("button",{type:"button",onClick:()=>h(r=>!r),className:`rounded-full border px-3 py-1 text-xs transition ${j?"border-[#1e7b4f]/40 text-[#1e7b4f] dark:border-[#7ce0b3]/40 dark:text-[#7ce0b3]":"border-black/10 text-[#6a5d52] dark:border-white/10 dark:text-white/70"}`,children:j?"Готово":"Редактировать"})]}),t.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[t.jsx("div",{className:"px-1 text-base font-semibold tabular-nums",children:g}),t.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:"дней"})]}),t.jsx(ce,{href:`/periods/${n}/daily`,prefetch:!0,className:"mt-4 block w-full rounded-2xl border border-black/10 bg-white/80 px-4 py-3 text-center text-sm font-semibold text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.5)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"Ежедневные траты"}),j&&t.jsxs("div",{className:"mt-3 grid gap-2 sm:grid-cols-2",children:[t.jsxs("label",{className:"grid gap-1 text-xs text-[#6a5d52] dark:text-white/60",children:["Начало",t.jsx("input",{type:"date",value:a,onChange:r=>N(r.target.value),onBlur:Z,max:i,className:"rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm dark:border-white/10 dark:bg-white/10"})]}),t.jsxs("label",{className:"grid gap-1 text-xs text-[#6a5d52] dark:text-white/60",children:["Конец",t.jsx("input",{type:"date",value:i,onChange:r=>M(r.target.value),onBlur:Z,min:a,className:"rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm dark:border-white/10 dark:bg-white/10"})]})]})]}),t.jsxs("div",{className:"rounded-2xl border border-black/10 bg-white/85 px-5 py-6 text-[#1c1a17] shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white dark:shadow-[0_20px_40px_-26px_rgba(0,0,0,0.7)]",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:"Планируемое среднее в день"}),t.jsx("p",{className:"mt-2 text-xs text-[#6a5d52] dark:text-white/60",children:"(Приход − обязательные) / дни"}),t.jsx("p",{className:"mt-3 font-display text-2xl",children:Q(pe)}),t.jsxs("div",{className:"mt-4 grid gap-3 text-xs text-[#6a5d52] dark:text-white/70",children:[t.jsx("div",{className:"h-px w-full bg-black/10 dark:bg-white/10"}),t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:"Планируемая сумма на период"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm font-semibold",children:[t.jsx("span",{className:"font-display tabular-nums text-[#1e7b4f] dark:text-[#7ce0b3]",children:Q(re)}),t.jsx("span",{className:"text-black/50 dark:text-white/60",children:"−"}),t.jsx("span",{className:"font-display tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:Q(G)}),t.jsx("span",{className:"text-black/50 dark:text-white/60",children:"="}),t.jsx("span",{className:`font-display tabular-nums ${se>=0?"text-[#1e7b4f] dark:text-[#7ce0b3]":"text-[#b0352b] dark:text-[#ff8b7c]"}`,children:ne(se)})]}),t.jsx("div",{className:"text-[11px] uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60",children:"Приход − план = сумма в период"}),t.jsx("div",{className:"h-px w-full bg-black/10 dark:bg-white/10"}),t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:"Фактический остаток"}),t.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-sm font-semibold",children:[t.jsx("span",{className:"font-display tabular-nums text-[#1e7b4f] dark:text-[#7ce0b3]",children:Q(se)}),t.jsx("span",{className:`font-display tabular-nums ${q>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":q<0?"text-[#b0352b] dark:text-[#ff8b7c]":"text-[#6a5d52] dark:text-white/70"}`,children:ne(q).replace(/^([+−-])/,"$1 ")}),t.jsx("span",{className:"text-black/50 dark:text-white/60",children:"−"}),t.jsx("span",{className:"font-display tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:Q(l)}),t.jsx("span",{className:"text-black/50 dark:text-white/60",children:"="}),t.jsx("span",{className:`font-display tabular-nums ${se+q-l>=0?"text-[#1e7b4f] dark:text-[#7ce0b3]":"text-[#b0352b] dark:text-[#ff8b7c]"}`,children:ne(se+q-l)})]}),t.jsx("div",{className:"h-px w-full bg-black/10 dark:bg-white/10"}),t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-[#6a5d52] dark:text-white/60",children:"Фактическое среднее в день за период"}),t.jsx("div",{className:"mt-2 font-display text-2xl",children:Q(W)})]})]})]})]}),R&&t.jsx("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:R})]})]})}export{Le as default};
