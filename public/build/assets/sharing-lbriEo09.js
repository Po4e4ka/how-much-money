import{u as te,r as t,j as e,H as ae,L as re,a as o,i as v}from"./app-BVWgSHzr.js";import{A as ie}from"./app-layout-Dlui-8x_.js";import{d as ne}from"./index-BNdu6nsP.js";import{B as L}from"./badge-Dt8gxS7x.js";import{B as r}from"./createLucideIcon-Dy5WU4By.js";import{D as T,a as B,g as M,e as O,f as $,b as A}from"./dialog-hmbQak3e.js";import{I as le}from"./input-3xaTzikW.js";import{L as oe}from"./label-8Om6DZMy.js";import{I as de}from"./input-error-CkeRu_Lu.js";import{S as ce}from"./session-expired-modal-U03ZbsIs.js";/* empty css            */import"./index-FQBW3eK6.js";import"./index-DPs9ev9z.js";import"./app-logo-icon-DxPzyvNg.js";import"./pill-button-DWNTtgFR.js";const me=[{title:"Dashboard",href:ne().url},{title:"Sharing",href:"/sharing"}],H={active:"Активен",blocked:"Заблокирован"},z=l=>l==="blocked"?"destructive":"secondary";function Ce(){const{auth:l}=te().props,[y,d]=t.useState([]),[F,w]=t.useState(!0),[N,c]=t.useState(null),[P,h]=t.useState(!1),[p,f]=t.useState(""),[J,m]=t.useState(null),[R,g]=t.useState(!1),[U,b]=t.useState(!1),[i,x]=t.useState(null),[V,S]=t.useState(!1),[q,E]=t.useState({}),[G,u]=t.useState(!1),[I,K]=t.useState([]),[C,D]=t.useState(null),Q=t.useMemo(()=>l?.user?.name?`Кому открыт доступ от ${l.user.name}`:"Кому открыт доступ",[l?.user?.name]),W=async()=>{w(!0),c(null);try{const s=await o("/api/viewers");d(s.data??[])}catch(s){if(v(s)&&s.status===419){u(!0);return}c(s instanceof Error?s.message:"Не удалось загрузить список доступов.")}finally{w(!1)}},X=async()=>{D(null);try{const s=await o("/api/viewers/shared-with-me");K(s.data??[])}catch(s){D(s instanceof Error?s.message:"Не удалось загрузить доступы для просмотра.")}};t.useEffect(()=>{W(),X()},[]);const Y=()=>{f(""),m(null),g(!1)},Z=()=>{Y(),h(!0)},k=()=>{h(!1)},_=async()=>{if(!p.trim()){m("Введите почту пользователя.");return}m(null),g(!1),b(!0);try{const s=await o("/api/viewers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:p.trim()})});d(n=>[s.data,...n]),g(!0),f("")}catch(s){if(v(s)&&s.status===419){u(!0);return}m(s instanceof Error?s.message:"Не удалось отправить приглашение.")}finally{b(!1)}},ee=async s=>{E(a=>({...a,[s.id]:!0}));const n=s.status==="active"?"blocked":"active";try{await o(`/api/viewers/${s.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:n})}),d(a=>a.map(j=>j.id===s.id?{...j,status:n}:j))}catch(a){c(a instanceof Error?a.message:"Не удалось обновить статус.")}finally{E(a=>({...a,[s.id]:!1}))}},se=async()=>{if(i){S(!0);try{await o(`/api/viewers/${i.id}`,{method:"DELETE"}),d(s=>s.filter(n=>n.id!==i.id)),x(null)}catch(s){if(v(s)&&s.status===419){u(!0);return}c(s instanceof Error?s.message:"Не удалось удалить доступ.")}finally{S(!1)}}};return e.jsxs(ie,{breadcrumbs:me,children:[e.jsx(ae,{title:"Sharing"}),e.jsxs("div",{className:"mx-auto flex w-full max-w-5xl flex-col gap-6",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"font-display text-3xl",children:"Доступ к периодам"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:Q})]}),e.jsx(r,{onClick:Z,children:"Добавить доступ"})]}),N&&e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:N}),e.jsx("div",{className:"rounded-2xl border bg-card/60 p-6",children:F?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Загрузка..."}):y.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Пока никому не выдан доступ."}):e.jsx("div",{className:"divide-y",children:y.map(s=>e.jsxs("div",{className:"flex flex-col gap-4 py-4 first:pt-0 last:pb-0 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s.viewer?.name||"Без имени"}),e.jsx(L,{variant:z(s.status),children:H[s.status]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.viewer?.email??"Пользователь недоступен"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(r,{variant:"outline",size:"sm",onClick:()=>ee(s),disabled:!!q[s.id],children:s.status==="active"?"Заблокировать":"Разблокировать"}),e.jsx(r,{variant:"destructive",size:"sm",onClick:()=>x(s),children:"Удалить"})]})]},s.id))})}),e.jsxs("div",{className:"rounded-2xl border bg-card/60 p-6",children:[e.jsx("div",{className:"flex items-center justify-between gap-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"font-display text-2xl",children:"Доступы для просмотра"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Пользователи, которые дали вам доступ к своим периодам."})]})}),C&&e.jsx("div",{className:"mt-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:C}),e.jsx("div",{className:"mt-4",children:I.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Пока нет доступов для просмотра."}):e.jsx("div",{className:"divide-y",children:I.map(s=>e.jsxs("div",{className:"flex flex-col gap-4 py-4 first:pt-0 last:pb-0 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s.user?.name||"Без имени"}),e.jsx(L,{variant:z(s.status),children:H[s.status]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.user?.email??"Пользователь недоступен"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(r,{variant:"outline",size:"sm",asChild:!0,children:e.jsx(re,{href:`/shared/${s.user_id}`,children:"Посмотреть периоды"})})})]},s.id))})})]})]}),e.jsx(T,{open:P,onOpenChange:h,children:e.jsxs(B,{children:[e.jsxs(M,{children:[e.jsx(O,{children:"Добавить доступ"}),e.jsx($,{children:"Укажите почту пользователя, которому хотите открыть доступ к своим периодам."})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(oe,{htmlFor:"invite-email",children:"Почта"}),e.jsx(le,{id:"invite-email",type:"email",placeholder:"user@email.com",value:p,onChange:s=>f(s.target.value)}),e.jsx(de,{message:J??void 0}),R&&e.jsx("p",{className:"text-sm text-green-600",children:"Приглашение отправлено."})]}),e.jsxs(A,{children:[e.jsx(r,{variant:"ghost",onClick:k,children:"Отмена"}),e.jsx(r,{onClick:_,disabled:U,children:"Отправить приглашение"})]})]})}),e.jsx(T,{open:!!i,onOpenChange:s=>{s||x(null)},children:e.jsxs(B,{children:[e.jsxs(M,{children:[e.jsx(O,{children:"Удалить доступ?"}),e.jsx($,{children:i?.viewer?.email?`Удалить доступ для ${i.viewer.email}?`:"Удалить доступ для этого пользователя?"})]}),e.jsxs(A,{children:[e.jsx(r,{variant:"ghost",onClick:()=>x(null),children:"Отмена"}),e.jsx(r,{variant:"destructive",onClick:se,disabled:V,children:"Удалить"})]})]})}),G&&e.jsx(ce,{onClose:()=>u(!1),onReload:()=>window.location.reload()})]})}export{Ce as default};
