import{u as Q,r,j as e,H as U,L as W}from"./app-DmI4XuDo.js";import{A as X}from"./app-layout-CdnNduTw.js";import{d as G}from"./index-D48w0u2P.js";import{d as Y}from"./animation-DULAtfne.js";import{c as Z,b as T,f as ee,e as te}from"./date-C0FYGyP5.js";import{g as ae,c as se,f as re,t as de,a as z}from"./period-calculations-B9aBpp78.js";/* empty css            */import"./app-logo-icon-Dlz4YmZK.js";import"./index-CqMOdGhm.js";import"./index-4SCCvfrP.js";const ie={id:0,startDate:"",endDate:"",dailyExpenses:{},isClosed:!1};function we(){const{periodId:n,viewerId:d,viewerName:A,viewerEmail:O,viewerMode:F}=Q().props,v=!!(d??F),[t,_]=r.useState(ie),[l,c]=r.useState({}),[H,f]=r.useState(!0),[D,j]=r.useState(null),[b,N]=r.useState(!1),[$,S]=r.useState(null),[ne,E]=r.useState(!1),w=r.useRef(!1),g=r.useMemo(()=>`period:${d??"self"}:${n}`,[n,d]),x=r.useMemo(()=>d?`viewer_id=${d}`:"",[d]),m=r.useRef(!1),K=()=>typeof window>"u"?null:window.__periodCache?.[g]??null,C=a=>{if(typeof window>"u")return;const s=window;s.__periodCache||(s.__periodCache={}),s.__periodCache[g]={...s.__periodCache[g]??{},...a}},M=r.useMemo(()=>Z(t.startDate,t.endDate),[t.startDate,t.endDate]),y=r.useMemo(()=>!t.startDate||!t.endDate?"Период":`${T(t.startDate)} — ${T(t.endDate)}`,[t.startDate,t.endDate]),V=r.useMemo(()=>!t.startDate||!t.endDate?"":`${M} дней · ${ee(t.startDate,t.endDate)}`,[M,t.startDate,t.endDate]),B=r.useMemo(()=>!t.startDate||!t.endDate?[]:ae(t.startDate,t.endDate),[t.startDate,t.endDate]),L=t.isClosed||v,R=d?`/shared/${d}/periods`:"/periods";d?`${d}`:G().url,`${R}${n}`,`${R}${n}`;const q=async()=>{if(m.current)return;const a=K();if(a&&a.id){m.current=!0,_({...a,isClosed:!!a.isClosed}),c(a.dailyExpenses??{}),f(!1);return}m.current=!0,f(!0),j(null);try{const s=await fetch(`/api/periods/${n}${x?`?${x}`:""}`);if(!s.ok)throw new Error("Не удалось загрузить период.");const i=(await s.json()).data;_({id:i.id,startDate:i.start_date,endDate:i.end_date,dailyExpenses:i.daily_expenses??{},isClosed:!!i.is_closed}),c(i.daily_expenses??{}),C({id:i.id,startDate:i.start_date,endDate:i.end_date,dailyExpenses:i.daily_expenses??{},isClosed:!!i.is_closed})}catch(s){j(s instanceof Error?s.message:"Не удалось загрузить период.")}finally{f(!1)}},I=async()=>{if(!L){if(b){w.current=!0;return}N(!0),S(null),E(!1);try{const a=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",s=await fetch(`/api/periods/${n}${x?`?${x}`:""}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a},body:JSON.stringify({daily_expenses:l})});if(!s.ok){if(s.status===423){const p=await s.json();throw new Error(p.message??"Период закрыт и не редактируется.")}throw new Error("Не удалось сохранить ежедневные траты.")}E(!0),C({id:t.id,startDate:t.startDate,endDate:t.endDate,dailyExpenses:l,isClosed:t.isClosed})}catch(a){S(a instanceof Error?a.message:"Не удалось сохранить ежедневные траты.")}finally{N(!1)}}};return r.useEffect(()=>{m.current=!1,q()},[n,d]),r.useEffect(()=>{!b&&w.current&&(w.current=!1,I())},[b]),e.jsxs(X,{children:[e.jsx(U,{title:`Ежедневные траты · ${y}`}),e.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),e.jsxs("section",{className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Ежедневные траты"}),e.jsx("h1",{className:"mt-3 font-display text-3xl",children:y}),e.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:V})]}),e.jsx(W,{href:d?`/shared/${d}/periods/${n}`:`/periods/${n}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),v&&e.jsxs("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",e.jsx("span",{className:"font-semibold",children:A||O||`#${d}`}),". Режим только чтение."]}),e.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:Y(120),children:[H&&e.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),D&&e.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:D}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3 max-sm:snap-y max-sm:snap-mandatory max-sm:overflow-y-auto max-sm:max-h-[calc(100vh-190px)] max-sm:pb-8 max-sm:pr-1",children:B.map((a,s)=>{const p=s===B.length-1,{total:i,average:J}=se(a,l);return e.jsx("div",{className:`rounded-2xl border border-black/10 bg-white/80 p-4 text-sm shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 max-sm:min-h-[calc(100vh-315px)] max-sm:snap-start max-sm:mb-2 max-sm:p-3 ${p?"max-sm:mb-24":""}`,children:e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"grid gap-3 max-sm:gap-2",children:a.map(P=>{const o=te(P);return e.jsxs("div",{className:"grid gap-2 max-sm:flex max-sm:items-center max-sm:justify-between",children:[e.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:re(P)}),e.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:l[o]??"",disabled:L,onChange:u=>c(h=>{const k={...h};return u.target.value===""?delete k[o]:k[o]=de(u.target.value)||0,k}),onFocus:()=>{l[o]===0&&c(u=>{const h={...u};return delete h[o],h})},onBlur:I,className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10 max-sm:w-[70%] max-sm:px-2 max-sm:py-2 max-sm:text-xs"})]},o)})})}),e.jsxs("div",{className:"mt-auto flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-dashed border-black/10 bg-white/70 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/5 max-sm:grid max-sm:grid-cols-[1fr_auto] max-sm:items-center max-sm:gap-y-1 max-sm:px-2 max-sm:py-2",children:[e.jsx("span",{children:"Итого за неделю"}),e.jsx("span",{className:"font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:z(i)}),e.jsx("span",{className:"text-[#6a5d52] dark:text-white/60",children:"Среднее в день"}),e.jsx("span",{className:"font-display text-sm tabular-nums",children:z(J)})]})]})},`${a[0]?.toISOString()??s}`)})})]}),$&&e.jsx("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:$})]})]})}export{we as default};
