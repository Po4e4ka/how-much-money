import{c as I,j as t,L as ee,u as te,r as h,H as se,a as P,i as z}from"./app-BFaXAPnN.js";import{A as ae}from"./app-layout-DZMWa7-H.js";import{d as re}from"./index-Df2C-eH2.js";import{O as ie}from"./overlap-period-modal-D4JGPDZ6.js";import{P as J}from"./pill-button-DF0kvo2f.js";import{S as ne}from"./session-expired-modal-DsSDM7Mg.js";import{a as H,d as W,i as k,c as q,f as G,b as C,e as $}from"./date-ByBVlD4A.js";/* empty css            */import"./index-z7VGeFen.js";import"./index-8mPctj8f.js";import"./app-logo-icon-CuFaCK84.js";const de=i=>{const e=Math.round(i);return e===0?"0 ₽":`${e>0?"+":"−"}${Math.abs(e).toLocaleString("ru-RU")} ₽`},le=i=>{const e=I.c(21),{href:a,title:n,subtitle:l,isClosed:d,actualRemaining:s}=i,c=d===void 0?!1:d,m=`rounded-[28px] border bg-white/70 p-5 text-left shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:bg-white/10 ${c?"border-[#1e7b4f]/40 dark:border-[#7ce0b3]/40":"border-black/10 dark:border-white/10"}`;let b;e[0]!==n?(b=t.jsx("h3",{className:"font-display text-xl",children:n}),e[0]=n,e[1]=b):b=e[1];let u;e[2]!==l?(u=t.jsx("p",{className:"mt-1 text-xs text-[#6a5d52] dark:text-white/70",children:l}),e[2]=l,e[3]=u):u=e[3];let g;e[4]!==s||e[5]!==c?(g=c&&typeof s=="number"&&t.jsxs("p",{className:"mt-2 text-xs text-[#1e7b4f] dark:text-[#7ce0b3]",children:["Факт. остаток: ",de(s)]}),e[4]=s,e[5]=c,e[6]=g):g=e[6];let w;e[7]!==b||e[8]!==u||e[9]!==g?(w=t.jsxs("div",{className:"min-w-[180px]",children:[b,u,g]}),e[7]=b,e[8]=u,e[9]=g,e[10]=w):w=e[10];let f;e[11]!==c?(f=c&&t.jsx("div",{className:"flex-1 text-center text-xs uppercase tracking-[0.2em] text-[#1e7b4f] dark:text-[#7ce0b3]",children:"Период закрыт"}),e[11]=c,e[12]=f):f=e[12];let x;e[13]===Symbol.for("react.memo_cache_sentinel")?(x=t.jsx(J,{as:"span",className:"bg-white/80 text-[#1c1a17] dark:bg-white/10 dark:text-white",children:"Открыть период"}),e[13]=x):x=e[13];let p;e[14]!==w||e[15]!==f?(p=t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[w,f,x]}),e[14]=w,e[15]=f,e[16]=p):p=e[16];let j;return e[17]!==a||e[18]!==m||e[19]!==p?(j=t.jsx(ee,{href:a,prefetch:!0,className:m,children:p}),e[17]=a,e[18]=m,e[19]=p,e[20]=j):j=e[20],j},K=i=>{const e=I.c(7),{items:a,baseHref:n}=i;let l;if(e[0]!==n||e[1]!==a){let s;e[3]!==n?(s=c=>t.jsx(le,{href:`${n??"/periods"}/${c.id}`,title:c.title,subtitle:c.subtitle,isClosed:c.isClosed,actualRemaining:c.actualRemaining},c.id),e[3]=n,e[4]=s):s=e[4],l=a.map(s),e[0]=n,e[1]=a,e[2]=l}else l=e[2];let d;return e[5]!==l?(d=t.jsx("div",{className:"grid gap-4",children:l}),e[5]=l,e[6]=d):d=e[6],d},oe=`
## Приложение обновилось!
___
## Что нового?

- дабавлена фича закрытия периода
- максимальный диапозон не больше 3-х меяцев
- бновлены иконки

___
version: 0.1.3
`,ce="Круто!",N=i=>i.split("**").map((a,n)=>n%2===1?t.jsx("strong",{children:a},n):a),xe=i=>{const e=i.trim().split(`
`),a=[];let n=[];const l=()=>{n.length&&(a.push(t.jsx("ul",{className:"list-disc pl-5",children:n.map((d,s)=>t.jsx("li",{children:N(d)},s))},`list-${a.length}`)),n=[])};return e.forEach(d=>{const s=d.trim();if(!s){l();return}if(s.startsWith("- ")){n.push(s.slice(2));return}if(l(),s.startsWith("### ")){a.push(t.jsx("h4",{className:"text-lg font-semibold",children:N(s.slice(4))},`h4-${a.length}`));return}if(s.startsWith("## ")){a.push(t.jsx("h3",{className:"text-xl font-semibold",children:N(s.slice(3))},`h3-${a.length}`));return}if(s.startsWith("# ")){a.push(t.jsx("h2",{className:"text-2xl font-semibold",children:N(s.slice(2))},`h2-${a.length}`));return}a.push(t.jsx("p",{className:"text-sm text-[#6a5d52] dark:text-white/70",children:N(s)},`p-${a.length}`))}),l(),a},he=i=>{const e=I.c(4),{onConfirm:a,confirmDisabled:n}=i,l=n===void 0?!1:n;let d;e[0]===Symbol.for("react.memo_cache_sentinel")?(d=t.jsx("div",{className:"space-y-4",children:xe(oe)}),e[0]=d):d=e[0];let s;return e[1]!==l||e[2]!==a?(s=t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6",children:t.jsxs("div",{className:"w-full max-w-xl rounded-3xl border border-black/10 bg-white/95 p-6 text-[#1c1a17] shadow-[0_24px_60px_-28px_rgba(0,0,0,0.7)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white",children:[d,t.jsx("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:t.jsx(J,{type:"button",onClick:a,className:"border-transparent bg-[#d87a4a] px-4 py-2 text-xs font-semibold text-white shadow-[0_14px_28px_-18px_rgba(216,122,74,0.8)] disabled:cursor-not-allowed disabled:opacity-70",disabled:l,children:ce})})]})}),e[1]=l,e[2]=a,e[3]=s):s=e[3],s},me=[{title:"Dashboard",href:re().url}],V=i=>{const e=k(i.start_date)&&k(i.end_date),a=e?q(i.start_date,i.end_date):0;return{title:e?`${C(i.start_date)} — ${C(i.end_date)}`:"Период",subtitle:e?`${a} дней · ${G(i.start_date,i.end_date)}`:"Даты не заданы"}};function ye(){const{auth:i,viewerId:e,viewerName:a,viewerEmail:n,viewerMode:l}=te().props,d=!!(e??l),[s,c]=h.useState(""),[m,b]=h.useState(""),[u,g]=h.useState(!1),[w,f]=h.useState(null),[x,p]=h.useState(null),[j,y]=h.useState(!1),[v,Q]=h.useState([]),[E,M]=h.useState(!0),[S,L]=h.useState(null),[X,R]=h.useState(i.user?.is_info_shown===!1),[Y,D]=h.useState(!1);h.useEffect(()=>{R(i.user?.is_info_shown===!1)},[i.user]);const Z=()=>{R(!1),P("/api/user/info-shown",{method:"POST",headers:{"Content-Type":"application/json"}}).catch(r=>{if(z(r)&&r.status===419){D(!0);return}console.error(r)})},F=async()=>{M(!0),L(null);try{const r=e?`?viewer_id=${e}`:"",o=await P(`/api/periods${r}`);Q(o.data??[])}catch(r){L(r instanceof Error?r.message:"Не удалось загрузить периоды.")}finally{M(!1)}};h.useEffect(()=>{F()},[]);const O=async(r=!1)=>{if(!d){if(!s||!m){f("Укажите даты начала и конца периода.");return}if(!r){const o=$(s),_=$(m),A=v.find(T=>{const B=$(T.start_date),U=$(T.end_date);return!Number.isFinite(o)||!Number.isFinite(_)||!Number.isFinite(B)||!Number.isFinite(U)?!1:o<U&&_>B});if(A){p(A),y(!0);return}}g(!0),f(null);try{await P("/api/periods",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({start_date:s,end_date:m,force:!!r})}),c(""),b(""),p(null),y(!1),await F()}catch(o){if(z(o)){if(o.status===419){D(!0);return}if(o.status===409&&typeof o.data=="object"&&o.data){const _=o.data.overlap;if(_){p(_),y(!0);return}}}f(o instanceof Error?o.message:"Не удалось сохранить период.")}finally{g(!1)}}};return t.jsxs(ae,{breadcrumbs:me,children:[t.jsx(se,{title:"Dashboard"}),t.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsx("section",{className:"relative z-10 flex flex-wrap items-end justify-between gap-6",children:t.jsxs("div",{children:[t.jsx("h1",{className:"mt-3 font-display text-3xl",children:"Периоды учета"}),t.jsx("p",{className:"mt-2 max-w-xl text-sm text-[#6a5d52] dark:text-white/70",children:d?"Режим просмотра. Создание и редактирование недоступны.":"Добавьте новый период сверху и управляйте историей ниже. При клике откроется отдельная страница периода."})]})}),d&&t.jsxs("div",{className:"relative z-10 rounded-[24px] border border-black/10 bg-white/70 px-5 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",t.jsx("span",{className:"font-semibold",children:a||n||`#${e}`}),"."]}),!d&&t.jsxs("section",{className:"relative z-10 rounded-[28px] border border-black/10 bg-white/85 p-6 shadow-[0_22px_44px_-28px_rgba(28,26,23,0.6)] backdrop-blur animate-reveal dark:border-white/10 dark:bg-white/10",style:W(120),children:[t.jsx("div",{className:"flex flex-wrap items-center justify-between gap-4",children:t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Новый период"}),t.jsx("h2",{className:"mt-2 font-display text-2xl",children:"Добавить диапазон дат"})]})}),t.jsxs("div",{className:"mt-6 grid gap-4 sm:grid-cols-[1fr_1fr_1fr]",children:[t.jsxs("label",{className:"grid cursor-pointer grid-cols-[32px_minmax(0,1fr)] items-center gap-3 text-xs text-[#6a5d52] dark:text-white/70",children:[t.jsx("span",{children:"С"}),t.jsx("input",{type:"date",value:s,onChange:r=>c(r.target.value),min:m?H(m,-3):void 0,max:m||void 0,className:"date-input ml-auto w-[80%] rounded-lg border border-black/10 bg-white/90 px-4 py-3 text-sm text-[#1c1a17] outline-none transition focus:border-black/30 dark:border-white/10 dark:bg-white/10 dark:text-white sm:ml-0 sm:w-full"})]}),t.jsxs("label",{className:"grid cursor-pointer grid-cols-[32px_minmax(0,1fr)] items-center gap-3 text-xs text-[#6a5d52] dark:text-white/70",children:[t.jsx("span",{children:"По"}),t.jsx("input",{type:"date",value:m,onChange:r=>b(r.target.value),min:s||void 0,max:s?H(s,3):void 0,className:"date-input ml-auto w-[80%] rounded-lg border border-black/10 bg-white/90 px-4 py-3 text-sm text-[#1c1a17] outline-none transition focus:border-black/30 dark:border-white/10 dark:bg-white/10 dark:text-white sm:ml-0 sm:w-full"})]}),t.jsx("div",{className:"flex flex-col justify-end",children:t.jsx("button",{className:"rounded-2xl bg-[#d87a4a] px-4 py-3 text-sm font-semibold text-white shadow-[0_14px_28px_-18px_rgba(216,122,74,0.8)] transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-70",type:"button",onClick:()=>O(!1),disabled:u,children:u?"Сохранение...":"Сохранить"})})]}),w&&t.jsx("p",{className:"mt-3 text-xs text-[#b0352b] dark:text-[#ff8b7c]",children:w})]}),t.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:W(240),children:[v.some(r=>r.is_pinned)&&t.jsxs("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Закреплённый период"}),t.jsx("div",{className:"mt-4",children:(()=>{const r=v.find(_=>_.is_pinned);if(!r)return null;const o=V(r);return t.jsx(K,{items:[{id:r.id,title:o.title,subtitle:o.subtitle,isClosed:!!r.is_closed,actualRemaining:r.actual_remaining??null}],baseHref:e?`/shared/${e}/periods`:void 0})})()})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"font-display text-2xl",children:"История периодов"}),t.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:"Сначала новые"})]}),t.jsxs("div",{className:"grid gap-4",children:[E&&t.jsx("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем периоды..."}),S&&t.jsx("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:S}),!E&&!S&&v.length===0&&t.jsx("div",{className:"rounded-[28px] border border-black/10 bg-white/70 p-5 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Периодов пока нет. Создайте первый диапазон выше."}),!E&&!S&&t.jsx(K,{items:v.map(r=>{const o=V(r);return{id:r.id,title:o.title,subtitle:o.subtitle,isClosed:!!r.is_closed,actualRemaining:r.actual_remaining??null}}),baseHref:e?`/shared/${e}/periods`:void 0})]})]}),!d&&x&&t.jsx(ie,{href:`/periods/${x.id}`,title:k(x.start_date)&&k(x.end_date)?`${C(x.start_date)} — ${C(x.end_date)}`:"Период",subtitle:k(x.start_date)&&k(x.end_date)?`${q(x.start_date,x.end_date)} дней · ${G(x.start_date,x.end_date)}`:"Даты не заданы",onClose:()=>{p(null),y(!1)},onConfirm:()=>O(!0),confirmDisabled:!j||u}),X&&t.jsx(he,{onConfirm:Z}),Y&&t.jsx(ne,{onClose:()=>D(!1),onReload:()=>window.location.reload()})]})]})}export{ye as default};
