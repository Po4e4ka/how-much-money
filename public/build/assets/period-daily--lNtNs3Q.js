import{u as U,r as a,j as e,H as W,L as G,a as X}from"./app-Cs7KdXzy.js";import{O as Y}from"./onboarding-demo-banner-DrbOwn4Z.js";import{A as Z}from"./app-layout-Ce4sc7ax.js";import{d as ee}from"./animation-DULAtfne.js";import{c as te,b as O,f as ae,e as se}from"./date-C0FYGyP5.js";import{g as re,c as de,f as ie,t as ne,a as P,o as oe}from"./period-calculations-ClI-_2h0.js";/* empty css            */import"./index-BNdu6nsP.js";import"./createLucideIcon-l5W18Rcb.js";import"./index-mGBfCi1u.js";import"./index-CfZs0pIN.js";import"./app-logo-icon-C7ZpM3Vh.js";const le={id:0,startDate:"",endDate:"",dailyExpenses:{},isClosed:!1};function ke(){const{periodId:n,viewerId:i,viewerName:F,viewerEmail:z,viewerMode:A,onboardingMode:T}=U().props,v=!!(i??A),l=!!T,k=l?oe:X,[t,D]=a.useState(le),[c,x]=a.useState({}),[H,f]=a.useState(!0),[_,j]=a.useState(null),[b,N]=a.useState(!1),[$,C]=a.useState(null),g=a.useRef(!1),w=a.useMemo(()=>`period:${i??"self"}:${n}`,[n,i]),m=a.useMemo(()=>i?`viewer_id=${i}`:"",[i]),p=a.useRef(!1),K=()=>typeof window>"u"?null:window.__periodCache?.[w]??null,E=s=>{if(typeof window>"u")return;const d=window;d.__periodCache||(d.__periodCache={}),d.__periodCache[w]={...d.__periodCache[w]??{},...s}},S=a.useMemo(()=>te(t.startDate,t.endDate),[t.startDate,t.endDate]),M=a.useMemo(()=>!t.startDate||!t.endDate?"Период":`${O(t.startDate)} — ${O(t.endDate)}`,[t.startDate,t.endDate]),V=a.useMemo(()=>!t.startDate||!t.endDate?"":`${S} дней · ${ae(t.startDate,t.endDate)}`,[S,t.startDate,t.endDate]),B=a.useMemo(()=>!t.startDate||!t.endDate?[]:re(t.startDate,t.endDate),[t.startDate,t.endDate]),L=t.isClosed||v,q=async()=>{if(p.current)return;const s=K();if(s&&s.id){p.current=!0,D({...s,isClosed:!!s.isClosed}),x(s.dailyExpenses??{}),f(!1);return}p.current=!0,f(!0),j(null);try{const r=(await k(`/api/periods/${n}${m?`?${m}`:""}`)).data;D({id:r.id,startDate:r.start_date,endDate:r.end_date,dailyExpenses:r.daily_expenses??{},isClosed:!!r.is_closed}),x(r.daily_expenses??{}),E({id:r.id,startDate:r.start_date,endDate:r.end_date,dailyExpenses:r.daily_expenses??{},isClosed:!!r.is_closed})}catch(d){j(d instanceof Error?d.message:"Не удалось загрузить период.")}finally{f(!1)}},I=async()=>{if(!L){if(b){g.current=!0;return}N(!0),C(null);try{await k(`/api/periods/${n}${m?`?${m}`:""}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({daily_expenses:c})}),E({id:t.id,startDate:t.startDate,endDate:t.endDate,dailyExpenses:c,isClosed:t.isClosed})}catch(s){C(s instanceof Error?s.message:"Не удалось сохранить ежедневные траты.")}finally{N(!1)}}};return a.useEffect(()=>{p.current=!1,q()},[n,i]),a.useEffect(()=>{!b&&g.current&&(g.current=!1,I())},[b]),e.jsxs(Z,{hideHeader:l,children:[e.jsx(W,{title:`Ежедневные траты · ${M}`}),l&&e.jsx(Y,{}),e.jsxs("div",{className:`relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee] ${l?"pt-16":""}`,children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),e.jsxs("section",{className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Ежедневные траты"}),e.jsx("h1",{className:"mt-3 font-display text-3xl",children:M}),e.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:V})]}),e.jsx(G,{href:i?`/shared/${i}/periods/${n}`:l?`/onboarding/periods/${n}`:`/periods/${n}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),v&&e.jsxs("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",e.jsx("span",{className:"font-semibold",children:F||z||`#${i}`}),". Режим только чтение."]}),e.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:ee(120),children:[H&&e.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),_&&e.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:_}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3 max-sm:snap-y max-sm:snap-mandatory max-sm:overflow-y-auto max-sm:max-h-[calc(100vh-190px)] max-sm:pb-8 max-sm:pr-1",children:B.map((s,d)=>{const r=d===B.length-1,{total:J,average:Q}=de(s,c);return e.jsx("div",{className:`rounded-2xl border border-black/10 bg-white/80 p-4 text-sm shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 max-sm:min-h-[calc(100vh-315px)] max-sm:snap-start max-sm:mb-2 max-sm:p-3 ${r?"max-sm:mb-24":""}`,children:e.jsxs("div",{className:"flex h-full flex-col gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"grid gap-3 max-sm:gap-2",children:s.map(R=>{const o=se(R);return e.jsxs("div",{className:"grid gap-2 max-sm:flex max-sm:items-center max-sm:justify-between",children:[e.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:ie(R)}),e.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:c[o]??"",disabled:L,onChange:u=>x(h=>{const y={...h};return u.target.value===""?delete y[o]:y[o]=ne(u.target.value)||0,y}),onFocus:()=>{c[o]===0&&x(u=>{const h={...u};return delete h[o],h})},onBlur:I,className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10 max-sm:w-[70%] max-sm:px-2 max-sm:py-2 max-sm:text-xs"})]},o)})})}),e.jsxs("div",{className:"mt-auto flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-dashed border-black/10 bg-white/70 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/5 max-sm:grid max-sm:grid-cols-[1fr_auto] max-sm:items-center max-sm:gap-y-1 max-sm:px-2 max-sm:py-2",children:[e.jsx("span",{children:"Итого за неделю"}),e.jsx("span",{className:"font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:P(J)}),e.jsx("span",{className:"text-[#6a5d52] dark:text-white/60",children:"Среднее в день"}),e.jsx("span",{className:"font-display text-sm tabular-nums",children:P(Q)})]})]})},`${s[0]?.toISOString()??d}`)})})]}),$&&e.jsx("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:$})]})]})}export{ke as default};
