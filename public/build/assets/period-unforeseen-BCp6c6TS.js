import{u as ae,r as n,j as t,H as se,L as re,a as O}from"./app-BFaXAPnN.js";import{B as ne,a as oe,E as de,O as ie}from"./off-income-block-BSE5mXsN.js";import{P as C}from"./pill-button-DF0kvo2f.js";import{A as le}from"./app-layout-DZMWa7-H.js";import{c as ce,b as z,f as ue,d as xe}from"./date-ByBVlD4A.js";import{b as fe,a as pe,d as F,t as me}from"./period-calculations-CUCDjb88.js";/* empty css            */import"./index-Df2C-eH2.js";import"./index-z7VGeFen.js";import"./index-8mPctj8f.js";import"./app-logo-icon-CuFaCK84.js";const he={id:0,startDate:"",endDate:"",unforeseenAllocated:0,unforeseenExpenses:[],isClosed:!1};function Ae(){const{periodId:d,viewerId:o,viewerName:U,viewerEmail:H,viewerMode:V}=ae().props,A=!!(o??V),[a,S]=n.useState(he),[l,g]=n.useState(0),[x,y]=n.useState([]),[q,J]=n.useState(!1),[E,v]=n.useState(!0),[k,$]=n.useState(null),[c,f]=n.useState(!1),[P,p]=n.useState(null),[T,K]=n.useState(0),[Q,D]=n.useState(!1),m=n.useRef(!1),j=n.useMemo(()=>`period:${o??"self"}:${d}`,[d,o]),h=n.useMemo(()=>o?`viewer_id=${o}`:"",[o]),w=n.useRef(!1),Z=()=>typeof window>"u"?null:window.__periodCache?.[j]??null,B=e=>{if(typeof window>"u")return;const r=window;r.__periodCache||(r.__periodCache={});const s=e.unforeseenExpenses.map(i=>({id:i.id,name:i.name,plannedAmount:0,actualAmount:i.amount,actualTouched:!0}));r.__periodCache[j]={...r.__periodCache[j]??{},id:e.id,startDate:e.startDate,endDate:e.endDate,unforeseenAllocated:e.unforeseenAllocated,unforeseenExpenses:s,isClosed:e.isClosed}},G=fe(x??[]),I=n.useMemo(()=>ce(a.startDate,a.endDate),[a.startDate,a.endDate]),L=n.useMemo(()=>!a.startDate||!a.endDate?"Период":`${z(a.startDate)} — ${z(a.endDate)}`,[a.startDate,a.endDate]),W=n.useMemo(()=>!a.startDate||!a.endDate?"":`${I} дней · ${ue(a.startDate,a.endDate)}`,[I,a.startDate,a.endDate]),u=a.isClosed||A,M=async(e=l,r=x)=>{await O(`/api/periods/${d}${h?`?${h}`:""}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({unforeseen_allocated:e,unforeseen_expenses:r.filter(s=>s.name.trim()!=="").map(s=>({id:Number.isFinite(Number(s.id))?Number(s.id):void 0,name:s.name,planned_amount:0,actual_amount:F(s.amount)}))})}),B({id:a.id,startDate:a.startDate,endDate:a.endDate,unforeseenAllocated:e,unforeseenExpenses:r,isClosed:a.isClosed})},X=async()=>{if(w.current)return;const e=Z();if(e&&e.id&&Array.isArray(e.unforeseenExpenses)&&typeof e.unforeseenAllocated=="number"){w.current=!0;const r=e.unforeseenExpenses.map(s=>({id:s.id,name:s.name,amount:F(s.actualAmount)}));if(S({id:e.id,startDate:e.startDate??"",endDate:e.endDate??"",unforeseenAllocated:e.unforeseenAllocated??0,unforeseenExpenses:r,isClosed:!!e.isClosed}),g(e.unforeseenAllocated??0),y(r),v(!1),typeof navigator<"u"&&!navigator.onLine)return}w.current=!0,v(!0),$(null);try{const s=(await O(`/api/periods/${d}${h?`?${h}`:""}`)).data,i=s.unforeseen_expenses.map(N=>({id:String(N.id),name:N.name,amount:N.actual_amount})),b={id:s.id,startDate:s.start_date,endDate:s.end_date,unforeseenAllocated:Number(s.unforeseen_allocated??0),unforeseenExpenses:i,isClosed:!!s.is_closed};S(b),g(b.unforeseenAllocated),y(b.unforeseenExpenses),B(b)}catch(r){$(r instanceof Error?r.message:"Не удалось загрузить период.")}finally{v(!1)}},_=async()=>{if(!u){if(c){m.current=!0;return}f(!0),p(null);try{await M()}catch(e){p(e instanceof Error?e.message:"Не удалось сохранить непредвиденные траты.")}finally{f(!1)}}},R=async()=>{if(u)return;const e=window.prompt("Введите сумму, которую хотите выделить на непредвиденные расходы:",String(l));if(e===null)return;const r=me(e),s=r===""?0:r;if(g(s),c){m.current=!0;return}f(!0),p(null);try{await M(s,x)}catch(i){p(i instanceof Error?i.message:"Не удалось сохранить выделенную сумму.")}finally{f(!1)}},Y=()=>{if(u)return;const e=new Date;e.setHours(0,0,0,0);const r=a.startDate?new Date(`${a.startDate}T00:00:00`):null;if(l>0&&r instanceof Date&&Number.isFinite(r.getTime())&&e>r){D(!0);return}R()},ee=async()=>{D(!1),await R()},te=()=>{K(e=>e+1)};return n.useEffect(()=>{w.current=!1,X()},[d,o]),n.useEffect(()=>{!c&&m.current&&(m.current=!1,_())},[c]),n.useEffect(()=>{T>0&&_()},[T]),t.jsxs(le,{children:[t.jsx(se,{title:`Непредвиденные расходы · ${L}`}),t.jsxs("div",{className:"relative flex flex-1 flex-col gap-6 overflow-x-hidden rounded-xl p-3 font-body text-[#1c1a17] dark:text-[#f7f3ee] sm:gap-8 sm:p-6",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsxs("section",{className:"relative z-10 mx-auto flex w-full max-w-3xl flex-wrap items-center justify-between gap-4 sm:gap-6",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Непредвиденные расходы"}),t.jsx("h1",{className:"mt-3 font-display text-2xl sm:text-3xl",children:L}),t.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:W})]}),t.jsx(re,{href:o?`/shared/${o}/periods/${d}`:`/periods/${d}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),A&&t.jsxs("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",t.jsx("span",{className:"font-semibold",children:U||H||`#${o}`}),". Режим только чтение."]}),t.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:xe(120),children:[E&&t.jsx("div",{className:"mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),k&&t.jsx("div",{className:"mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:k}),!E&&!k&&t.jsxs("div",{className:"mx-auto grid w-full max-w-3xl min-w-0 gap-4",children:[t.jsxs("div",{className:"rounded-lg border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsx(ne,{children:"План на непредвиденные"}),t.jsx(C,{type:"button",onClick:Y,disabled:u,children:"Изменить"})]}),t.jsx(oe,{className:`mt-3 ${l>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":"text-[#6a5d52] dark:text-white/60"}`,children:l>0?pe(l):"0"})]}),t.jsx(de,{periodId:d,type:"unforeseen",viewerId:o,children:t.jsx(ie,{title:"Непредвиденные расходы",items:x,setItems:y,showDelete:q,onToggleDelete:()=>J(e=>!e),totalLabel:"Итого потрачено",totalAmount:G,idPrefix:"u",onBlurField:_,onAfterDelete:te,readOnly:u})})]})]}),P&&t.jsx("div",{className:"relative z-10 mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:P}),Q&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6",children:t.jsxs("div",{className:"w-full max-w-xl rounded-lg border border-black/10 bg-white/95 p-6 text-[#1c1a17] shadow-[0_24px_60px_-28px_rgba(0,0,0,0.7)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white",children:[t.jsx("h3",{className:"font-display text-2xl",children:"Подтвердить изменение?"}),t.jsx("p",{className:"mt-3 text-sm text-[#6a5d52] dark:text-white/70",children:"Эта цифра уже запланирована на текущий период. Вы уверены, что хотите поменять? Данное действие повлияет на все цифры."}),t.jsxs("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:[t.jsx(C,{type:"button",onClick:()=>{D(!1)},className:"px-4 py-2",children:"Отмена"}),t.jsx(C,{type:"button",onClick:ee,tone:"success",className:"px-4 py-2",disabled:c,children:"Подтвердить"})]})]})})]})]})}export{Ae as default};
