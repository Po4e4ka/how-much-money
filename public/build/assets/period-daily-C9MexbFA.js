import{u as z,r,j as t,H as F,L as K}from"./app-Dzp51NVV.js";import{A as O}from"./app-layout-z44Wcmjn.js";import{d as H}from"./index-CYtoQFCC.js";import{d as q}from"./animation-DULAtfne.js";import{c as J,b as B,f as U,e as V}from"./date-C0FYGyP5.js";import{g as W,c as X,f as G,t as Q,a as M}from"./period-calculations-B9aBpp78.js";/* empty css            */import"./app-logo-icon-B6PMVmBd.js";import"./index-CJj_ylFk.js";import"./index-CjX2JUid.js";const Y={id:0,startDate:"",endDate:"",dailyExpenses:{},isClosed:!1};function ce(){const{periodId:n}=z().props,[e,w]=r.useState(Y),[i,l]=r.useState({}),[R,p]=r.useState(!0),[k,v]=r.useState(null),[u,D]=r.useState(!1),[j,_]=r.useState(null),[Z,N]=r.useState(!1),f=r.useRef(!1),h=r.useMemo(()=>`period:${n}`,[n]),b=r.useRef(!1),I=()=>typeof window>"u"?null:window.__periodCache?.[h]??null,S=a=>{if(typeof window>"u")return;const s=window;s.__periodCache||(s.__periodCache={}),s.__periodCache[h]={...s.__periodCache[h]??{},...a}},C=r.useMemo(()=>J(e.startDate,e.endDate),[e.startDate,e.endDate]),g=r.useMemo(()=>!e.startDate||!e.endDate?"Период":`${B(e.startDate)} — ${B(e.endDate)}`,[e.startDate,e.endDate]),P=r.useMemo(()=>!e.startDate||!e.endDate?"":`${C} дней · ${U(e.startDate,e.endDate)}`,[C,e.startDate,e.endDate]),E=r.useMemo(()=>!e.startDate||!e.endDate?[]:W(e.startDate,e.endDate),[e.startDate,e.endDate]);H().url,`${n}`,`${n}`;const T=async()=>{if(b.current)return;const a=I();if(a&&a.id){b.current=!0,w({...a,isClosed:!!a.isClosed}),l(a.dailyExpenses??{}),p(!1);return}b.current=!0,p(!0),v(null);try{const s=await fetch(`/api/periods/${n}`);if(!s.ok)throw new Error("Не удалось загрузить период.");const d=(await s.json()).data;w({id:d.id,startDate:d.start_date,endDate:d.end_date,dailyExpenses:d.daily_expenses??{},isClosed:!!d.is_closed}),l(d.daily_expenses??{}),S({id:d.id,startDate:d.start_date,endDate:d.end_date,dailyExpenses:d.daily_expenses??{},isClosed:!!d.is_closed})}catch(s){v(s instanceof Error?s.message:"Не удалось загрузить период.")}finally{p(!1)}},$=async()=>{if(!e.isClosed){if(u){f.current=!0;return}D(!0),_(null),N(!1);try{const a=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",s=await fetch(`/api/periods/${n}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a},body:JSON.stringify({daily_expenses:i})});if(!s.ok){if(s.status===423){const c=await s.json();throw new Error(c.message??"Период закрыт и не редактируется.")}throw new Error("Не удалось сохранить ежедневные траты.")}N(!0),S({id:e.id,startDate:e.startDate,endDate:e.endDate,dailyExpenses:i,isClosed:e.isClosed})}catch(a){_(a instanceof Error?a.message:"Не удалось сохранить ежедневные траты.")}finally{D(!1)}}};return r.useEffect(()=>{T()},[n]),r.useEffect(()=>{!u&&f.current&&(f.current=!1,$())},[u]),t.jsxs(O,{children:[t.jsx(F,{title:`Ежедневные траты · ${g}`}),t.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsxs("section",{className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Ежедневные траты"}),t.jsx("h1",{className:"mt-3 font-display text-3xl",children:g}),t.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:P})]}),t.jsx(K,{href:`/periods/${n}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),t.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:q(120),children:[R&&t.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),k&&t.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:k}),t.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3 max-sm:snap-y max-sm:snap-mandatory max-sm:overflow-y-auto max-sm:max-h-[calc(100vh-190px)] max-sm:pb-8 max-sm:pr-1",children:E.map((a,s)=>{const c=s===E.length-1,{total:d,average:A}=X(a,i);return t.jsx("div",{className:`rounded-2xl border border-black/10 bg-white/80 p-4 text-sm shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 max-sm:min-h-[calc(100vh-315px)] max-sm:snap-start max-sm:mb-2 max-sm:p-3 ${c?"max-sm:mb-24":""}`,children:t.jsxs("div",{className:"flex h-full flex-col gap-4",children:[t.jsx("div",{className:"flex-1",children:t.jsx("div",{className:"grid gap-3 max-sm:gap-2",children:a.map(L=>{const o=V(L);return t.jsxs("div",{className:"grid gap-2 max-sm:flex max-sm:items-center max-sm:justify-between",children:[t.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:G(L)}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:i[o]??"",disabled:e.isClosed,onChange:x=>l(m=>{const y={...m};return x.target.value===""?delete y[o]:y[o]=Q(x.target.value)||0,y}),onFocus:()=>{i[o]===0&&l(x=>{const m={...x};return delete m[o],m})},onBlur:$,className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10 max-sm:w-[70%] max-sm:px-2 max-sm:py-2 max-sm:text-xs"})]},o)})})}),t.jsxs("div",{className:"mt-auto flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-dashed border-black/10 bg-white/70 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/5 max-sm:grid max-sm:grid-cols-[1fr_auto] max-sm:items-center max-sm:gap-y-1 max-sm:px-2 max-sm:py-2",children:[t.jsx("span",{children:"Итого за неделю"}),t.jsx("span",{className:"font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:M(d)}),t.jsx("span",{className:"text-[#6a5d52] dark:text-white/60",children:"Среднее в день"}),t.jsx("span",{className:"font-display text-sm tabular-nums",children:M(A)})]})]})},`${a[0]?.toISOString()??s}`)})})]}),j&&t.jsx("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:j})]})]})}export{ce as default};
