import{c as ee,j as t,L as Ve,u as Ot,r as f,H as Mt,a as Bt,i as we}from"./app-BVWgSHzr.js";import{P as se}from"./pill-button-DWNTtgFR.js";import{B as ne,a as De,b as mt,E as Ge,O as Ft}from"./off-income-block-BDxUxr-e.js";import{d as Lt,O as Ut,e as zt}from"./onboarding-demo-banner-Chp8AR0k.js";import{O as Gt}from"./onboarding-tour-CdPPFnlj.js";import{O as Ht}from"./overlap-period-modal-D4ngPy3V.js";import{a as Y,e as be,t as Ne,h as nt,b as rt,i as Vt,j as qt,k as lt,l as Jt,o as Kt,d as pe}from"./period-calculations-CHQGcvRf.js";import{S as Qt}from"./session-expired-modal-U03ZbsIs.js";import{A as Zt}from"./app-layout-Dlui-8x_.js";import{d as Wt}from"./animation-DULAtfne.js";import{c as it,b as he,f as dt,a as ot}from"./date-C0FYGyP5.js";import{d as ct}from"./index-BNdu6nsP.js";/* empty css            */import"./createLucideIcon-Dy5WU4By.js";import"./index-FQBW3eK6.js";import"./index-DPs9ev9z.js";import"./app-logo-icon-DxPzyvNg.js";const Xt=c=>{const e=ee.c(10),{onConfirm:i,onCancel:d,confirmDisabled:s}=c,a=s===void 0?!1:s;let l,x;e[0]===Symbol.for("react.memo_cache_sentinel")?(l=t.jsx("h3",{className:"font-display text-2xl",children:"Закрыть период?"}),x=t.jsx("p",{className:"mt-3 text-sm text-[#6a5d52] dark:text-white/70",children:"После закрытия период будет доступен только для просмотра. Редактировать данные больше нельзя."}),e[0]=l,e[1]=x):(l=e[0],x=e[1]);let u;e[2]!==d?(u=t.jsx(se,{type:"button",onClick:d,className:"px-4 py-2",children:"Отмена"}),e[2]=d,e[3]=u):u=e[3];let n;e[4]!==a||e[5]!==i?(n=t.jsx(se,{type:"button",onClick:i,tone:"success",className:"px-4 py-2",disabled:a,children:"Закрыть"}),e[4]=a,e[5]=i,e[6]=n):n=e[6];let o;return e[7]!==u||e[8]!==n?(o=t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6",children:t.jsxs("div",{className:"w-full max-w-xl rounded-lg border border-black/10 bg-white/95 p-6 text-[#1c1a17] shadow-[0_24px_60px_-28px_rgba(0,0,0,0.7)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white",children:[l,x,t.jsxs("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:[u,n]})]})}),e[7]=u,e[8]=n,e[9]=o):o=e[9],o},Yt=c=>{const e=ee.c(14),{currentTitle:i,onConfirm:d,onCancel:s,confirmDisabled:a}=c,l=a===void 0?!1:a;let x;e[0]===Symbol.for("react.memo_cache_sentinel")?(x=t.jsx("h3",{className:"font-display text-2xl",children:"Закрепить другой период?"}),e[0]=x):x=e[0];const u=i?`Сейчас закреплён период ${i}. Закрепить этот вместо него?`:"Сейчас уже есть закреплённый период. Закрепить этот вместо него?";let n;e[1]!==u?(n=t.jsx("p",{className:"mt-3 text-sm text-[#6a5d52] dark:text-white/70",children:u}),e[1]=u,e[2]=n):n=e[2];let o;e[3]!==s?(o=t.jsx(se,{type:"button",onClick:s,className:"px-4 py-2",children:"Отмена"}),e[3]=s,e[4]=o):o=e[4];let h;e[5]!==l||e[6]!==d?(h=t.jsx(se,{type:"button",onClick:d,tone:"success",className:"px-4 py-2",disabled:l,children:"Закрепить"}),e[5]=l,e[6]=d,e[7]=h):h=e[7];let y;e[8]!==o||e[9]!==h?(y=t.jsxs("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:[o,h]}),e[8]=o,e[9]=h,e[10]=y):y=e[10];let m;return e[11]!==n||e[12]!==y?(m=t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6",children:t.jsxs("div",{className:"w-full max-w-xl rounded-lg border border-black/10 bg-white/95 p-6 text-[#1c1a17] shadow-[0_24px_60px_-28px_rgba(0,0,0,0.7)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white",children:[x,n,y]})}),e[11]=n,e[12]=y,e[13]=m):m=e[13],m},es=c=>{const e=ee.c(3),{href:i}=c;let d;e[0]===Symbol.for("react.memo_cache_sentinel")?(d=t.jsxs("div",{className:"flex items-start justify-between gap-4",children:[t.jsx(ne,{children:"Ежедневные траты"}),t.jsx(se,{as:"span",children:"Перейти к дневным значениям"})]}),e[0]=d):d=e[0];let s;return e[1]!==i?(s=t.jsx(Ve,{href:i,prefetch:!0,className:"group rounded-lg border border-[#1e7b4f]/30 bg-white/90 px-5 py-4 text-sm text-[#1c1a17] shadow-[0_24px_48px_-28px_rgba(30,123,79,0.55)] transition hover:-translate-y-0.5 hover:shadow-[0_28px_60px_-30px_rgba(30,123,79,0.65)] dark:border-[#7ce0b3]/30 dark:bg-white/10 dark:text-white",children:d}),e[1]=i,e[2]=s):s=e[2],s},He=c=>{const e=ee.c(2),{className:i}=c,d=`h-px w-full bg-black/10 dark:bg-white/10 ${i??""}`;let s;return e[0]!==d?(s=t.jsx("div",{className:d}),e[0]=d,e[1]=s):s=e[1],s},xt=c=>{const e=ee.c(3),{children:i,className:d}=c,s=`flex flex-wrap items-center gap-2 text-xs font-semibold sm:text-sm ${d??""}`;let a;return e[0]!==i||e[1]!==s?(a=t.jsx("div",{className:s,children:i}),e[0]=i,e[1]=s,e[2]=a):a=e[2],a},oe=c=>{const e=ee.c(3),{children:i,className:d}=c,s=`inline-flex items-center font-display tabular-nums leading-[0.9] ${d??""}`;let a;return e[0]!==i||e[1]!==s?(a=t.jsx("span",{className:s,children:i}),e[0]=i,e[1]=s,e[2]=a):a=e[2],a},ge=c=>{const e=ee.c(3),{children:i,className:d}=c,s=`inline-flex items-center leading-[0.9] relative -top-[1px] text-black/50 dark:text-white/60 ${d??""}`;let a;return e[0]!==i||e[1]!==s?(a=t.jsx("span",{className:s,children:i}),e[0]=i,e[1]=s,e[2]=a):a=e[2],a},ts=c=>{const e=ee.c(46),{plannedPeriodSum:i,totalDifference:d,totalDailyExpenses:s,unforeseenOverrun:a,actualRemaining:l,unforeseenRemaining:x,dailyActualAverage:u}=c;let n;e[0]===Symbol.for("react.memo_cache_sentinel")?(n=t.jsx(ne,{tooltipText:"Планируемый остаток +/− фактическая разница − ежедневные траты за период − перерасход непредвиденных (если есть).",tooltipAriaLabel:"Формула фактического остатка",children:"Фактический остаток"}),e[0]=n):n=e[0];let o;e[1]!==i?(o=Y(i),e[1]=i,e[2]=o):o=e[2];let h;e[3]!==o?(h=t.jsx(oe,{className:"text-[#1e7b4f] dark:text-[#7ce0b3]",children:o}),e[3]=o,e[4]=h):h=e[4];const y=`${d>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":d<0?"text-[#b0352b] dark:text-[#ff8b7c]":"text-[#6a5d52] dark:text-white/70"}`;let m;if(e[5]!==d){let Z;e[7]===Symbol.for("react.memo_cache_sentinel")?(Z=/^([+−-])/,e[7]=Z):Z=e[7],m=be(d).replace(Z,"$1 "),e[5]=d,e[6]=m}else m=e[6];let v;e[8]!==y||e[9]!==m?(v=t.jsx(oe,{className:y,children:m}),e[8]=y,e[9]=m,e[10]=v):v=e[10];let g;e[11]===Symbol.for("react.memo_cache_sentinel")?(g=t.jsx(ge,{children:"−"}),e[11]=g):g=e[11];let b;e[12]!==s?(b=Y(s),e[12]=s,e[13]=b):b=e[13];let p;e[14]!==b?(p=t.jsx(oe,{className:"text-[#b0352b] dark:text-[#ff8b7c]",children:b}),e[14]=b,e[15]=p):p=e[15];let w;e[16]!==a?(w=a>0&&t.jsxs(t.Fragment,{children:[t.jsx(ge,{children:"−"}),t.jsx(oe,{className:"text-[#b0352b] dark:text-[#ff8b7c]",children:Y(a)})]}),e[16]=a,e[17]=w):w=e[17];let j;e[18]===Symbol.for("react.memo_cache_sentinel")?(j=t.jsx(ge,{children:"="}),e[18]=j):j=e[18];const N=`text-2xl ${i+d-s-a>=0?"text-[#1e7b4f] dark:text-[#7ce0b3]":"text-[#b0352b] dark:text-[#ff8b7c]"}`;let k;e[19]!==l?(k=be(l),e[19]=l,e[20]=k):k=e[20];let D;e[21]!==N||e[22]!==k?(D=t.jsx(oe,{className:N,children:k}),e[21]=N,e[22]=k,e[23]=D):D=e[23];let S;e[24]!==w||e[25]!==D||e[26]!==h||e[27]!==v||e[28]!==p?(S=t.jsxs(xt,{className:"mt-3",children:[h,v,g,p,w,j,D]}),e[24]=w,e[25]=D,e[26]=h,e[27]=v,e[28]=p,e[29]=S):S=e[29];let I,R;e[30]===Symbol.for("react.memo_cache_sentinel")?(I=t.jsx(He,{className:"mt-3"}),R=t.jsx(ne,{className:"mt-4",tooltipText:"Фактический остаток + остаток с непредвиденных.",tooltipAriaLabel:"Сумма остатков",children:"Остаток средств"}),e[30]=I,e[31]=R):(I=e[30],R=e[31]);const T=l+x;let $;e[32]!==T?($=be(T),e[32]=T,e[33]=$):$=e[33];let C;e[34]!==$?(C=t.jsx(De,{className:"mt-2 text-base text-[#1e7b4f] dark:text-[#7ce0b3]",children:$}),e[34]=$,e[35]=C):C=e[35];let H,Q;e[36]===Symbol.for("react.memo_cache_sentinel")?(H=t.jsx(He,{className:"mt-4"}),Q=t.jsx(ne,{className:"mt-4",children:"Фактическое среднее в день за период"}),e[36]=H,e[37]=Q):(H=e[36],Q=e[37]);let F;e[38]!==u?(F=Y(u),e[38]=u,e[39]=F):F=e[39];let O;e[40]!==F?(O=t.jsx(De,{className:"mt-2",children:F}),e[40]=F,e[41]=O):O=e[41];let L;return e[42]!==S||e[43]!==C||e[44]!==O?(L=t.jsxs("div",{className:"rounded-lg border border-black/10 bg-white/85 px-5 py-6 text-[#1c1a17] shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white dark:shadow-[0_20px_40px_-26px_rgba(0,0,0,0.7)]",children:[n,S,I,R,C,H,Q,O]}),e[42]=S,e[43]=C,e[44]=O,e[45]=L):L=e[45],L},ss=c=>{const e=ee.c(69),{title:i,items:d,setItems:s,showDelete:a,onToggleDelete:l,totalLabel:x,totalPlanned:u,totalActual:n,totalDifference:o,idPrefix:h,onBlurField:y,onAfterDelete:m,readOnly:v,containerRef:g,addRowTargetRef:b}=c,p=v===void 0?!1:v;let w;e[0]!==i?(w=t.jsx(ne,{children:i}),e[0]=i,e[1]=w):w=e[1];let j;e[2]!==h||e[3]!==s?(j=()=>s(A=>[...A,{id:`${h}${Date.now()}`,name:"",plannedAmount:"",actualAmount:"",actualTouched:!1}]),e[2]=h,e[3]=s,e[4]=j):j=e[4];let N;e[5]!==p||e[6]!==j?(N=t.jsx(se,{type:"button",onClick:j,disabled:p,children:"+ Строка"}),e[5]=p,e[6]=j,e[7]=N):N=e[7];let k;e[8]!==b||e[9]!==N?(k=t.jsx("div",{ref:b,children:N}),e[8]=b,e[9]=N,e[10]=k):k=e[10];let D;e[11]!==l||e[12]!==p||e[13]!==a?(D=t.jsx(se,{type:"button",onClick:l,active:a,activeTone:"danger",disabled:p,children:"− Удаление"}),e[11]=l,e[12]=p,e[13]=a,e[14]=D):D=e[14];let S;e[15]!==k||e[16]!==D?(S=t.jsxs("div",{className:"flex items-center gap-2",children:[k,D]}),e[15]=k,e[16]=D,e[17]=S):S=e[17];let I;e[18]!==w||e[19]!==S?(I=t.jsxs("div",{className:"flex items-center justify-between",children:[w,S]}),e[18]=w,e[19]=S,e[20]=I):I=e[20];const R=`mt-3 grid items-center gap-2 text-[11px] uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60 ${a?"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)]"}`;let T,$,C;e[21]===Symbol.for("react.memo_cache_sentinel")?(T=t.jsxs("span",{children:[t.jsx("span",{className:"sm:hidden",children:"Название"}),t.jsx("span",{className:"hidden sm:inline",children:"Название"})]}),$=t.jsx("span",{className:"text-right",children:"План"}),C=t.jsx("span",{className:"text-right",children:"Факт"}),e[21]=T,e[22]=$,e[23]=C):(T=e[21],$=e[22],C=e[23]);let H;e[24]===Symbol.for("react.memo_cache_sentinel")?(H=t.jsxs("span",{className:"text-right",children:[t.jsx("span",{className:"sm:hidden",children:"Разн"}),t.jsx("span",{className:"hidden sm:inline",children:"Разница"})]}),e[24]=H):H=e[24];let Q;e[25]!==a?(Q=a&&t.jsx("span",{className:"text-center",children:"—"}),e[25]=a,e[26]=Q):Q=e[26];let F;e[27]!==Q||e[28]!==R?(F=t.jsxs("div",{className:R,children:[T,$,C,H,Q]}),e[27]=Q,e[28]=R,e[29]=F):F=e[29];let O;e[30]!==d||e[31]!==m||e[32]!==y||e[33]!==p||e[34]!==s||e[35]!==a?(O=d.map((A,fe)=>{const ke=d.filter(z=>z.id!==A.id).map(as);return t.jsxs("div",{className:`grid items-center gap-2 ${a?"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)]"}`,children:[t.jsx(mt,{value:A.name,placeholder:`Трата ${fe+1}`,disabled:p,usedNames:ke,onChange:z=>s(P=>P.map(ie=>ie.id===A.id?{...ie,name:z}:ie)),onBlur:y}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:A.plannedAmount,disabled:p,onChange:z=>{const P=z.target.value;s(ie=>ie.map(te=>te.id===A.id?{...te,plannedAmount:Ne(P),actualAmount:te.actualTouched?te.actualAmount:Ne(P)}:te))},onFocus:()=>{A.plannedAmount===0&&s(z=>z.map(P=>P.id===A.id?{...P,plannedAmount:""}:P))},onBlur:()=>{A.plannedAmount===""&&s(z=>z.map(P=>P.id===A.id?{...P,plannedAmount:0}:P)),y()},className:"no-spin rounded-lg border border-black/10 bg-white/90 px-3 py-2 text-xs text-right tabular-nums dark:border-white/10 dark:bg-white/10 sm:px-4 sm:text-sm"}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:A.actualAmount,disabled:p,onChange:z=>{const P=z.target.value;s(ie=>ie.map(te=>te.id===A.id?{...te,actualAmount:Ne(P),actualTouched:!0}:te))},onFocus:()=>{A.actualAmount===0&&s(z=>z.map(P=>P.id===A.id?{...P,actualAmount:""}:P))},onBlur:()=>{A.actualAmount===""&&s(z=>z.map(P=>P.id===A.id?{...P,actualAmount:0}:P)),y()},className:"no-spin rounded-lg border border-black/10 bg-white/90 px-3 py-2 text-xs text-right tabular-nums dark:border-white/10 dark:bg-white/10 sm:px-4 sm:text-sm"}),t.jsx("div",{className:`flex min-h-[36px] items-center justify-end px-0 py-2 text-xs tabular-nums sm:min-h-[40px] sm:px-4 sm:text-sm ${A.plannedAmount-A.actualAmount>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":A.plannedAmount-A.actualAmount<0?"text-[#b0352b] dark:text-[#ff8b7c]":"text-[#6a5d52] dark:text-white/70"}`,children:be(A.plannedAmount-A.actualAmount)}),a&&t.jsx("button",{type:"button",onClick:()=>{window.confirm("Удалить строку?")&&(s(z=>z.filter(P=>P.id!==A.id)),m())},"aria-label":`Удалить трату ${fe+1}`,className:"flex h-8 w-8 items-center justify-center rounded-full text-xs text-[#b0352b] transition hover:bg-[#b0352b]/10 dark:text-[#ff8b7c] dark:hover:bg-[#ff8b7c]/15",disabled:p,children:"—"})]},A.id)}),e[30]=d,e[31]=m,e[32]=y,e[33]=p,e[34]=s,e[35]=a,e[36]=O):O=e[36];let L;e[37]!==O?(L=t.jsx("div",{className:"mt-3 grid gap-2",children:O}),e[37]=O,e[38]=L):L=e[38];const Z=`mt-3 grid items-center gap-2 rounded-lg border border-dashed border-black/10 bg-white/70 px-4 py-2 text-xs dark:border-white/10 dark:bg-white/5 ${a?"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_minmax(0,0.7fr)_minmax(0,0.7fr)]"}`;let X;e[39]!==x?(X=t.jsx("span",{children:x}),e[39]=x,e[40]=X):X=e[40];let M;e[41]!==u?(M=Y(u),e[41]=u,e[42]=M):M=e[42];let K;e[43]!==M?(K=t.jsx("span",{className:"text-right font-display text-sm tabular-nums",children:M}),e[43]=M,e[44]=K):K=e[44];let ae;e[45]!==n?(ae=Y(n),e[45]=n,e[46]=ae):ae=e[46];let V;e[47]!==ae?(V=t.jsx("span",{className:"text-right font-display text-sm tabular-nums",children:ae}),e[47]=ae,e[48]=V):V=e[48];const U=`text-right font-display text-sm tabular-nums ${o>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":o<0?"text-[#b0352b] dark:text-[#ff8b7c]":"text-[#6a5d52] dark:text-white/70"}`;let W;e[49]!==o?(W=be(o),e[49]=o,e[50]=W):W=e[50];let q;e[51]!==U||e[52]!==W?(q=t.jsx("span",{className:U,children:W}),e[51]=U,e[52]=W,e[53]=q):q=e[53];let ce;e[54]!==a?(ce=a&&t.jsx("span",{}),e[54]=a,e[55]=ce):ce=e[55];let le;e[56]!==Z||e[57]!==X||e[58]!==K||e[59]!==V||e[60]!==q||e[61]!==ce?(le=t.jsxs("div",{className:Z,children:[X,K,V,q,ce]}),e[56]=Z,e[57]=X,e[58]=K,e[59]=V,e[60]=q,e[61]=ce,e[62]=le):le=e[62];let me;return e[63]!==g||e[64]!==F||e[65]!==L||e[66]!==le||e[67]!==I?(me=t.jsxs("div",{ref:g,className:"rounded-lg border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[I,F,L,le]}),e[63]=g,e[64]=F,e[65]=L,e[66]=le,e[67]=I,e[68]=me):me=e[68],me};function as(c){return c.name}const ns=c=>{const e=ee.c(50),{items:i,setItems:d,totalAmount:s,onAdd:a,showDelete:l,onToggleDelete:x,onBlurField:u,onAfterDelete:n,invalidNameIds:o,readOnly:h,containerRef:y,addRowTargetRef:m,guidedIncomeId:v,guidedRowTargetRef:g}=c,b=h===void 0?!1:h;let p;e[0]===Symbol.for("react.memo_cache_sentinel")?(p=t.jsx(ne,{children:"Приход"}),e[0]=p):p=e[0];let w;e[1]!==a||e[2]!==b?(w=t.jsx(se,{type:"button",onClick:a,disabled:b,children:"+ Строка"}),e[1]=a,e[2]=b,e[3]=w):w=e[3];let j;e[4]!==m||e[5]!==w?(j=t.jsx("div",{ref:m,children:w}),e[4]=m,e[5]=w,e[6]=j):j=e[6];let N;e[7]!==x||e[8]!==b||e[9]!==l?(N=t.jsx(se,{type:"button",onClick:x,active:l,activeTone:"danger",disabled:b,children:"− Удаление"}),e[7]=x,e[8]=b,e[9]=l,e[10]=N):N=e[10];let k;e[11]!==j||e[12]!==N?(k=t.jsxs("div",{className:"flex items-center justify-between",children:[p,t.jsxs("div",{className:"flex items-center gap-2",children:[j,N]})]}),e[11]=j,e[12]=N,e[13]=k):k=e[13];const D=`mt-3 hidden items-center gap-2 text-[11px] uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60 sm:grid ${l?"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)]"}`;let S,I;e[14]===Symbol.for("react.memo_cache_sentinel")?(S=t.jsx("span",{children:"Название"}),I=t.jsx("span",{className:"text-right",children:"Сумма"}),e[14]=S,e[15]=I):(S=e[14],I=e[15]);let R;e[16]!==l?(R=l&&t.jsx("span",{className:"text-center",children:"—"}),e[16]=l,e[17]=R):R=e[17];let T;e[18]!==R||e[19]!==D?(T=t.jsxs("div",{className:D,children:[S,I,R]}),e[18]=R,e[19]=D,e[20]=T):T=e[20];let $;e[21]!==v||e[22]!==g||e[23]!==o||e[24]!==i||e[25]!==n||e[26]!==u||e[27]!==b||e[28]!==d||e[29]!==l?($=i.map((M,K)=>{const ae=i.filter(V=>V.id!==M.id).map(rs);return t.jsxs("div",{ref:v&&M.id===v?g:void 0,className:`grid items-center gap-2 ${l?"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)]"}`,children:[t.jsx(mt,{value:M.name,placeholder:`Приход ${K+1}`,disabled:b,usedNames:ae,onChange:V=>d(U=>U.map(W=>W.id===M.id?{...W,name:V}:W)),onBlur:u,containerClassName:o.includes(M.id)?"border-[#b0352b] dark:border-[#ff8b7c]":""}),t.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:M.amount,disabled:b,onChange:V=>{const U=V.target.value;d(W=>W.map(q=>q.id===M.id?{...q,amount:Ne(U)}:q))},onFocus:()=>{M.amount===0&&d(V=>V.map(U=>U.id===M.id?{...U,amount:""}:U))},onBlur:()=>{M.amount===""&&d(V=>V.map(U=>U.id===M.id?{...U,amount:0}:U)),u()},className:"no-spin rounded-lg border border-black/10 bg-white/90 px-3 py-2 text-xs text-right tabular-nums dark:border-white/10 dark:bg-white/10 sm:px-4 sm:text-sm"}),l&&t.jsx("button",{type:"button",onClick:()=>{window.confirm("Удалить строку?")&&(d(V=>V.filter(U=>U.id!==M.id)),n())},"aria-label":`Удалить приход ${K+1}`,className:"flex h-8 w-8 items-center justify-center rounded-full text-xs text-[#b0352b] transition hover:bg-[#b0352b]/10 dark:text-[#ff8b7c] dark:hover:bg-[#ff8b7c]/15",disabled:b,children:"—"})]},M.id)}),e[21]=v,e[22]=g,e[23]=o,e[24]=i,e[25]=n,e[26]=u,e[27]=b,e[28]=d,e[29]=l,e[30]=$):$=e[30];let C;e[31]!==$?(C=t.jsx("div",{className:"mt-3 grid gap-2",children:$}),e[31]=$,e[32]=C):C=e[32];const H=`mt-3 grid items-center gap-2 rounded-lg border border-dashed border-black/10 bg-white/70 px-4 py-2 text-xs dark:border-white/10 dark:bg-white/5 ${l?"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)_auto]":"grid-cols-[minmax(0,1.2fr)_minmax(0,0.7fr)]"}`;let Q;e[33]===Symbol.for("react.memo_cache_sentinel")?(Q=t.jsx("span",{children:"Итого прихода"}),e[33]=Q):Q=e[33];let F;e[34]!==s?(F=Y(s),e[34]=s,e[35]=F):F=e[35];let O;e[36]!==F?(O=t.jsx("span",{className:"text-right font-display text-sm tabular-nums",children:F}),e[36]=F,e[37]=O):O=e[37];let L;e[38]!==l?(L=l&&t.jsx("span",{}),e[38]=l,e[39]=L):L=e[39];let Z;e[40]!==H||e[41]!==O||e[42]!==L?(Z=t.jsxs("div",{className:H,children:[Q,O,L]}),e[40]=H,e[41]=O,e[42]=L,e[43]=Z):Z=e[43];let X;return e[44]!==y||e[45]!==T||e[46]!==C||e[47]!==Z||e[48]!==k?(X=t.jsxs("div",{ref:y,className:"rounded-lg border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[k,T,C,Z]}),e[44]=y,e[45]=T,e[46]=C,e[47]=Z,e[48]=k,e[49]=X):X=e[49],X};function rs(c){return c.name}const ls=c=>{const e=ee.c(41),{dailyAverage:i,days:d,totalIncome:s,totalPlannedExpenses:a,totalUnforeseenAllocated:l,plannedPeriodSum:x}=c;let u;e[0]===Symbol.for("react.memo_cache_sentinel")?(u=t.jsx(ne,{tooltipText:"Приход − план обязательных − выделено на непредвиденные = сумма в период",children:"Планируемая сумма на период"}),e[0]=u):u=e[0];let n;e[1]!==s?(n=Y(s),e[1]=s,e[2]=n):n=e[2];let o;e[3]!==n?(o=t.jsx(oe,{className:"text-[#1e7b4f] dark:text-[#7ce0b3]",children:n}),e[3]=n,e[4]=o):o=e[4];let h;e[5]===Symbol.for("react.memo_cache_sentinel")?(h=t.jsx(ge,{children:"−"}),e[5]=h):h=e[5];let y;e[6]!==a?(y=Y(a),e[6]=a,e[7]=y):y=e[7];let m;e[8]!==y?(m=t.jsx(oe,{className:"text-[#b0352b] dark:text-[#ff8b7c]",children:y}),e[8]=y,e[9]=m):m=e[9];let v;e[10]===Symbol.for("react.memo_cache_sentinel")?(v=t.jsx(ge,{children:"−"}),e[10]=v):v=e[10];let g;e[11]!==l?(g=Y(l),e[11]=l,e[12]=g):g=e[12];let b;e[13]!==g?(b=t.jsx(oe,{className:"text-[#b0352b] dark:text-[#ff8b7c]",children:g}),e[13]=g,e[14]=b):b=e[14];let p;e[15]===Symbol.for("react.memo_cache_sentinel")?(p=t.jsx(ge,{children:"="}),e[15]=p):p=e[15];const w=`text-2xl ${x>=0?"text-[#1e7b4f] dark:text-[#7ce0b3]":"text-[#b0352b] dark:text-[#ff8b7c]"}`;let j;e[16]!==x?(j=be(x),e[16]=x,e[17]=j):j=e[17];let N;e[18]!==w||e[19]!==j?(N=t.jsx(oe,{className:w,children:j}),e[18]=w,e[19]=j,e[20]=N):N=e[20];let k;e[21]!==N||e[22]!==o||e[23]!==m||e[24]!==b?(k=t.jsxs("div",{className:"grid gap-3 text-xs text-[#6a5d52] dark:text-white/70",children:[u,t.jsxs(xt,{children:[o,h,m,v,b,p,N]})]}),e[21]=N,e[22]=o,e[23]=m,e[24]=b,e[25]=k):k=e[25];let D,S;e[26]===Symbol.for("react.memo_cache_sentinel")?(D=t.jsx(He,{className:"mt-4"}),S=t.jsx(ne,{className:"mt-4",children:"Планируемое среднее в день"}),e[26]=D,e[27]=S):(D=e[26],S=e[27]);let I;e[28]!==x?(I=Y(x),e[28]=x,e[29]=I):I=e[29];const R=d||0;let T;e[30]!==I||e[31]!==R?(T=t.jsxs("p",{className:"mt-2 text-xs text-[#6a5d52] dark:text-white/60",children:["(",I," / ",R," д.)"]}),e[30]=I,e[31]=R,e[32]=T):T=e[32];let $;e[33]!==i?($=Y(i),e[33]=i,e[34]=$):$=e[34];let C;e[35]!==$?(C=t.jsx(De,{className:"mt-3",children:$}),e[35]=$,e[36]=C):C=e[36];let H;return e[37]!==k||e[38]!==T||e[39]!==C?(H=t.jsxs("div",{className:"rounded-lg border border-black/10 bg-white/85 px-5 py-6 text-[#1c1a17] shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white dark:shadow-[0_20px_40px_-26px_rgba(0,0,0,0.7)]",children:[k,D,S,T,C]}),e[37]=k,e[38]=T,e[39]=C,e[40]=H):H=e[40],H},is=c=>{const e=ee.c(3),{children:i,className:d}=c,s=`mt-2 text-xs text-[#6a5d52] dark:text-white/60 ${d??""}`;let a;return e[0]!==i||e[1]!==s?(a=t.jsx("p",{className:s,children:i}),e[0]=i,e[1]=s,e[2]=a):a=e[2],a},ds=c=>{const e=ee.c(13),{actualRemaining:i,remainingDays:d,remainingDailyAverage:s}=c;let a;e[0]===Symbol.for("react.memo_cache_sentinel")?(a=t.jsx(ne,{tooltipText:"Фактический остаток / количество незаполненных (непрошедших) дней",children:"Расчётное в день на оставшиеся дни"}),e[0]=a):a=e[0];let l;e[1]!==i?(l=Y(i),e[1]=i,e[2]=l):l=e[2];const x=d||0;let u;e[3]!==l||e[4]!==x?(u=t.jsxs(is,{children:["(",l," / ",x," д.)"]}),e[3]=l,e[4]=x,e[5]=u):u=e[5];let n;e[6]!==s?(n=Y(s),e[6]=s,e[7]=n):n=e[7];let o;e[8]!==n?(o=t.jsx(De,{className:"mt-3",children:n}),e[8]=n,e[9]=o):o=e[9];let h;return e[10]!==u||e[11]!==o?(h=t.jsxs("div",{className:"rounded-lg border border-black/10 bg-white/85 px-5 py-6 text-[#1c1a17] shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white dark:shadow-[0_20px_40px_-26px_rgba(0,0,0,0.7)]",children:[a,u,o]}),e[10]=u,e[11]=o,e[12]=h):h=e[12],h},os=c=>{const e=ee.c(26),{days:i,startDate:d,endDate:s,isEditing:a,readOnly:l,onToggleEditing:x,onStartDateChange:u,onEndDateChange:n,minStartDate:o,maxStartDate:h,minEndDate:y,maxEndDate:m}=c;let v;e[0]===Symbol.for("react.memo_cache_sentinel")?(v=t.jsx(ne,{children:"Дни периода"}),e[0]=v):v=e[0];const g=a?"Готово":"Редактировать";let b;e[1]!==a||e[2]!==x||e[3]!==l||e[4]!==g?(b=t.jsxs("div",{className:"flex items-center justify-between",children:[v,t.jsx(se,{type:"button",onClick:x,active:a,activeTone:"success",disabled:l,children:g})]}),e[1]=a,e[2]=x,e[3]=l,e[4]=g,e[5]=b):b=e[5];let p;e[6]!==i?(p=t.jsx("div",{className:"px-1 text-base font-semibold tabular-nums",children:i}),e[6]=i,e[7]=p):p=e[7];let w;e[8]===Symbol.for("react.memo_cache_sentinel")?(w=t.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:"дней"}),e[8]=w):w=e[8];let j;e[9]!==p?(j=t.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[p,w]}),e[9]=p,e[10]=j):j=e[10];let N;e[11]!==s||e[12]!==a||e[13]!==m||e[14]!==h||e[15]!==y||e[16]!==o||e[17]!==n||e[18]!==u||e[19]!==l||e[20]!==d?(N=a&&t.jsxs("div",{className:"mt-3 grid gap-2 grid-cols-2",children:[t.jsxs("label",{className:"grid gap-1 text-xs text-[#6a5d52] dark:text-white/60",children:["Начало",t.jsx("input",{type:"date",value:d,disabled:l,onChange:D=>u(D.target.value),min:o,max:h,className:"rounded-lg border border-black/10 bg-white/90 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/10 sm:text-sm"})]}),t.jsxs("label",{className:"grid gap-1 text-xs text-[#6a5d52] dark:text-white/60",children:["Конец",t.jsx("input",{type:"date",value:s,disabled:l,onChange:D=>n(D.target.value),min:y,max:m,className:"rounded-lg border border-black/10 bg-white/90 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/10 sm:text-sm"})]})]}),e[11]=s,e[12]=a,e[13]=m,e[14]=h,e[15]=y,e[16]=o,e[17]=n,e[18]=u,e[19]=l,e[20]=d,e[21]=N):N=e[21];let k;return e[22]!==b||e[23]!==j||e[24]!==N?(k=t.jsxs("div",{className:"rounded-lg border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[b,j,N]}),e[22]=b,e[23]=j,e[24]=N,e[25]=k):k=e[25],k},cs=c=>{const e=ee.c(22),{href:i,allocated:d,spent:s}=c,a=d-s,l=ms;let x;e[0]===Symbol.for("react.memo_cache_sentinel")?(x=t.jsxs("div",{className:"flex items-start justify-between gap-4",children:[t.jsx(ne,{children:"Непредвиденные расходы"}),t.jsx(se,{as:"span",children:"Открыть"})]}),e[0]=x):x=e[0];let u;e[1]===Symbol.for("react.memo_cache_sentinel")?(u=t.jsx("div",{className:"uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60",children:"Выделено"}),e[1]=u):u=e[1];let n;e[2]!==d?(n=Y(d),e[2]=d,e[3]=n):n=e[3];let o;e[4]!==n?(o=t.jsxs("div",{children:[u,t.jsx("div",{className:"mt-1 font-display text-sm tabular-nums text-[#1c1a17] dark:text-[#ffffff]",children:n})]}),e[4]=n,e[5]=o):o=e[5];let h;e[6]===Symbol.for("react.memo_cache_sentinel")?(h=t.jsx("div",{className:"uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60",children:"Потрачено"}),e[6]=h):h=e[6];let y;e[7]!==s?(y=Y(s),e[7]=s,e[8]=y):y=e[8];let m;e[9]!==y?(m=t.jsxs("div",{children:[h,t.jsx("div",{className:"mt-1 font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:y})]}),e[9]=y,e[10]=m):m=e[10];let v;e[11]===Symbol.for("react.memo_cache_sentinel")?(v=t.jsx("div",{className:"uppercase tracking-[0.2em] text-[#6a5d52] dark:text-white/60",children:"Разница"}),e[11]=v):v=e[11];const g=`mt-1 font-display text-sm tabular-nums ${a<0?"text-[#b0352b] dark:text-[#ff8b7c]":"text-[#1e7b4f] dark:text-[#7ce0b3]"}`,b=l(a);let p;e[12]!==b||e[13]!==g?(p=t.jsxs("div",{children:[v,t.jsx("div",{className:g,children:b})]}),e[12]=b,e[13]=g,e[14]=p):p=e[14];let w;e[15]!==p||e[16]!==o||e[17]!==m?(w=t.jsxs("div",{className:"mt-3 grid grid-cols-3 gap-2 text-xs",children:[o,m,p]}),e[15]=p,e[16]=o,e[17]=m,e[18]=w):w=e[18];let j;return e[19]!==i||e[20]!==w?(j=t.jsxs(Ve,{href:i,prefetch:!0,className:"group rounded-lg border border-[#b0352b]/30 bg-white/90 px-5 py-4 text-sm text-[#1c1a17] shadow-[0_24px_48px_-28px_rgba(176,53,43,0.45)] transition hover:-translate-y-0.5 hover:shadow-[0_28px_60px_-30px_rgba(176,53,43,0.6)] dark:border-[#ff8b7c]/30 dark:bg-white/10 dark:text-white",children:[x,w]}),e[19]=i,e[20]=w,e[21]=j):j=e[21],j};function ms(c){const e=Math.round(c),i=Math.abs(e).toLocaleString("ru-RU");return e<0?`−${i} ₽`:`+${i} ₽`}const xs={id:0,startDate:"",endDate:"",incomes:[],expenses:[],unforeseenExpenses:[],unforeseenAllocated:0,offIncomeExpenses:[],dailyExpenses:{},isPinned:!1,isClosed:!1};function As(){const{periodId:c,viewerId:e,viewerName:i,viewerEmail:d,viewerMode:s,onboardingMode:a}=Ot().props,l=!!(e??s),x=!!a,u=x?Kt:Bt,[n,o]=f.useState(xs),[h,y]=f.useState([]),[m,v]=f.useState(""),[g,b]=f.useState(""),[p,w]=f.useState([]),[j,N]=f.useState([]),[k,D]=f.useState(0),[S,I]=f.useState([]),[R,T]=f.useState({}),[$,C]=f.useState(!1),[H,Q]=f.useState(!1),[F,O]=f.useState(!0),[L,Z]=f.useState(null),[X,M]=f.useState(!1),[K,ae]=f.useState(null),[V,U]=f.useState(!1),[W,q]=f.useState(null),[ce,le]=f.useState([]),[me,A]=f.useState(!1),[fe,ke]=f.useState(!1),[z,P]=f.useState(!1),[ie,te]=f.useState(!1),[ft,Se]=f.useState(!1),[ut,ye]=f.useState(!1),[pt,$e]=f.useState(),[Ce,ht]=f.useState(()=>x&&!Lt()),[Ae,bt]=f.useState(null),Ee=f.useRef(!1),[qe,gt]=f.useState(0),Je="Заполните названия прихода.",ue=f.useRef(null),_e=f.useRef(null),Ke=f.useRef(null),Ie=f.useRef(null),Qe=f.useRef(null),Re=f.useRef(null),Ze=f.useRef(null),We=f.useRef(null),Xe=f.useMemo(()=>`period:${e??"self"}:${c}`,[c,e]),re=f.useMemo(()=>e?`viewer_id=${e}`:"",[e]),Pe=f.useRef(!1),Te=f.useRef(!1),yt=()=>typeof window>"u"?null:window.__periodCache?.[Xe]??null,ve=r=>{if(typeof window>"u")return;const E=window;E.__periodCache||(E.__periodCache={}),E.__periodCache[Xe]=r},{totalPlanned:Oe,totalActual:jt,totalDifference:Me}=nt(p??[]),{totalActual:Be}=nt(j??[]),wt=Math.max(0,k-Be),kt=rt(S??[]),Fe=rt(h??[]),je=f.useMemo(()=>!m||!g?0:it(m,g),[m,g]),Le=f.useMemo(()=>Vt(R),[R]),Ue=f.useMemo(()=>qt(m,g,R),[R,m,g]),_t=Ue>0?Le/Ue:0,Ye=f.useMemo(()=>!m||!g?"Период":`${he(m)} — ${he(g)}`,[m,g]),vt=f.useMemo(()=>!m||!g?"":`${je} дней · ${dt(m,g)}`,[je,m,g]),{plannedPeriodSum:et,dailyAverage:Nt,actualRemaining:tt,unforeseenOverrun:Dt,remainingDays:St,remainingDailyAverage:$t,isDailyComplete:Ct}=Jt({days:je,totalIncome:Fe,totalPlannedExpenses:Oe,totalDifference:Me,totalUnforeseenAllocated:k,totalUnforeseenSpent:Be,totalDailyExpenses:Le,filledDays:Ue}),xe=n.isClosed||l,At=f.useMemo(()=>[{stepId:"period-intro",title:"Страница периода",text:"На данной странице нужно указать информацию о доходах и планах трат. Пройдёмся по блокам.",targetRef:Ke,placement:"bottom"},{stepId:"income-block",title:"Приход",text:"Здесь указываются все приходящие суммы, из которых будут вычитаться затраты.",targetRef:Ie,placement:"right"},{stepId:"income-add",title:"Добавьте новый приход",text:"Нажмите «+ Строка», чтобы добавить строку прихода.",targetRef:Qe,placement:"bottom",captureClick:!0,advanceDelayMs:220,hideNext:!0},{stepId:"income-fill",title:"Заполните строку прихода",text:"Заполните строку и нажмите «Далее».",targetRef:Re,placement:"right"},{stepId:"income-sum",title:"Сумма прихода",text:"Добавьте ещё строки с приходом, если хотите. Они будут суммироваться автоматически.",targetRef:Ie,placement:"right"},{stepId:"mandatory-block",title:"Обязательные траты",text:"Здесь указываются траты, которые планируются на месяц. Фактическая сумма по умолчанию равна планируемой, но её можно изменить. Добавьте: маникюр, спорт зал, комуналка, бензин.",targetRef:Ze,placement:"right"},{stepId:"external-block",title:"Сторонние траты",text:"Здесь указываются траты, которые не включены в расчёт, но важно учитывать, что они были. Они не вычитаются из прихода.",targetRef:We,placement:"right"}],[]),Et=r=>!!(r&&r.id&&Array.isArray(r.incomes)&&Array.isArray(r.expenses)&&Array.isArray(r.unforeseenExpenses)&&typeof r.unforeseenAllocated=="number"&&Array.isArray(r.offIncomeExpenses)),It=async()=>{if(Te.current)return;const r=yt();if(!(Et(r)&&(o({...r,isClosed:!!r.isClosed}),y(r.incomes??[]),v(r.startDate??""),b(r.endDate??""),w(r.expenses??[]),N(r.unforeseenExpenses??[]),D(r.unforeseenAllocated??0),I(r.offIncomeExpenses??[]),T(r.dailyExpenses??{}),ue.current={startDate:r.startDate??"",endDate:r.endDate??""},O(!1),typeof navigator<"u"&&!navigator.onLine))&&!(Pe.current&&(!navigator.onLine||!r))){Te.current=!0,O(!0),Z(null);try{const B=(await u(`/api/periods/${c}${re?`?${re}`:""}`)).data,G={id:B.id,startDate:B.start_date,endDate:B.end_date,dailyExpenses:B.daily_expenses??{},unforeseenAllocated:Number(B.unforeseen_allocated??0),isPinned:!!B.is_pinned,isClosed:!!B.is_closed,incomes:B.incomes.map(J=>({id:String(J.id),name:J.name,amount:J.amount})),expenses:B.expenses.map(J=>({id:String(J.id),name:J.name,plannedAmount:J.planned_amount,actualAmount:J.actual_amount,actualTouched:!1})),unforeseenExpenses:B.unforeseen_expenses.map(J=>({id:String(J.id),name:J.name,plannedAmount:J.planned_amount,actualAmount:J.actual_amount,actualTouched:!1})),offIncomeExpenses:B.external_expenses.map(J=>({id:String(J.id),name:J.name,amount:J.amount}))};o(G),y(G.incomes),v(G.startDate),b(G.endDate),w(G.expenses),N(G.unforeseenExpenses),D(G.unforeseenAllocated),I(G.offIncomeExpenses),T(G.dailyExpenses),te(!1),$e(void 0),ue.current={startDate:G.startDate,endDate:G.endDate},ve(G),Pe.current=!0}catch(E){Z(E instanceof Error?E.message:"Не удалось загрузить период.")}finally{O(!1),Te.current=!1}}},de=async(r=!1,E)=>{if(xe)return;const B=E?.startDate??m,G=E?.endDate??g,J=lt(h);if(J.length>0){le(J),q(Je);return}if(X){Ee.current=!0;return}M(!0),q(null);try{await u(`/api/periods/${c}${re?`?${re}`:""}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({start_date:B,end_date:G,daily_expenses:R,unforeseen_allocated:k,force:r,incomes:h.filter(_=>_.name.trim()!=="").map(_=>({id:Number.isFinite(Number(_.id))?Number(_.id):void 0,name:_.name,amount:pe(_.amount)})),expenses:p.filter(_=>_.name.trim()!=="").map(_=>({id:Number.isFinite(Number(_.id))?Number(_.id):void 0,name:_.name,planned_amount:pe(_.plannedAmount),actual_amount:pe(_.actualAmount)})),unforeseen_expenses:j.filter(_=>_.name.trim()!=="").map(_=>({id:Number.isFinite(Number(_.id))?Number(_.id):void 0,name:_.name,planned_amount:pe(_.plannedAmount),actual_amount:pe(_.actualAmount)})),external_expenses:S.filter(_=>_.name.trim()!=="").map(_=>({id:Number.isFinite(Number(_.id))?Number(_.id):void 0,name:_.name,amount:pe(_.amount)}))})}),v(B),b(G),ae(null),U(!1),_e.current=null,ue.current={startDate:B,endDate:G},ve({id:Number(c),startDate:B,endDate:G,incomes:h,expenses:p,unforeseenExpenses:j,unforeseenAllocated:k,offIncomeExpenses:S,dailyExpenses:R,isPinned:n.isPinned,isClosed:n.isClosed})}catch(_){if(we(_)&&_.status===419){ye(!0);return}if(we(_)&&_.status===409&&_.data&&typeof _.data=="object"){const at=_.data.overlap;if(at){_e.current={startDate:B,endDate:G},ae(at),U(!0),ue.current&&(v(ue.current.startDate),b(ue.current.endDate));return}}q(_ instanceof Error?_.message:"Не удалось сохранить период.")}finally{M(!1)}},Rt=()=>{if(xe)return;const r=`i${Date.now()}`;y(E=>[...E,{id:r,name:"",amount:""}]),bt(r),de()},ze=()=>{gt(r=>r+1)},Pt=async()=>{if(!l&&!me&&window.confirm("Удалить период?")){A(!0),q(null);try{await u(`/api/periods/${c}${re?`?${re}`:""}`,{method:"DELETE"}),window.location.href=e?`/shared/${e}`:ct().url}catch(r){if(we(r)&&r.status===419){ye(!0);return}q(r instanceof Error?r.message:"Не удалось удалить период.")}finally{A(!1)}}},Tt=async()=>{if(!(l||z||n.isClosed)){P(!0),q(null);try{const r=await u(`/api/periods/${c}/close${re?`?${re}`:""}`,{method:"POST"}),E={...n,isClosed:r.data?.is_closed??!0};o(E),Se(!1),ve({id:Number(c),startDate:m,endDate:g,incomes:h,expenses:p,unforeseenExpenses:j,unforeseenAllocated:k,offIncomeExpenses:S,dailyExpenses:R,isPinned:n.isPinned,isClosed:E.isClosed})}catch(r){if(we(r)&&r.status===419){ye(!0);return}q(r instanceof Error?r.message:"Не удалось закрыть период.")}finally{P(!1)}}},st=async(r=!1)=>{if(!(l||fe)){ke(!0);try{const B=(await u(`/api/periods/${c}/pin${re?`?${re}`:""}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pinned:!n.isPinned,force:r})})).data?.is_pinned??!n.isPinned,G={...n,isPinned:B};o(G),ve(G),te(!1)}catch(E){if(we(E)){if(E.status===419){ye(!0);return}if(E.status===409&&E.data&&typeof E.data=="object"){const B=E.data.pinned;$e(B?`${he(B.start_date)} — ${he(B.end_date)}`:void 0),te(!0);return}}q(E instanceof Error?E.message:"Не удалось изменить закрепление периода.")}finally{ke(!1)}}};return f.useEffect(()=>{Pe.current=!1,It()},[c,e]),f.useEffect(()=>{!X&&Ee.current&&(Ee.current=!1,de())},[X]),f.useEffect(()=>{qe>0&&de()},[qe]),f.useEffect(()=>{const r=lt(h);le(r),r.length===0&&W===Je&&q(null)},[h,W]),f.useEffect(()=>{if(!Ae||!Ce)return;const r=window.setTimeout(()=>{const E=Re.current?.querySelector("input");if(E instanceof HTMLInputElement){E.focus();return}},140);return()=>window.clearTimeout(r)},[Ae,Ce]),t.jsxs(Zt,{hideHeader:x,children:[t.jsx(Mt,{title:Ye}),x&&t.jsx(Ut,{}),t.jsxs("div",{className:`relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-3 font-body text-[#1c1a17] dark:text-[#f7f3ee]${n.isClosed?" bg-emerald-50/70 dark:bg-emerald-950/20":""}${x?" pt-16":""}`,children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsxs("section",{ref:Ke,className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Период"}),t.jsx("h1",{className:"mt-3 font-display text-3xl",children:Ye}),t.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:vt})]}),n.isClosed&&t.jsx("div",{className:"flex-1 text-center text-sm font-semibold text-emerald-600 dark:text-emerald-300",children:"Период закрыт"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[!l&&!n.isClosed&&t.jsx(se,{type:"button",onClick:()=>st(!1),tone:n.isPinned?"danger":"success",disabled:fe,className:"px-4 py-2",children:n.isPinned?"Открепить":"Закрепить"}),!l&&Ct&&!n.isClosed&&t.jsx(se,{type:"button",onClick:()=>Se(!0),disabled:z,tone:"success",className:"px-4 py-2",children:"Закрыть период"}),!l&&t.jsx(se,{type:"button",onClick:Pt,disabled:me,tone:"danger",className:"px-4 py-2",children:"Удалить"}),t.jsx(Ve,{href:e?`/shared/${e}`:x?"/onboarding":ct(),prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← Ко всем периодам"})]})]}),l&&t.jsxs("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",t.jsx("span",{className:"font-semibold",children:i||d||`#${e}`}),". Режим только чтение."]}),t.jsxs("section",{className:"relative z-10 grid gap-6 lg:grid-cols-[1.1fr_0.9fr] lg:items-start animate-reveal",style:Wt(120),children:[F&&t.jsx("div",{className:"col-span-full rounded-lg border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),L&&t.jsx("div",{className:"col-span-full rounded-lg border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:L}),t.jsxs("div",{className:"order-2 grid gap-4 lg:order-none lg:self-start",children:[t.jsx(Ge,{periodId:c,type:"income",viewerId:e,disabled:x,children:t.jsx(ns,{items:h,setItems:y,totalAmount:Fe,onAdd:Rt,showDelete:$,onToggleDelete:()=>C(r=>!r),onBlurField:de,onAfterDelete:ze,invalidNameIds:ce,readOnly:xe,containerRef:Ie,addRowTargetRef:Qe,guidedIncomeId:Ae,guidedRowTargetRef:Re})}),t.jsx(Ge,{periodId:c,type:"mandatory",viewerId:e,disabled:x,children:t.jsx(ss,{title:"Обязательные траты",items:p,setItems:w,showDelete:$,onToggleDelete:()=>C(r=>!r),totalLabel:"Итого обязательных",totalPlanned:Oe,totalActual:jt,totalDifference:Me,idPrefix:"e",onBlurField:de,onAfterDelete:ze,readOnly:xe,containerRef:Ze})}),t.jsx(cs,{href:e?`/shared/${e}/periods/${c}/unforeseen`:x?`/onboarding/periods/${c}/unforeseen`:`/periods/${c}/unforeseen`,allocated:k,spent:Be}),t.jsx(Ge,{periodId:c,type:"external",viewerId:e,disabled:x,children:t.jsx(Ft,{title:"Сторонние траты",items:S,setItems:I,showDelete:$,onToggleDelete:()=>C(r=>!r),totalLabel:"Итого сторонних",totalAmount:kt,idPrefix:"o",onBlurField:de,onAfterDelete:ze,readOnly:xe,containerRef:We})})]}),t.jsxs("div",{className:"order-1 grid gap-4 lg:order-none lg:self-start",children:[t.jsx(os,{days:je,startDate:m,endDate:g,isEditing:H,readOnly:xe,onToggleEditing:()=>Q(r=>xe?r:!r),onStartDateChange:r=>{v(r),de(!1,{startDate:r})},onEndDateChange:r=>{b(r),de(!1,{endDate:r})},minStartDate:g?ot(g,-3):void 0,maxStartDate:g,minEndDate:m,maxEndDate:m?ot(m,3):void 0}),t.jsx(es,{href:e?`/shared/${e}/periods/${c}/daily`:x?`/onboarding/periods/${c}/daily`:`/periods/${c}/daily`}),t.jsx(ls,{dailyAverage:Nt,days:je,totalIncome:Fe,totalPlannedExpenses:Oe,totalUnforeseenAllocated:k,plannedPeriodSum:et}),t.jsx(ds,{actualRemaining:tt,remainingDays:St,remainingDailyAverage:$t}),t.jsx(ts,{plannedPeriodSum:et,totalDifference:Me,totalDailyExpenses:Le,unforeseenOverrun:Dt,actualRemaining:tt,unforeseenRemaining:wt,dailyActualAverage:_t})]})]}),ie&&t.jsx(Yt,{currentTitle:pt,onCancel:()=>te(!1),onConfirm:()=>st(!0),confirmDisabled:fe}),ft&&t.jsx(Xt,{onCancel:()=>Se(!1),onConfirm:Tt,confirmDisabled:z}),ut&&t.jsx(Qt,{onClose:()=>ye(!1),onReload:()=>window.location.reload()}),!l&&K&&t.jsx(Ht,{href:x?`/onboarding/periods/${K.id}`:`/periods/${K.id}`,title:`${he(K.start_date)} — ${he(K.end_date)}`,subtitle:`${it(K.start_date,K.end_date)} дней · ${dt(K.start_date,K.end_date)}`,onClose:()=>{ae(null),U(!1),_e.current=null},onConfirm:()=>de(!0,_e.current??void 0),confirmDisabled:!V||X}),W&&t.jsx("div",{className:"relative z-10 rounded-lg border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:W})]}),x&&!l&&t.jsx(Gt,{open:Ce,steps:At,refreshKey:`${h.length}:${p.length}`,onClose:()=>{zt(),ht(!1)}})]})}export{As as default};
