import{u as K,r as d,j as a,H as W,L as H}from"./app-DiBp4JLJ.js";import{A as q}from"./app-layout-By0QSF5T.js";import{d as J}from"./index-BDqSilVs.js";/* empty css            */import"./app-logo-icon-DcioA8SY.js";import"./index-DE4KSncy.js";import"./index-BmpTmqID.js";const V=t=>({"--delay":`${t}ms`}),X={id:0,startDate:"",endDate:"",dailyExpenses:{},isClosed:!1},B=t=>`${Math.max(0,Math.round(t)).toLocaleString("ru-RU")} ₽`,m=t=>{const[e,r,s]=t.split("-").map(Number);return new Date(e,(r??1)-1,s??1)},O=t=>{const e=m(t),r=String(e.getDate()).padStart(2,"0"),s=String(e.getMonth()+1).padStart(2,"0");return`${r}.${s}`},G=t=>new Intl.DateTimeFormat("ru-RU",{month:"long",year:"numeric"}).format(m(t)),Q=(t,e)=>{const r=new Intl.DateTimeFormat("ru-RU",{month:"short"}),s=r.format(m(t)),i=r.format(m(e)),c=m(t).getFullYear(),x=m(e).getFullYear();return c===x?s===i?G(t):`${s}–${i} ${c}`:`${s} ${c} – ${i} ${x}`},Z=(t,e)=>{const r=m(t),i=m(e).getTime()-r.getTime(),c=Math.floor(i/(1e3*60*60*24));return Math.max(1,c+1)},ee=t=>{const e=t.replace(/\D/g,"");return e===""?"":Number(e)},N=t=>{const e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${r}-${s}`},te=t=>{const e=["Пн","Вт","Ср","Чт","Пт","Сб","Вс"],r=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),i=(t.getDay()+6)%7;return`${e[i]}, ${r}.${s}`},E=(t,e)=>{const r=new Date(t);return r.setDate(r.getDate()+e),r},ae=(t,e)=>{const r=m(t),s=m(e),i=[];let c=new Date(r);for(;c<=s;){const x=[],b=(7-c.getDay())%7,f=Math.floor((s.getTime()-c.getTime())/(1e3*60*60*24)),g=E(c,Math.min(b,f));let p=new Date(c);for(;p<=g;)x.push(new Date(p)),p=E(p,1);i.push(x),c=E(g,1)}return i};function me(){const{periodId:t}=K().props,[e,r]=d.useState(X),[s,i]=d.useState({}),[c,x]=d.useState(!0),[k,b]=d.useState(null),[f,g]=d.useState(!1),[p,M]=d.useState(null),[se,C]=d.useState(!1),v=d.useRef(!1),j=d.useMemo(()=>`period:${t}`,[t]),S=d.useRef(!1),P=()=>typeof window>"u"?null:window.__periodCache?.[j]??null,T=n=>{if(typeof window>"u")return;const o=window;o.__periodCache||(o.__periodCache={}),o.__periodCache[j]={...o.__periodCache[j]??{},...n}},R=d.useMemo(()=>Z(e.startDate,e.endDate),[e.startDate,e.endDate]),_=d.useMemo(()=>!e.startDate||!e.endDate?"Период":`${O(e.startDate)} — ${O(e.endDate)}`,[e.startDate,e.endDate]),Y=d.useMemo(()=>!e.startDate||!e.endDate?"":`${R} дней · ${Q(e.startDate,e.endDate)}`,[R,e.startDate,e.endDate]),I=d.useMemo(()=>!e.startDate||!e.endDate?[]:ae(e.startDate,e.endDate),[e.startDate,e.endDate]),A=[{title:"Dashboard",href:J().url},{title:_,href:`/periods/${t}`},{title:"Ежедневные траты",href:`/periods/${t}/daily`}],U=async()=>{if(S.current)return;const n=P();if(n&&n.id){S.current=!0,r({...n,isClosed:!!n.isClosed}),i(n.dailyExpenses??{}),x(!1);return}S.current=!0,x(!0),b(null);try{const o=await fetch(`/api/periods/${t}`);if(!o.ok)throw new Error("Не удалось загрузить период.");const l=(await o.json()).data;r({id:l.id,startDate:l.start_date,endDate:l.end_date,dailyExpenses:l.daily_expenses??{},isClosed:!!l.is_closed}),i(l.daily_expenses??{}),T({id:l.id,startDate:l.start_date,endDate:l.end_date,dailyExpenses:l.daily_expenses??{},isClosed:!!l.is_closed})}catch(o){b(o instanceof Error?o.message:"Не удалось загрузить период.")}finally{x(!1)}},L=async()=>{if(!e.isClosed){if(f){v.current=!0;return}g(!0),M(null),C(!1);try{const n=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",o=await fetch(`/api/periods/${t}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n},body:JSON.stringify({daily_expenses:s})});if(!o.ok){if(o.status===423){const y=await o.json();throw new Error(y.message??"Период закрыт и не редактируется.")}throw new Error("Не удалось сохранить ежедневные траты.")}C(!0),T({id:e.id,startDate:e.startDate,endDate:e.endDate,dailyExpenses:s,isClosed:e.isClosed})}catch(n){M(n instanceof Error?n.message:"Не удалось сохранить ежедневные траты.")}finally{g(!1)}}};return d.useEffect(()=>{U()},[t]),d.useEffect(()=>{!f&&v.current&&(v.current=!1,L())},[f]),a.jsxs(q,{breadcrumbs:A,hideBreadcrumbsOnMobile:!0,children:[a.jsx(W,{title:`Ежедневные траты · ${_}`}),a.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[a.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),a.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),a.jsxs("section",{className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Ежедневные траты"}),a.jsx("h1",{className:"mt-3 font-display text-3xl",children:_}),a.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:Y})]}),a.jsx(H,{href:`/periods/${t}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),a.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:V(120),children:[c&&a.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),k&&a.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:k}),a.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3 max-sm:snap-y max-sm:snap-mandatory max-sm:overflow-y-auto max-sm:max-h-[calc(100vh-190px)] max-sm:pb-8 max-sm:pr-1",children:I.map((n,o)=>{const y=o===I.length-1,l=n.reduce((h,u)=>h+(s[N(u)]||0),0),F=n.filter(h=>s[N(h)]!==void 0).length,z=F>0?l/F:0;return a.jsx("div",{className:`rounded-2xl border border-black/10 bg-white/80 p-4 text-sm shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 max-sm:min-h-[calc(100vh-315px)] max-sm:snap-start max-sm:mb-2 max-sm:p-3 ${y?"max-sm:mb-24":""}`,children:a.jsxs("div",{className:"flex h-full flex-col gap-4",children:[a.jsx("div",{className:"flex-1",children:a.jsx("div",{className:"grid gap-3 max-sm:gap-2",children:n.map(h=>{const u=N(h);return a.jsxs("div",{className:"grid gap-2 max-sm:flex max-sm:items-center max-sm:justify-between",children:[a.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:te(h)}),a.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:s[u]??"",disabled:e.isClosed,onChange:w=>i(D=>{const $={...D};return w.target.value===""?delete $[u]:$[u]=ee(w.target.value)||0,$}),onFocus:()=>{s[u]===0&&i(w=>{const D={...w};return delete D[u],D})},onBlur:L,className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10 max-sm:w-[70%] max-sm:px-2 max-sm:py-2 max-sm:text-xs"})]},u)})})}),a.jsxs("div",{className:"mt-auto flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-dashed border-black/10 bg-white/70 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/5 max-sm:grid max-sm:grid-cols-[1fr_auto] max-sm:items-center max-sm:gap-y-1 max-sm:px-2 max-sm:py-2",children:[a.jsx("span",{children:"Итого за неделю"}),a.jsx("span",{className:"font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:B(l)}),a.jsx("span",{className:"text-[#6a5d52] dark:text-white/60",children:"Среднее в день"}),a.jsx("span",{className:"font-display text-sm tabular-nums",children:B(z)})]})]})},`${n[0]?.toISOString()??o}`)})})]}),p&&a.jsx("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:p})]})]})}export{me as default};
