import{u as te,r as t,j as e,H as ae,L as re}from"./app-DmI4XuDo.js";import{A as ne}from"./app-layout-CdnNduTw.js";import{d as ie}from"./index-D48w0u2P.js";import{B as D}from"./badge-jwJXkiv8.js";import{B as i}from"./app-logo-icon-Dlz4YmZK.js";import{D as T,a as L,g as k,e as O,f as B,b as A}from"./dialog-BpLude89.js";import{I as oe}from"./input-Dxvjfbea.js";import{L as le}from"./label-BBEZu75I.js";import{I as ce}from"./input-error-FoTQOMfJ.js";import{S as de}from"./session-expired-modal-sijsbWXR.js";/* empty css            */import"./index-CqMOdGhm.js";import"./index-4SCCvfrP.js";const me=[{title:"Dashboard",href:ie().url},{title:"Sharing",href:"/sharing"}],M={active:"Активен",blocked:"Заблокирован"},F=l=>l==="blocked"?"destructive":"secondary";function Ee(){const{auth:l}=te().props,[v,d]=t.useState([]),[R,w]=t.useState(!0),[y,m]=t.useState(null),[$,h]=t.useState(!1),[f,p]=t.useState(""),[H,c]=t.useState(null),[q,g]=t.useState(!1),[z,S]=t.useState(!1),[o,u]=t.useState(null),[K,N]=t.useState(!1),[P,b]=t.useState({}),[X,x]=t.useState(!1),[E,_]=t.useState([]),[I,C]=t.useState(null),J=t.useMemo(()=>l?.user?.name?`Кому открыт доступ от ${l.user.name}`:"Кому открыт доступ",[l?.user?.name]),U=async()=>{w(!0),m(null);try{const s=await fetch("/api/viewers");if(!s.ok)throw new Error("Не удалось загрузить список доступов.");const a=await s.json();d(a.data??[])}catch(s){m(s instanceof Error?s.message:"Не удалось загрузить список доступов.")}finally{w(!1)}},V=async()=>{C(null);try{const s=await fetch("/api/viewers/shared-with-me");if(!s.ok)throw new Error("Не удалось загрузить доступы для просмотра.");const a=await s.json();_(a.data??[])}catch(s){C(s instanceof Error?s.message:"Не удалось загрузить доступы для просмотра.")}};t.useEffect(()=>{U(),V()},[]);const G=()=>{p(""),c(null),g(!1)},Q=()=>{G(),h(!0)},W=()=>{h(!1)},Y=async()=>{if(!f.trim()){c("Введите почту пользователя.");return}c(null),g(!1),S(!0);try{const s=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",a=await fetch("/api/viewers",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":s},body:JSON.stringify({email:f.trim()})});if(a.status===419){x(!0);return}if(!a.ok){const n=await a.json();c(n?.message??"Не удалось отправить приглашение.");return}const r=await a.json();d(n=>[r.data,...n]),g(!0),p("")}catch(s){c(s instanceof Error?s.message:"Не удалось отправить приглашение.")}finally{S(!1)}},Z=async s=>{b(r=>({...r,[s.id]:!0}));const a=s.status==="active"?"blocked":"active";try{const r=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",n=await fetch(`/api/viewers/${s.id}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":r},body:JSON.stringify({status:a})});if(n.status===419){x(!0);return}if(!n.ok)throw new Error("Не удалось обновить статус.");d(se=>se.map(j=>j.id===s.id?{...j,status:a}:j))}catch(r){m(r instanceof Error?r.message:"Не удалось обновить статус.")}finally{b(r=>({...r,[s.id]:!1}))}},ee=async()=>{if(o){N(!0);try{const s=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",a=await fetch(`/api/viewers/${o.id}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":s}});if(a.status===419){x(!0);return}if(!a.ok)throw new Error("Не удалось удалить доступ.");d(r=>r.filter(n=>n.id!==o.id)),u(null)}catch(s){m(s instanceof Error?s.message:"Не удалось удалить доступ.")}finally{N(!1)}}};return e.jsxs(ne,{breadcrumbs:me,children:[e.jsx(ae,{title:"Sharing"}),e.jsxs("div",{className:"mx-auto flex w-full max-w-5xl flex-col gap-6",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"font-display text-3xl",children:"Доступ к периодам"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:J})]}),e.jsx(i,{onClick:Q,children:"Добавить доступ"})]}),y&&e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:y}),e.jsx("div",{className:"rounded-2xl border bg-card/60 p-6",children:R?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Загрузка..."}):v.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Пока никому не выдан доступ."}):e.jsx("div",{className:"divide-y",children:v.map(s=>e.jsxs("div",{className:"flex flex-col gap-4 py-4 first:pt-0 last:pb-0 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s.viewer?.name||"Без имени"}),e.jsx(D,{variant:F(s.status),children:M[s.status]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.viewer?.email??"Пользователь недоступен"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>Z(s),disabled:!!P[s.id],children:s.status==="active"?"Заблокировать":"Разблокировать"}),e.jsx(i,{variant:"destructive",size:"sm",onClick:()=>u(s),children:"Удалить"})]})]},s.id))})}),e.jsxs("div",{className:"rounded-2xl border bg-card/60 p-6",children:[e.jsx("div",{className:"flex items-center justify-between gap-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"font-display text-2xl",children:"Доступы для просмотра"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Пользователи, которые дали вам доступ к своим периодам."})]})}),I&&e.jsx("div",{className:"mt-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:I}),e.jsx("div",{className:"mt-4",children:E.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Пока нет доступов для просмотра."}):e.jsx("div",{className:"divide-y",children:E.map(s=>e.jsxs("div",{className:"flex flex-col gap-4 py-4 first:pt-0 last:pb-0 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s.user?.name||"Без имени"}),e.jsx(D,{variant:F(s.status),children:M[s.status]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.user?.email??"Пользователь недоступен"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(i,{variant:"outline",size:"sm",asChild:!0,children:e.jsx(re,{href:`/shared/${s.user_id}`,children:"Посмотреть периоды"})})})]},s.id))})})]})]}),e.jsx(T,{open:$,onOpenChange:h,children:e.jsxs(L,{children:[e.jsxs(k,{children:[e.jsx(O,{children:"Добавить доступ"}),e.jsx(B,{children:"Укажите почту пользователя, которому хотите открыть доступ к своим периодам."})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(le,{htmlFor:"invite-email",children:"Почта"}),e.jsx(oe,{id:"invite-email",type:"email",placeholder:"user@email.com",value:f,onChange:s=>p(s.target.value)}),e.jsx(ce,{message:H??void 0}),q&&e.jsx("p",{className:"text-sm text-green-600",children:"Приглашение отправлено."})]}),e.jsxs(A,{children:[e.jsx(i,{variant:"ghost",onClick:W,children:"Отмена"}),e.jsx(i,{onClick:Y,disabled:z,children:"Отправить приглашение"})]})]})}),e.jsx(T,{open:!!o,onOpenChange:s=>{s||u(null)},children:e.jsxs(L,{children:[e.jsxs(k,{children:[e.jsx(O,{children:"Удалить доступ?"}),e.jsx(B,{children:o?.viewer?.email?`Удалить доступ для ${o.viewer.email}?`:"Удалить доступ для этого пользователя?"})]}),e.jsxs(A,{children:[e.jsx(i,{variant:"ghost",onClick:()=>u(null),children:"Отмена"}),e.jsx(i,{variant:"destructive",onClick:ee,disabled:K,children:"Удалить"})]})]})}),X&&e.jsx(de,{onClose:()=>x(!1),onReload:()=>window.location.reload()})]})}export{Ee as default};
