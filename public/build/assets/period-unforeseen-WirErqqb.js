import{u as ae,r,j as t,H as se,L as re}from"./app-Co2WJCTd.js";import{B as ne,a as oe,E as ie,O as de}from"./off-income-block-DI074XIm.js";import{P as E}from"./pill-button-BF9KXfli.js";import{A as le}from"./app-layout-BWJR1pMz.js";import{d as ce}from"./animation-DULAtfne.js";import{c as ue,b as z,f as fe}from"./date-C0FYGyP5.js";import{b as xe,a as pe,d as F,t as me}from"./period-calculations-BXSzTPPy.js";/* empty css            */import"./app-logo-icon-BIJslR1r.js";import"./index-ap9OcSvD.js";import"./index-DPEoTood.js";import"./index-D48w0u2P.js";const he={id:0,startDate:"",endDate:"",unforeseenAllocated:0,unforeseenExpenses:[],isClosed:!1};function Ae(){const{periodId:l,viewerId:i,viewerName:U,viewerEmail:H,viewerMode:q}=ae().props,A=!!(i??q),[a,S]=r.useState(he),[c,y]=r.useState(0),[x,k]=r.useState([]),[K,V]=r.useState(!1),[$,v]=r.useState(!0),[D,P]=r.useState(null),[u,p]=r.useState(!1),[T,m]=r.useState(null),[B,J]=r.useState(0),[Q,j]=r.useState(!1),h=r.useRef(!1),_=r.useMemo(()=>`period:${i??"self"}:${l}`,[l,i]),w=r.useMemo(()=>i?`viewer_id=${i}`:"",[i]),b=r.useRef(!1),X=()=>typeof window>"u"?null:window.__periodCache?.[_]??null,I=e=>{if(typeof window>"u")return;const s=window;s.__periodCache||(s.__periodCache={});const o=e.unforeseenExpenses.map(n=>({id:n.id,name:n.name,plannedAmount:0,actualAmount:n.amount,actualTouched:!0}));s.__periodCache[_]={...s.__periodCache[_]??{},id:e.id,startDate:e.startDate,endDate:e.endDate,unforeseenAllocated:e.unforeseenAllocated,unforeseenExpenses:o,isClosed:e.isClosed}},Z=xe(x??[]),L=r.useMemo(()=>ue(a.startDate,a.endDate),[a.startDate,a.endDate]),M=r.useMemo(()=>!a.startDate||!a.endDate?"Период":`${z(a.startDate)} — ${z(a.endDate)}`,[a.startDate,a.endDate]),G=r.useMemo(()=>!a.startDate||!a.endDate?"":`${L} дней · ${fe(a.startDate,a.endDate)}`,[L,a.startDate,a.endDate]),f=a.isClosed||A,R=async(e=c,s=x)=>{const o=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",n=await fetch(`/api/periods/${l}${w?`?${w}`:""}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({unforeseen_allocated:e,unforeseen_expenses:s.filter(d=>d.name.trim()!=="").map(d=>({id:Number.isFinite(Number(d.id))?Number(d.id):void 0,name:d.name,planned_amount:0,actual_amount:F(d.amount)}))})});if(!n.ok){if(n.status===423){const d=await n.json();throw new Error(d.message??"Период закрыт и не редактируется.")}throw new Error("Не удалось сохранить непредвиденные траты.")}I({id:a.id,startDate:a.startDate,endDate:a.endDate,unforeseenAllocated:e,unforeseenExpenses:s,isClosed:a.isClosed})},W=async()=>{if(b.current)return;const e=X();if(e&&e.id&&Array.isArray(e.unforeseenExpenses)&&typeof e.unforeseenAllocated=="number"){b.current=!0;const s=e.unforeseenExpenses.map(o=>({id:o.id,name:o.name,amount:F(o.actualAmount)}));if(S({id:e.id,startDate:e.startDate??"",endDate:e.endDate??"",unforeseenAllocated:e.unforeseenAllocated??0,unforeseenExpenses:s,isClosed:!!e.isClosed}),y(e.unforeseenAllocated??0),k(s),v(!1),typeof navigator<"u"&&!navigator.onLine)return}b.current=!0,v(!0),P(null);try{const s=await fetch(`/api/periods/${l}${w?`?${w}`:""}`);if(!s.ok)throw new Error("Не удалось загрузить период.");const n=(await s.json()).data,d=n.unforeseen_expenses.map(C=>({id:String(C.id),name:C.name,amount:C.actual_amount})),g={id:n.id,startDate:n.start_date,endDate:n.end_date,unforeseenAllocated:Number(n.unforeseen_allocated??0),unforeseenExpenses:d,isClosed:!!n.is_closed};S(g),y(g.unforeseenAllocated),k(g.unforeseenExpenses),I(g)}catch(s){P(s instanceof Error?s.message:"Не удалось загрузить период.")}finally{v(!1)}},N=async()=>{if(!f){if(u){h.current=!0;return}p(!0),m(null);try{await R()}catch(e){m(e instanceof Error?e.message:"Не удалось сохранить непредвиденные траты.")}finally{p(!1)}}},O=async()=>{if(f)return;const e=window.prompt("Введите сумму, которую хотите выделить на непредвиденные расходы:",String(c));if(e===null)return;const s=me(e),o=s===""?0:s;if(y(o),u){h.current=!0;return}p(!0),m(null);try{await R(o,x)}catch(n){m(n instanceof Error?n.message:"Не удалось сохранить выделенную сумму.")}finally{p(!1)}},Y=()=>{if(f)return;const e=new Date;e.setHours(0,0,0,0);const s=a.startDate?new Date(`${a.startDate}T00:00:00`):null;if(c>0&&s instanceof Date&&Number.isFinite(s.getTime())&&e>s){j(!0);return}O()},ee=async()=>{j(!1),await O()},te=()=>{J(e=>e+1)};return r.useEffect(()=>{b.current=!1,W()},[l,i]),r.useEffect(()=>{!u&&h.current&&(h.current=!1,N())},[u]),r.useEffect(()=>{B>0&&N()},[B]),t.jsxs(le,{children:[t.jsx(se,{title:`Непредвиденные расходы · ${M}`}),t.jsxs("div",{className:"relative flex flex-1 flex-col gap-6 overflow-x-hidden rounded-xl p-3 font-body text-[#1c1a17] dark:text-[#f7f3ee] sm:gap-8 sm:p-6",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsxs("section",{className:"relative z-10 mx-auto flex w-full max-w-3xl flex-wrap items-center justify-between gap-4 sm:gap-6",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Непредвиденные расходы"}),t.jsx("h1",{className:"mt-3 font-display text-2xl sm:text-3xl",children:M}),t.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:G})]}),t.jsx(re,{href:i?`/shared/${i}/periods/${l}`:`/periods/${l}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),A&&t.jsxs("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",t.jsx("span",{className:"font-semibold",children:U||H||`#${i}`}),". Режим только чтение."]}),t.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:ce(120),children:[$&&t.jsx("div",{className:"mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),D&&t.jsx("div",{className:"mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:D}),!$&&!D&&t.jsxs("div",{className:"mx-auto grid w-full max-w-3xl min-w-0 gap-4",children:[t.jsxs("div",{className:"rounded-lg border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsx(ne,{children:"План на непредвиденные"}),t.jsx(E,{type:"button",onClick:Y,disabled:f,children:"Изменить"})]}),t.jsx(oe,{className:`mt-3 ${c>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":"text-[#6a5d52] dark:text-white/60"}`,children:c>0?pe(c):"0"})]}),t.jsx(ie,{periodId:l,type:"unforeseen",viewerId:i,children:t.jsx(de,{title:"Непредвиденные расходы",items:x,setItems:k,showDelete:K,onToggleDelete:()=>V(e=>!e),totalLabel:"Итого потрачено",totalAmount:Z,idPrefix:"u",onBlurField:N,onAfterDelete:te,readOnly:f})})]})]}),T&&t.jsx("div",{className:"relative z-10 mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:T}),Q&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6",children:t.jsxs("div",{className:"w-full max-w-xl rounded-lg border border-black/10 bg-white/95 p-6 text-[#1c1a17] shadow-[0_24px_60px_-28px_rgba(0,0,0,0.7)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white",children:[t.jsx("h3",{className:"font-display text-2xl",children:"Подтвердить изменение?"}),t.jsx("p",{className:"mt-3 text-sm text-[#6a5d52] dark:text-white/70",children:"Эта цифра уже запланирована на текущий период. Вы уверены, что хотите поменять? Данное действие повлияет на все цифры."}),t.jsxs("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:[t.jsx(E,{type:"button",onClick:()=>{j(!1)},className:"px-4 py-2",children:"Отмена"}),t.jsx(E,{type:"button",onClick:ee,tone:"success",className:"px-4 py-2",disabled:u,children:"Подтвердить"})]})]})})]})]})}export{Ae as default};
