import{u as K,r as o,j as a,H as W,L as H}from"./app-CejraSsK.js";import{A as q}from"./app-layout-DlfsBc8O.js";import{d as J}from"./index-BDqSilVs.js";/* empty css            */import"./app-logo-icon-D92xeSNN.js";import"./index-v4dAW1_0.js";import"./index-BR22Mtl-.js";const V=t=>({"--delay":`${t}ms`}),X={id:0,startDate:"",endDate:"",dailyExpenses:{}},O=t=>`${Math.max(0,Math.round(t)).toLocaleString("ru-RU")} ₽`,m=t=>{const[e,s,r]=t.split("-").map(Number);return new Date(e,(s??1)-1,r??1)},P=t=>{const e=m(t),s=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0");return`${s}.${r}`},G=t=>new Intl.DateTimeFormat("ru-RU",{month:"long",year:"numeric"}).format(m(t)),Q=(t,e)=>{const s=new Intl.DateTimeFormat("ru-RU",{month:"short"}),r=s.format(m(t)),d=s.format(m(e)),i=m(t).getFullYear(),x=m(e).getFullYear();return i===x?r===d?G(t):`${r}–${d} ${i}`:`${r} ${i} – ${d} ${x}`},Z=(t,e)=>{const s=m(t),d=m(e).getTime()-s.getTime(),i=Math.floor(d/(1e3*60*60*24));return Math.max(1,i+1)},ee=t=>{const e=t.replace(/\D/g,"");return e===""?"":Number(e)},$=t=>{const e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${s}-${r}`},te=t=>{const e=["Пн","Вт","Ср","Чт","Пт","Сб","Вс"],s=String(t.getDate()).padStart(2,"0"),r=String(t.getMonth()+1).padStart(2,"0"),d=(t.getDay()+6)%7;return`${e[d]}, ${s}.${r}`},N=(t,e)=>{const s=new Date(t);return s.setDate(s.getDate()+e),s},ae=(t,e)=>{const s=m(t),r=m(e),d=[];let i=new Date(s);for(;i<=r;){const x=[],b=(7-i.getDay())%7,f=Math.floor((r.getTime()-i.getTime())/(1e3*60*60*24)),g=N(i,Math.min(b,f));let p=new Date(i);for(;p<=g;)x.push(new Date(p)),p=N(p,1);d.push(x),i=N(g,1)}return d};function me(){const{periodId:t}=K().props,[e,s]=o.useState(X),[r,d]=o.useState({}),[i,x]=o.useState(!0),[D,b]=o.useState(null),[f,g]=o.useState(!1),[p,M]=o.useState(null),[re,E]=o.useState(!1),k=o.useRef(!1),v=o.useMemo(()=>`period:${t}`,[t]),S=o.useRef(!1),Y=()=>typeof window>"u"?null:window.__periodCache?.[v]??null,T=n=>{if(typeof window>"u")return;const c=window;c.__periodCache||(c.__periodCache={}),c.__periodCache[v]={...c.__periodCache[v]??{},...n}},C=o.useMemo(()=>Z(e.startDate,e.endDate),[e.startDate,e.endDate]),j=o.useMemo(()=>!e.startDate||!e.endDate?"Период":`${P(e.startDate)} — ${P(e.endDate)}`,[e.startDate,e.endDate]),A=o.useMemo(()=>!e.startDate||!e.endDate?"":`${C} дней · ${Q(e.startDate,e.endDate)}`,[C,e.startDate,e.endDate]),R=o.useMemo(()=>!e.startDate||!e.endDate?[]:ae(e.startDate,e.endDate),[e.startDate,e.endDate]),B=[{title:"Dashboard",href:J().url},{title:j,href:`/periods/${t}`},{title:"Ежедневные траты",href:`/periods/${t}/daily`}],U=async()=>{if(S.current)return;const n=Y();if(n&&n.id){S.current=!0,s(n),d(n.dailyExpenses??{}),x(!1);return}S.current=!0,x(!0),b(null);try{const c=await fetch(`/api/periods/${t}`);if(!c.ok)throw new Error("Не удалось загрузить период.");const l=(await c.json()).data;s({id:l.id,startDate:l.start_date,endDate:l.end_date,dailyExpenses:l.daily_expenses??{}}),d(l.daily_expenses??{}),T({id:l.id,startDate:l.start_date,endDate:l.end_date,dailyExpenses:l.daily_expenses??{}})}catch(c){b(c instanceof Error?c.message:"Не удалось загрузить период.")}finally{x(!1)}},I=async()=>{if(f){k.current=!0;return}g(!0),M(null),E(!1);try{const n=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"";if(!(await fetch(`/api/periods/${t}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n},body:JSON.stringify({daily_expenses:r})})).ok)throw new Error("Не удалось сохранить ежедневные траты.");E(!0),T({id:e.id,startDate:e.startDate,endDate:e.endDate,dailyExpenses:r})}catch(n){M(n instanceof Error?n.message:"Не удалось сохранить ежедневные траты.")}finally{g(!1)}};return o.useEffect(()=>{U()},[t]),o.useEffect(()=>{!f&&k.current&&(k.current=!1,I())},[f]),a.jsxs(q,{breadcrumbs:B,hideBreadcrumbsOnMobile:!0,children:[a.jsx(W,{title:`Ежедневные траты · ${j}`}),a.jsxs("div",{className:"relative flex flex-1 flex-col gap-8 overflow-x-hidden rounded-xl p-6 font-body text-[#1c1a17] dark:text-[#f7f3ee]",children:[a.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),a.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),a.jsxs("section",{className:"relative z-10 flex flex-wrap items-center justify-between gap-6",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Ежедневные траты"}),a.jsx("h1",{className:"mt-3 font-display text-3xl",children:j}),a.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:A})]}),a.jsx(H,{href:`/periods/${t}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),a.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:V(120),children:[i&&a.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),D&&a.jsx("div",{className:"rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:D}),a.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3 max-sm:snap-y max-sm:snap-mandatory max-sm:overflow-y-auto max-sm:max-h-[calc(100vh-190px)] max-sm:pb-8 max-sm:pr-1",children:R.map((n,c)=>{const L=c===R.length-1,l=n.reduce((h,u)=>h+(r[$(u)]||0),0),F=n.filter(h=>r[$(h)]!==void 0).length,z=F>0?l/F:0;return a.jsx("div",{className:`rounded-2xl border border-black/10 bg-white/80 p-4 text-sm shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 max-sm:min-h-[calc(100vh-315px)] max-sm:snap-start max-sm:mb-2 max-sm:p-3 ${L?"max-sm:mb-24":""}`,children:a.jsxs("div",{className:"flex h-full flex-col gap-4",children:[a.jsx("div",{className:"flex-1",children:a.jsx("div",{className:"grid gap-3 max-sm:gap-2",children:n.map(h=>{const u=$(h);return a.jsxs("div",{className:"grid gap-2 max-sm:flex max-sm:items-center max-sm:justify-between",children:[a.jsx("span",{className:"text-xs text-[#6a5d52] dark:text-white/60",children:te(h)}),a.jsx("input",{type:"number",min:0,step:1,inputMode:"numeric",value:r[u]??"",onChange:y=>d(w=>{const _={...w};return y.target.value===""?delete _[u]:_[u]=ee(y.target.value)||0,_}),onFocus:()=>{r[u]===0&&d(y=>{const w={...y};return delete w[u],w})},onBlur:I,className:"no-spin rounded-2xl border border-black/10 bg-white/90 px-3 py-2 text-sm text-right tabular-nums dark:border-white/10 dark:bg-white/10 max-sm:w-[70%] max-sm:px-2 max-sm:py-2 max-sm:text-xs"})]},u)})})}),a.jsxs("div",{className:"mt-auto flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-dashed border-black/10 bg-white/70 px-3 py-2 text-xs dark:border-white/10 dark:bg-white/5 max-sm:grid max-sm:grid-cols-[1fr_auto] max-sm:items-center max-sm:gap-y-1 max-sm:px-2 max-sm:py-2",children:[a.jsx("span",{children:"Итого за неделю"}),a.jsx("span",{className:"font-display text-sm tabular-nums text-[#b0352b] dark:text-[#ff8b7c]",children:O(l)}),a.jsx("span",{className:"text-[#6a5d52] dark:text-white/60",children:"Среднее в день"}),a.jsx("span",{className:"font-display text-sm tabular-nums",children:O(z)})]})]})},`${n[0]?.toISOString()??c}`)})})]}),p&&a.jsx("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:p})]})]})}export{me as default};
