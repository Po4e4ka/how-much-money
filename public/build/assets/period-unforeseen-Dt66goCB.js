import{u as re,r as n,j as t,H as ne,L as oe,a as de}from"./app-Cs7KdXzy.js";import{B as ie,a as le,E as ce,O as ue}from"./off-income-block-D3cJ_bD1.js";import{O as xe}from"./onboarding-demo-banner-DrbOwn4Z.js";import{P as A}from"./pill-button-CyPVsLSI.js";import{A as fe}from"./app-layout-Ce4sc7ax.js";import{d as pe}from"./animation-DULAtfne.js";import{c as me,b as z,f as he}from"./date-C0FYGyP5.js";import{b as be,a as we,d as U,o as ge,t as ye}from"./period-calculations-ClI-_2h0.js";/* empty css            */import"./createLucideIcon-l5W18Rcb.js";import"./index-BNdu6nsP.js";import"./index-mGBfCi1u.js";import"./index-CfZs0pIN.js";import"./app-logo-icon-C7ZpM3Vh.js";const ve={id:0,startDate:"",endDate:"",unforeseenAllocated:0,unforeseenExpenses:[],isClosed:!1};function Oe(){const{periodId:d,viewerId:o,viewerName:H,viewerEmail:q,viewerMode:V,onboardingMode:J}=re().props,S=!!(o??V),l=!!J,E=l?ge:de,[a,$]=n.useState(ve),[c,y]=n.useState(0),[f,v]=n.useState([]),[K,Q]=n.useState(!1),[P,k]=n.useState(!0),[D,B]=n.useState(null),[u,p]=n.useState(!1),[T,m]=n.useState(null),[M,Z]=n.useState(0),[G,j]=n.useState(!1),h=n.useRef(!1),_=n.useMemo(()=>`period:${o??"self"}:${d}`,[d,o]),b=n.useMemo(()=>o?`viewer_id=${o}`:"",[o]),w=n.useRef(!1),W=()=>typeof window>"u"?null:window.__periodCache?.[_]??null,O=e=>{if(typeof window>"u")return;const r=window;r.__periodCache||(r.__periodCache={});const s=e.unforeseenExpenses.map(i=>({id:i.id,name:i.name,plannedAmount:0,actualAmount:i.amount,actualTouched:!0}));r.__periodCache[_]={...r.__periodCache[_]??{},id:e.id,startDate:e.startDate,endDate:e.endDate,unforeseenAllocated:e.unforeseenAllocated,unforeseenExpenses:s,isClosed:e.isClosed}},X=be(f??[]),I=n.useMemo(()=>me(a.startDate,a.endDate),[a.startDate,a.endDate]),L=n.useMemo(()=>!a.startDate||!a.endDate?"Период":`${z(a.startDate)} — ${z(a.endDate)}`,[a.startDate,a.endDate]),Y=n.useMemo(()=>!a.startDate||!a.endDate?"":`${I} дней · ${he(a.startDate,a.endDate)}`,[I,a.startDate,a.endDate]),x=a.isClosed||S,F=async(e=c,r=f)=>{await E(`/api/periods/${d}${b?`?${b}`:""}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({unforeseen_allocated:e,unforeseen_expenses:r.filter(s=>s.name.trim()!=="").map(s=>({id:Number.isFinite(Number(s.id))?Number(s.id):void 0,name:s.name,planned_amount:0,actual_amount:U(s.amount)}))})}),O({id:a.id,startDate:a.startDate,endDate:a.endDate,unforeseenAllocated:e,unforeseenExpenses:r,isClosed:a.isClosed})},ee=async()=>{if(w.current)return;const e=W();if(e&&e.id&&Array.isArray(e.unforeseenExpenses)&&typeof e.unforeseenAllocated=="number"){w.current=!0;const r=e.unforeseenExpenses.map(s=>({id:s.id,name:s.name,amount:U(s.actualAmount)}));if($({id:e.id,startDate:e.startDate??"",endDate:e.endDate??"",unforeseenAllocated:e.unforeseenAllocated??0,unforeseenExpenses:r,isClosed:!!e.isClosed}),y(e.unforeseenAllocated??0),v(r),k(!1),typeof navigator<"u"&&!navigator.onLine)return}w.current=!0,k(!0),B(null);try{const s=(await E(`/api/periods/${d}${b?`?${b}`:""}`)).data,i=s.unforeseen_expenses.map(C=>({id:String(C.id),name:C.name,amount:C.actual_amount})),g={id:s.id,startDate:s.start_date,endDate:s.end_date,unforeseenAllocated:Number(s.unforeseen_allocated??0),unforeseenExpenses:i,isClosed:!!s.is_closed};$(g),y(g.unforeseenAllocated),v(g.unforeseenExpenses),O(g)}catch(r){B(r instanceof Error?r.message:"Не удалось загрузить период.")}finally{k(!1)}},N=async()=>{if(!x){if(u){h.current=!0;return}p(!0),m(null);try{await F()}catch(e){m(e instanceof Error?e.message:"Не удалось сохранить непредвиденные траты.")}finally{p(!1)}}},R=async()=>{if(x)return;const e=window.prompt("Введите сумму, которую хотите выделить на непредвиденные расходы:",String(c));if(e===null)return;const r=ye(e),s=r===""?0:r;if(y(s),u){h.current=!0;return}p(!0),m(null);try{await F(s,f)}catch(i){m(i instanceof Error?i.message:"Не удалось сохранить выделенную сумму.")}finally{p(!1)}},te=()=>{if(x)return;const e=new Date;e.setHours(0,0,0,0);const r=a.startDate?new Date(`${a.startDate}T00:00:00`):null;if(c>0&&r instanceof Date&&Number.isFinite(r.getTime())&&e>r){j(!0);return}R()},ae=async()=>{j(!1),await R()},se=()=>{Z(e=>e+1)};return n.useEffect(()=>{w.current=!1,ee()},[d,o]),n.useEffect(()=>{!u&&h.current&&(h.current=!1,N())},[u]),n.useEffect(()=>{M>0&&N()},[M]),t.jsxs(fe,{hideHeader:l,children:[t.jsx(ne,{title:`Непредвиденные расходы · ${L}`}),l&&t.jsx(xe,{}),t.jsxs("div",{className:`relative flex flex-1 flex-col gap-6 overflow-x-hidden rounded-xl p-3 font-body text-[#1c1a17] dark:text-[#f7f3ee] sm:gap-8 sm:p-6 ${l?"pt-16":""}`,children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-3xl bg-aurora opacity-35 dark:hidden"}),t.jsx("div",{className:"pointer-events-none absolute inset-0 hidden rounded-3xl bg-aurora-night opacity-45 dark:block"}),t.jsxs("section",{className:"relative z-10 mx-auto flex w-full max-w-3xl flex-wrap items-center justify-between gap-4 sm:gap-6",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[#6a5d52] dark:text-white/60",children:"Непредвиденные расходы"}),t.jsx("h1",{className:"mt-3 font-display text-2xl sm:text-3xl",children:L}),t.jsx("p",{className:"mt-2 text-sm text-[#6a5d52] dark:text-white/70",children:Y})]}),t.jsx(oe,{href:o?`/shared/${o}/periods/${d}`:l?`/onboarding/periods/${d}`:`/periods/${d}`,prefetch:!0,className:"rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs text-[#1c1a17] shadow-[0_16px_32px_-24px_rgba(28,26,23,0.6)] transition hover:-translate-y-0.5 dark:border-white/10 dark:bg-white/10 dark:text-white",children:"← К периоду"})]}),S&&t.jsxs("div",{className:"relative z-10 rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm text-[#1c1a17] shadow-[0_18px_36px_-26px_rgba(28,26,23,0.5)] dark:border-white/10 dark:bg-white/10 dark:text-white/80",children:["Просмотр периодов пользователя"," ",t.jsx("span",{className:"font-semibold",children:H||q||`#${o}`}),". Режим только чтение."]}),t.jsxs("section",{className:"relative z-10 grid gap-4 animate-reveal",style:pe(120),children:[P&&t.jsx("div",{className:"mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#6a5d52] dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:"Загружаем период..."}),D&&t.jsx("div",{className:"mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-4 text-sm text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:D}),!P&&!D&&t.jsxs("div",{className:"mx-auto grid w-full max-w-3xl min-w-0 gap-4",children:[t.jsxs("div",{className:"rounded-lg border border-black/10 bg-white/80 px-5 py-4 text-sm shadow-[0_20px_40px_-26px_rgba(28,26,23,0.6)] dark:border-white/10 dark:bg-white/10",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsx(ie,{children:"План на непредвиденные"}),t.jsx(A,{type:"button",onClick:te,disabled:x,children:"Изменить"})]}),t.jsx(le,{className:`mt-3 ${c>0?"text-[#1e7b4f] dark:text-[#7ce0b3]":"text-[#6a5d52] dark:text-white/60"}`,children:c>0?we(c):"0"})]}),t.jsx(ce,{periodId:d,type:"unforeseen",viewerId:o,disabled:l,children:t.jsx(ue,{title:"Непредвиденные расходы",items:f,setItems:v,showDelete:K,onToggleDelete:()=>Q(e=>!e),totalLabel:"Итого потрачено",totalAmount:X,idPrefix:"u",onBlurField:N,onAfterDelete:se,readOnly:x})})]})]}),T&&t.jsx("div",{className:"relative z-10 mx-auto w-full max-w-3xl rounded-2xl border border-black/10 bg-white/70 px-5 py-3 text-xs text-[#b0352b] dark:border-white/10 dark:bg-white/10 dark:text-[#ff8b7c]",children:T}),G&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6",children:t.jsxs("div",{className:"w-full max-w-xl rounded-lg border border-black/10 bg-white/95 p-6 text-[#1c1a17] shadow-[0_24px_60px_-28px_rgba(0,0,0,0.7)] dark:border-white/10 dark:bg-[#1c1a17] dark:text-white",children:[t.jsx("h3",{className:"font-display text-2xl",children:"Подтвердить изменение?"}),t.jsx("p",{className:"mt-3 text-sm text-[#6a5d52] dark:text-white/70",children:"Эта цифра уже запланирована на текущий период. Вы уверены, что хотите поменять? Данное действие повлияет на все цифры."}),t.jsxs("div",{className:"mt-6 flex flex-wrap justify-end gap-3",children:[t.jsx(A,{type:"button",onClick:()=>{j(!1)},className:"px-4 py-2",children:"Отмена"}),t.jsx(A,{type:"button",onClick:ae,tone:"success",className:"px-4 py-2",disabled:u,children:"Подтвердить"})]})]})})]})]})}export{Oe as default};
